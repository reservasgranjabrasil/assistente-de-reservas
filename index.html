<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistente de Reservas - Hotel Granja Brasil</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
        }

        body {
            background-color: #e5ddd5;
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 0;
            background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AkEEjIZzQJpLgAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAAJUlEQVQ4y2NgGAWjYBSMglEwCkbBKJhYwMjAwMDw//9/BqoBAG4FBGj6r1jZAAAAAElFTkSuQmCC");
        }

        .chat-container {
            background: #e5ddd5;
            border-radius: 0;
            box-shadow: none;
            width: 100%;
            max-width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: #075e54;
            color: white;
            padding: 10px 15px;
            text-align: left;
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hotel-logo {
            font-size: 16px;
            font-weight: 500;
            flex-grow: 1;
        }

        .hotel-subtitle {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 2px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #4ad504;
            border-radius: 50%;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #e5ddd5;
            -webkit-overflow-scrolling: touch;
            background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AkEEjIZzQJpLgAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAAJUlEQVQ4y2NgGAWjYBSMglEwCkbBKJhYwMjAwMDw//9/BqoBAG4FBGj6r1jZAAAAAElFTkSuQmCC");
        }

        .message {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
            animation: slideIn 0.3s ease;
            scroll-margin-top: 10px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .bot-avatar {
            background: #075e54;
        }

        .user-avatar {
            background: #128c7e;
        }

        .message-content {
            background: white;
            padding: 8px 12px;
            border-radius: 7.5px;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
            max-width: 85%;
            word-wrap: break-word;
            font-size: 15px;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: #dcf8c6;
            color: #000;
        }

        .typing-indicator {
            display: none;
            padding: 8px 12px;
            background: white;
            border-radius: 7.5px;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
            min-width: 100px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #999;
            border-radius: 50%;
            animation: typingPulse 1.4s ease-in-out infinite both;
        }

            .typing-dot:nth-child(1) {
                animation-delay: -0.32s;
            }

            .typing-dot:nth-child(2) {
                animation-delay: -0.16s;
            }

        @keyframes typingPulse {
            0%, 80%, 100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        .chat-input {
            padding: 8px;
            background: #f0f0f0;
            border-top: 1px solid #ddd;
            position: sticky;
            bottom: 0;
            z-index: 100;
        }

        .input-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            outline: none;
            font-size: 15px;
            background: white;
        }

        .send-button {
            width: 40px;
            height: 40px;
            background: #075e54;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            font-size: 16px;
        }

            .send-button:hover {
                background: #128c7e;
            }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 8px 0;
        }

        .quick-action {
            background: white;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 18px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

            .quick-action:hover {
                background: #f5f5f5;
            }

        .quote-button, .whatsapp-button, .corporate-button {
            border-radius: 18px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: background 0.3s;
            width: 100%;
            font-size: 15px;
            border: none;
        }

        .quote-button {
            background: #075e54;
            color: white;
        }

        .whatsapp-button {
            background: #25d366;
            color: white;
        }

        .corporate-button {
            background: #075e54;
            color: white;
        }

        .quote-form {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 8px 0;
            border: 1px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 12px;
        }

            .form-group label {
                display: block;
                margin-bottom: 4px;
                font-weight: 600;
                color: #2c3e50;
                font-size: 13px;
            }

            .form-group input, .form-group select {
                width: 100%;
                padding: 8px 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 13px;
            }

        .form-row {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

            .form-row .form-group {
                flex: 1;
            }

        .quote-result {
            background: #075e54;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 14px;
        }

        .loading {
            color: #075e54;
            text-align: center;
            margin: 10px 0;
            font-size: 14px;
            display: none;
        }

        .error-message {
            color: #e74c3c;
            text-align: center;
            margin: 10px 0;
            display: none;
            font-size: 14px;
        }

        .no-availability {
            color: #e67e22;
            text-align: center;
            margin: 10px 0;
            display: none;
            font-size: 14px;
            font-weight: 600;
        }

        .disabled-option {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .children-section {
            background: #f0f8ff;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border-left: 4px solid #3498db;
        }

            .children-section h4 {
                margin-bottom: 8px;
                color: #2c3e50;
            }

        .invalid-combination {
            color: #e74c3c;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        .accommodation-divider {
            margin: 15px 0;
            border: none;
            border-top: 1px dashed rgba(255,255,255,0.3);
        }

        /* Estilos para campos desabilitados */
        input:disabled, select:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Estilos para a sele√ß√£o de quartos com checkboxes */
        #roomsContainer {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
        }

            #roomsContainer label {
                cursor: pointer;
                user-select: none;
            }

            #roomsContainer input[type="checkbox"] {
                cursor: pointer;
                margin-right: 10px;
            }

            #roomsContainer div {
                display: flex;
                align-items: center;
                margin: 8px 0;
            }

        /* Estilos para respostas da IA */
        .ai-response {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #128c7e;
        }

        .ai-response ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .ai-response li {
            margin: 8px 0;
            padding-left: 5px;
            line-height: 1.5;
        }
        
        .ai-response strong {
            color: #075e54;
        }
        
        .ai-response a.phone-link {
            color: #075e54;
            text-decoration: none;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            background: #f0f8ff;
            transition: all 0.2s;
            display: inline-block;
            margin-left: 5px;
        }
        
        .ai-response a.phone-link:hover {
            background: #e1f5fe;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Estilo para mensagens divididas */
        .message-part {
            margin-bottom: 10px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Estilo para indicador de digita√ß√£o humana */
        .human-typing {
            font-style: italic;
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        @media (min-width: 768px) {
            body {
                align-items: center;
                padding: 20px;
            }

            .chat-container {
                border-radius: 8px;
                box-shadow: 0 6px 18px rgba(0,0,0,0.1);
                max-width: 675px;
                height: 80vh;
            }

            .chat-header {
                padding: 12px 15px;
            }

            .hotel-logo {
                font-size: 22px;
            }

            .hotel-subtitle {
                font-size: 14px;
            }

            .message-content {
                max-width: 70%;
                font-size: 16px;
                padding: 12px 16px;
            }

            .quick-action {
                font-size: 14px;
                padding: 8px 16px;
            }

            .quote-form {
                padding: 20px;
            }

            .form-group input,
            .form-group select {
                padding: 10px 12px;
                font-size: 15px;
            }

            .form-group label {
                font-size: 15px;
            }

            #roomType {
                font-size: 15px;
                padding: 10px;
            }

            .accommodation-divider {
                margin: 20px 0;
            }

            .quote-button,
            .whatsapp-button,
            .corporate-button {
                padding: 12px 20px;
                font-size: 16px;
            }

            .send-button {
                width: 48px;
                height: 48px;
                font-size: 20px;
            }

            .quote-result {
                padding: 20px;
            }

                .quote-result h3 {
                    font-size: 20px;
                }

                .quote-result h4 {
                    font-size: 22px;
                }

            .form-row {
                flex-direction: row;
                gap: 20px;
            }

                .form-row .form-group {
                    flex: 1;
                }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div>
                <div class="hotel-logo">Hotel Granja Brasil</div>
                <div class="hotel-subtitle">Assistente de Reservas Online</div>
            </div>
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span>Online</span>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <div class="message-avatar bot-avatar">ü§ñ</div>
                <div class="message-content">
                    <p>Ol√°! Bem-vindo ao <strong>Hotel Granja Brasil</strong>! üëã</p>
                    <p>Sou seu assistente virtual e estou aqui para ajud√°-lo com:</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>üè∑Ô∏è Or√ßamentos de reservas em tempo real</li>
                        <li>üìã Informa√ß√µes sobre acomoda√ß√µes</li>
                        <li>üåü Servi√ßos e facilidades</li>
                        <li>‚ùì Esclarecimento de d√∫vidas</li>
                        <li>üìç Informa√ß√µes sobre estabelecimentos locais</li>
                    </ul>
                    <p>Como posso ajud√°-lo hoje?</p>

                    <div class="quick-actions">
                        <button class="quick-action" data-action="solicitar-orcamento">üí∞ Solicitar Or√ßamento</button>
                        <button class="quick-action" data-action="informacoes-hotel">üè® Acomoda√ß√µes</button>
                        <button class="quick-action" data-action="servicos">üåü Servi√ßos e Lazer</button>
                        <button class="quick-action" data-action="politicas">üìã Pol√≠ticas</button>
                        <button class="quick-action" data-action="localizacao">üìç Localiza√ß√£o</button>
                        <button class="quick-action" data-action="contato">üìû Contato</button>
                    </div>

                    <button id="corporateBtn" class="corporate-button">
                        üè¢ Reservas Corporativas
                    </button>
                </div>
            </div>

            <div class="message bot typing-indicator" id="typingIndicator">
                <div class="message-avatar bot-avatar">ü§ñ</div>
                <div class="typing-indicator">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-input">
            <div class="input-container">
                <input type="text" id="messageInput" class="message-input" placeholder="Digite sua mensagem...">
                <button id="sendButton" class="send-button">
                    ‚û§
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√µes do hotel
        const HOTEL_CONFIG = {
            name: "Hotel Granja Brasil",
            whatsappNumber: "+5524998275427",
            emailCorporativo: "contato@reservasgranjabrasil.com.br",
            localizacao: "Condom√≠nio das Resid√™ncias do Pau Brasil - Estrada Uni√£o e Ind√∫stria, 9153 - Itaipava - Petr√≥polis, RJ",
            politicas: {
                cancelamento: "Altera√ß√µes ou cancelamentos sem custo at√© 48h antes do check-in",
                criancas: "Crian√ßas at√© 6 anos n√£o pagam, mas exigem su√≠tes com sof√°s-camas",
                hospedeExtra: "H√≥spedes extras: R$ 102/dia (sof√°s-camas)",
                animais: "Animais de estima√ß√£o n√£o s√£o permitidos",
                fumante: "100% n√£o fumante",
                atestatMedico: "Obrigat√≥rio para √°reas externas (sauna, academia, piscinas) - v√°lido por 6 meses"
            },
            servicos: [
                "Caf√© da Manh√£ (Buffet) Incluso",
                "Internet Wifi Gratuita",
                "Piscinas",
                "Quadras Poliesportivas, T√™nis e V√¥lei de Areia",
                "Academia e Sauna a Vapor",
                "Trilha Ecol√≥gica",
                "Parquinho Infantil",
                "Estacionamento Gratuito (coberto/descoberto)"
            ],
            horarios: {
                checkin: "14h √†s 19h",
                checkout: "12h",
                governanca: "7h √†s 22h",
                recepcao: "7h √†s 19h",
                piscina: "Quinta a domingo: 10h √†s 19h"
            },
            acomodacoes: [
                {
                    nome: "Apartamento Superior",
                    descricao: "Camas separadas (padr√£o vi√∫va) ‚Äì ideal para solteiros - 26 m¬≤ - Ar-condicionado - Frigobar - Secador de Cabelos - Mesa de Trabalho",
                    capacidade: 2
                },
                {
                    nome: "Su√≠te S√™nior",
                    descricao: "Conforto ampliado com sof√°-cama na sala - Cama de Casal King Size - 41 m¬≤ - Ar-condicionado - Frigobar - Microondas - Pia - Sacada - Secador de Cabelos - Mesa de Trabalho",
                    capacidade: 3
                },
                {
                    nome: "Su√≠te Master (Cobertura)",
                    descricao: "Cama King Size, sof√°-cama e vista privilegiada - 56 m¬≤ - Ar-condicionado - Frigobar - Microondas - Pia - Varanda - Acesso por escada (15 degraus) - Secador de Cabelos - Mesa de Trabalho",
                    capacidade: 3
                }
            ]
        };

        // Dados de minlos (estadia m√≠nima)
        const MINLOS_DATA = {
            // R√©veillon 2025
            "20/12/2025": 2,
            "27/12/2025": 2,
            "28/12/2025": 4,
            "29/12/2025": 4,
            "30/12/2025": 3,
            "31/12/2025": 3,
            "01/01/2026": 3,
            
            // Janeiro 2026
            "03/01/2026": 2,
            "10/01/2026": 2,
            "17/01/2026": 2,
            "18/01/2026": 2,
            "19/01/2026": 2,
            "20/01/2026": 2,
            "24/01/2026": 2,
            "31/01/2026": 2,
            
            // Fevereiro 2026
            "07/02/2026": 2,
            "13/02/2026": 3,
            "14/02/2026": 3,
            "15/02/2026": 3,
            "16/02/2026": 3,
            "17/02/2026": 3,
            "18/02/2026": 3,
                        
            // Mar√ßo 2026
            "07/03/2026": 2,
            "14/03/2026": 2,
            "21/03/2026": 2,
            "28/03/2026": 2,
            
            // Abril 2026
            "02/04/2026": 3,
            "03/04/2026": 3,
            "04/04/2026": 3,
            "05/04/2026": 3,
            "11/04/2026": 2,
            "18/04/2026": 2,
            "19/04/2026": 2,
            "20/04/2026": 2,
            "21/04/2026": 2,
            "22/04/2026": 2,
            "23/04/2026": 2,
            "25/04/2026": 2,
            
            // Maio 2026
            "02/05/2026": 2,
            "09/05/2026": 2,
            "16/05/2026": 2,
            "23/05/2026": 2,
            "30/04/2026": 3,
            "01/05/2026": 3,
            "02/05/2026": 3,
            "03/05/2026": 3,
            "30/05/2026": 2,
            
            // Junho 2026
            "04/06/2026": 3,
            "05/06/2026": 3,
            "06/06/2026": 3,
            "07/06/2026": 3,
            "13/06/2026": 2,
            "20/06/2026": 2,
            "27/06/2026": 2,
            
            // Julho 2026
            "04/07/2026": 2,
            "11/07/2026": 2,
            "18/07/2026": 2,
            "25/07/2026": 2,
            
            // Agosto 2026
            "01/08/2026": 2,
            "08/08/2026": 2,
            "15/08/2026": 2,
            "22/08/2026": 2,
            "29/08/2026": 2,
            
            // Setembro 2026
            "04/09/2026": 3,
            "05/09/2026": 3,
            "06/09/2026": 3,
            "07/09/2026": 3,
            "12/09/2026": 2,
            "19/09/2026": 2,
            "26/09/2026": 2,
            
            // Outubro 2026
            "03/10/2026": 2,
            "09/10/2026": 3,
            "10/10/2026": 3,
            "11/10/2026": 3,
            "12/10/2026": 3,
            "17/10/2026": 2,
            "24/10/2026": 2,
            "31/10/2026": 2,
            
            // Novembro 2026
            "07/11/2026": 2,
            "14/11/2026": 2,
            "19/11/2026": 3,
            "20/11/2026": 3,
            "21/11/2026": 3,
            "22/11/2026": 3,
            "28/11/2026": 2,
            
            // Dezembro 2026
            "05/12/2026": 2,
            "12/12/2026": 2,
            "19/12/2026": 2,
            "26/12/2026": 2,
            "30/12/2026": 4,
            "31/12/2026": 4,
            
            // Janeiro 2027
            "01/01/2027": 4,
            "02/01/2027": 4,
            "03/01/2027": 4
        };

        // Fun√ß√µes de formata√ß√£o e convers√£o
        function convertCurrencyToNumber(currencyString) {
            if (!currencyString) return 0;
            const numericString = currencyString.toString()
                .replace(/R\$\s?/g, '')
                .replace(/\./g, '')
                .replace(',', '.');
            return parseFloat(numericString) || 0;
        }

        function formatCurrency(value) {
            const numericValue = typeof value === 'string' ?
                parseFloat(value.replace(/[^\d.-]/g, '')) :
                Number(value);
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2
            }).format(numericValue);
        }

        function formatDateToDDMMAAAA(dateString) {
            const date = new Date(dateString);
            const offset = date.getTimezoneOffset();
            date.setMinutes(date.getMinutes() + offset);

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function getDatesBetween(startDateStr, endDateStr) {
            const dates = [];
            let currentDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);

            while (currentDate < endDate) {
                dates.push(formatDateToDDMMAAAA(currentDate.toISOString().split('T')[0]));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        // Fun√ß√£o para verificar a estadia m√≠nima (corrigida)
function checkMinLOS(startDateStr, endDateStr) {
    const startDate = new Date(startDateStr);
    const endDate = new Date(endDateStr);
    const nights = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));

    // Obter todas as datas do per√≠odo
    const datesInPeriod = getDatesBetween(startDateStr, endDateStr);
    
    // Encontrar o maior minLOS entre todas as datas do per√≠odo
    let maxMinLOS = 1;
    let dateWithMaxMinLOS = '';
    
    datesInPeriod.forEach(dateStr => {
        const minLOS = MINLOS_DATA[dateStr] || 1;
        if (minLOS > maxMinLOS) {
            maxMinLOS = minLOS;
            dateWithMaxMinLOS = dateStr;
        }
    });

    // Verificar se a estadia atende ao maior minLOS encontrado
    if (nights < maxMinLOS) {
        return {
            valid: false,
            message: `Para o per√≠odo selecionado, h√° restri√ß√£o de estadia m√≠nima de ${maxMinLOS} noites (a partir de ${dateWithMaxMinLOS}). Por favor, ajuste suas datas.`
        };
    }

    return { valid: true };
}

        // Fun√ß√µes da API
        const availabilityCache = {};

        async function fetchAvailability(startDate, endDate) {
            const cacheKey = `${startDate}-${endDate}`;

            if (availabilityCache[cacheKey]) {
                return availabilityCache[cacheKey];
            }

            // Usando o seu proxy privado do Cloudflare Workers para m√°xima estabilidade
            const proxies = [
                { url: 'https://broken-hall-6760.paulo-migueoli.workers.dev/', type: 'direct' }
            ];

            let lastError;

            for (const proxy of proxies) {
                try {
                    const targetUrl = 'https://reservas.desbravador.com.br/reservas/modules/ws/interface.php';
                    let fullUrl;
                    
                    if (proxy.type === 'allorigins') {
                        fullUrl = proxy.url + encodeURIComponent(targetUrl);
                    } else {
                        fullUrl = proxy.url + targetUrl;
                    }

                    const payload = {
                        "wsrolRQ": {
                            "hotelLoginRQ": {
                                "slug": "hotel-granja-brasil-resort",
                                "origem": "rolweb",
                                "ip": "191.31.44.244"
                            },
                            "disponibilidadeRQ": {
                                "disponibilidade": {
                                    "datainicio": startDate,
                                    "datafim": endDate,
                                    "detalhes": true,
                                    "cdvoucher": 0
                                }
                            }
                        }
                    };

                    let response;
                    if (proxy.type === 'allorigins') {
                        // AllOrigins 'get' endpoint embrulha a resposta em um JSON
                        response = await fetch(fullUrl, {
                            method: 'POST', // AllOrigins aceita POST para o endpoint /get mas o trata de forma espec√≠fica
                            headers: {
                                'Authorization': 'Basic cm9sRHNsOkJyNDVpMUAyMDE4',
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload)
                        });
                    } else {
                        response = await fetch(fullUrl, {
                            method: 'POST',
                            headers: {
                                'Accept': 'application/json',
                                'Authorization': 'Basic cm9sRHNsOkJyNDVpMUAyMDE4',
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload)
                        });
                    }

                    if (!response.ok) {
                        throw new Error(`Erro ${response.status} no proxy ${proxy.url}`);
                    }

                    let data = await response.json();
                    
                    // Se for AllOrigins, o conte√∫do real est√° dentro de data.contents
                    if (proxy.type === 'allorigins' && data.contents) {
                        try {
                            data = JSON.parse(data.contents);
                        } catch (e) {
                            // Se n√£o for JSON, pode ser a resposta direta
                        }
                    }

                    availabilityCache[cacheKey] = data;
                    return data;

                } catch (error) {
                    console.warn(`Tentativa com proxy ${proxy.url} falhou:`, error.message);
                    lastError = error;
                    continue;
                }
            }

            // Se todos os proxies falharem
            throw new Error('Servi√ßo indispon√≠vel no momento. Por favor, tente novamente mais tarde.');
        }

        async function fetchHotelRates(startDate, endDate) {
            const url = `https://xeitj4h9fd.execute-api.us-east-1.amazonaws.com/prd/desbravador?start=${encodeURIComponent(startDate)}&end=${encodeURIComponent(endDate)}`;

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Basic Og==',
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erro na consulta: ${response.status}`);
                }

                const data = await response.json();

                if (!data.data || !data.data.dataFormatted || !Array.isArray(data.data.dataFormatted)) {
                    throw new Error('Formato de dados inv√°lido retornado pela API');
                }

                // Aplica desconto de 5% em todos os valores retornados
                data.data.dataFormatted = data.data.dataFormatted.map(room => {
                    const valorMedio = convertCurrencyToNumber(room.valorMedio || room.total);
                    const total = convertCurrencyToNumber(room.total);

                    return {
                        ...room,
                        valorMedio: valorMedio * 0.95,  // Aplica 5% de desconto
                        total: total * 0.95             // Aplica 5% de desconto
                    };
                });

                return data;
            } catch (error) {
                console.error('Erro na API de tarifas:', error);
                throw new Error('Erro ao consultar tarifas. Por favor, tente novamente.');
            }
        }

        // ========= FUN√á√ÉO PARA CHAMAR A IA =========
        async function callHotelAI(message) {
            try {
                console.log('Chamando IA para:', message.substring(0, 50) + '...');
                
                const response = await fetch('https://intrega-ia.paulo-migueoli.workers.dev/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: message
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    console.log('Resposta IA recebida');
                    // Formatar a resposta para melhor legibilidade
                    return formatAIResponse(data.response);
                } else {
                    console.error('Erro da API:', data);
                    return getFallbackResponse(message);
                }
            } catch (error) {
                console.error('Erro ao chamar IA:', error);
                return getFallbackResponse(message);
            }
        }

        // ========= FUN√á√ÉO PARA FORMATAR RESPOSTAS DA IA =========
        function formatAIResponse(text) {
            if (!text) return text;
            
            let formattedText = text;
            
            // 1. Converter **texto** para <strong>texto</strong>
            formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // 2. Remover a dica sobre clicar em n√∫meros
            formattedText = formattedText.replace(/üí° Dica: Clique em um n√∫mero para ligar diretamente!/g, '');
            
            // 3. Remover termos como "Resposta precisa:", "Informa√ß√£o complementar:", etc.
            const patternsToRemove = [
                /Resposta precisa:/g,
                /Informa√ß√£o complementar \(da Categoria \d+\):/g,
                /V√≠nculo com a experi√™ncia no hotel:/g,
                /Call to Action \(Pr√≥ximo Passo\):/g,
                /Gatilho usado:/g,
                /Gatilho para [^:]+:/g
            ];
            
            patternsToRemove.forEach(pattern => {
                formattedText = formattedText.replace(pattern, '');
            });
            
            // 4. Limpar linhas em branco extras
            formattedText = formattedText.replace(/\n\s*\n\s*\n/g, '\n\n');
            
            // 5. Substituir quebras de linha por tags <br> e par√°grafos
            formattedText = formattedText.replace(/\n\n/g, '</p><p>');
            formattedText = formattedText.replace(/\n/g, '<br>');
            
            // 6. Envolver em par√°grafo se n√£o estiver
            if (!formattedText.startsWith('<p>')) {
                formattedText = `<p>${formattedText}</p>`;
            }
            
            // 7. Formatar listas com marcadores
            formattedText = formattedText.replace(/‚Ä¢\s*/g, '<li>');
            formattedText = formattedText.replace(/<\/li><br>/g, '</li>');
            
            // Se detectar itens de lista, criar lista formatada
            if (formattedText.includes('<li>')) {
                // Adicionar container de lista
                formattedText = formattedText.replace(/<li>(.*?)<\/li>/g, function(match, content) {
                    return `<li style="margin: 5px 0; padding-left: 5px;">${content.trim()}</li>`;
                });
                
                // Envolver em lista n√£o ordenada
                formattedText = formattedText.replace(/<li>/, '<ul style="margin: 10px 0; padding-left: 20px;">');
                formattedText = formattedText.replace(/<\/p>$/, '</ul></p>');
            }
            
            // 8. Destacar telefones e n√∫meros importantes
            formattedText = formattedText.replace(/(\(\d{2}\)\s*\d{4,5}-\d{4})/g, 
                '<strong style="color: #075e54;">$1</strong>');
            formattedText = formattedText.replace(/(\d{2}\s*\d{4,5}-\d{4})/g, 
                '<strong style="color: #075e54;">$1</strong>');
            
            // 9. Destacar nomes de estabelecimentos
            const estabelecimentos = [
                "Sal√£o Andrea Novena", "Ateli√™ da Beleza", "Farley Frossard", 
                "Divino & Cucina", "Suki Gastronomia Japonesa", "Lenha & Co", 
                "Farfarello", "Bordeaux Vinhos", "Drogaria Pacheco", "Droga Raia", 
                "Drogasil", "Hortifruti Itaipava", "Castelo de Itaipava", 
                "Parque Municipal de Itaipava", "Itaipava Spa", "Academia Granja Brasil", 
                "Shopping Vilarejo", "Shopping Itaipava", "Esta√ß√£o Locanda", 
                "Cine Itaipava", "Mim√¥ Pizzaria", "Hotel Granja Brasil"
            ];
            
            estabelecimentos.forEach(estabelecimento => {
                const regex = new RegExp(estabelecimento, 'g');
                formattedText = formattedText.replace(regex, '<strong>$&</strong>');
            });
            
            // 10. Formatar endere√ßos
            formattedText = formattedText.replace(/(Shopping Itaipava|Shopping Vilarejo|Estrada Uni√£o e Ind√∫stria|Estrada Bernardo Coutinho|Rua Francisco dos Santos)/g, 
                '<span style="color: #666;">$1</span>');
            
            // 11. Adicionar estilos para melhor legibilidade
            formattedText = formattedText.replace(/<p>/g, '<p style="margin: 8px 0; line-height: 1.5;">');
            
            // 12. Adicionar container para resposta formatada
            formattedText = `
                <div class="ai-response">
                    ${formattedText}
                </div>
            `;
            
            return formattedText;
        }

        // ========= FUN√á√ÉO PARA ADICIONAR CLICK AOS TELEFONES =========
        function setupPhoneClicks() {
            setTimeout(() => {
                // Encontrar todos os n√∫meros de telefone na resposta
                const phoneRegex = /(\(\d{2}\)\s*\d{4,5}-\d{4})|(\d{2}\s*\d{4,5}-\d{4})/g;
                const messageElements = document.querySelectorAll('.message.bot .message-content');
                
                messageElements.forEach(element => {
                    const html = element.innerHTML;
                    const updatedHtml = html.replace(phoneRegex, (match) => {
                        const cleanNumber = match.replace(/\D/g, '');
                        const telLink = cleanNumber.startsWith('0') ? cleanNumber.substring(1) : cleanNumber;
                        return `<a href="tel:${telLink}" class="phone-link">${match}</a>`;
                    });
                    
                    if (updatedHtml !== html) {
                        element.innerHTML = updatedHtml;
                    }
                });
            }, 100);
        }

        // ========= FUN√á√ÉO FALLBACK FORMATADA =========
        function getFallbackResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // Verificar se √© uma pergunta sobre or√ßamento/reserva
            if (lowerMessage.includes('or√ßamento') || lowerMessage.includes('pre√ßo') || lowerMessage.includes('valor') || lowerMessage.includes('reserva')) {
                return generateQuoteForm();
            }
            
            // Fallback gen√©rico
            return `
                <p>Desculpe, estou com dificuldades t√©cnicas no momento.</p>
                <p>Voc√™ pode:</p>
                <div class="quick-actions">
                    <button class="quick-action" data-action="solicitar-orcamento">üí∞ Solicitar Or√ßamento</button>
                    <button class="quick-action" data-action="informacoes-hotel">üè® Sobre o Hotel</button>
                    <button class="whatsapp-button" onclick="openWhatsApp('Ol√°, preciso de ajuda com o Hotel Granja Brasil')">
                        üí¨ WhatsApp
                    </button>
                </div>
            `;
        }

        // ========= FUN√á√ÉO PARA DIVIDIR RESPOSTAS EM PARTES =========
        function splitResponseIntoParts(responseText) {
            const parts = [];
            const maxLength = 300; // Caracteres por parte
            
            // Se a resposta for curta, retorna como uma √∫nica parte
            if (responseText.length <= maxLength) {
                return [responseText];
            }
            
            // Dividir por par√°grafos
            const paragraphs = responseText.split('</p><p>');
            
            let currentPart = '';
            for (const paragraph of paragraphs) {
                if ((currentPart + paragraph).length > maxLength && currentPart.length > 0) {
                    parts.push(currentPart);
                    currentPart = paragraph;
                } else {
                    currentPart += (currentPart ? '</p><p>' : '') + paragraph;
                }
            }
            
            // Adicionar a √∫ltima parte
            if (currentPart.length > 0) {
                parts.push(currentPart);
            }
            
            return parts;
        }

        // ========= FUN√á√ÉO PARA ADICIONAR MENSAGEM COM DIGITA√á√ÉO HUMANA =========
        async function addMessageWithHumanTyping(content, isUser = false) {
            if (isUser) {
                // Para mensagens do usu√°rio, apenas adiciona
                addMessage(content, true);
                return;
            }
            
            // Para respostas da IA, divide em partes e adiciona com digita√ß√£o
            const parts = splitResponseIntoParts(content);
            
            for (let i = 0; i < parts.length; i++) {
                const part = parts[i];
                
                // Mostrar "digitando..." antes de cada parte (exceto a primeira se j√° estiver mostrando)
                if (i > 0) {
                    showTyping();
                    await delay(800 + Math.random() * 800); // Tempo aleat√≥rio entre 800-1600ms
                    hideTyping();
                }
                
                // Adicionar a parte da mensagem
                addMessage(part, false);
                
                // Aguardar um pouco entre as partes (tempo de digita√ß√£o)
                if (i < parts.length - 1) {
                    await delay(1000 + Math.random() * 1000); // Tempo aleat√≥rio entre 1000-2000ms
                }
            }
        }

        // ========= FUN√á√ÉO DE DELAY =========
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Vari√°veis globais
        let conversationHistory = [];
        let currentQuoteData = null;
        let selectedRooms = [];
        let currentAvailabilityData = null;
        let isCheckingAvailability = false;
        let isProcessingQuickAction = false;
        const availabilityHistory = [];

        // Fun√ß√µes do chat
        function addMessage(content, isUser = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const typingIndicator = document.getElementById('typingIndicator');

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;

            const avatar = document.createElement('div');
            avatar.className = `message-avatar ${isUser ? 'user-avatar' : 'bot-avatar'}`;
            avatar.textContent = isUser ? 'üë§' : 'ü§ñ';

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // Se for uma resposta da IA, garantir que tenha o estilo correto
            if (!isUser && typeof content === 'string' && content.includes('ai-response')) {
                messageContent.innerHTML = content;
            } else if (typeof content === 'string') {
                messageContent.innerHTML = content;
            } else {
                messageContent.appendChild(content);
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);

            messagesContainer.insertBefore(messageDiv, typingIndicator);

            setTimeout(() => {
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 50);

            conversationHistory.push({
                content: typeof content === 'string' ? content : content.outerHTML,
                isUser: isUser,
                timestamp: new Date()
            });

            // Configurar listeners para n√∫meros de telefone clic√°veis
            setTimeout(() => {
                setupButtonListeners();
                setupPhoneClicks();
            }, 50);
        }

        function showTyping() {
            document.getElementById('typingIndicator').style.display = 'flex';
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }

        function hideTyping() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            return errorDiv;
        }

        function showNoAvailability(message) {
            const noAvailDiv = document.createElement('div');
            noAvailDiv.className = 'no-availability';
            noAvailDiv.textContent = message;
            noAvailDiv.style.display = 'block';
            return noAvailDiv;
        }

        function showLoading(message) {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.textContent = message;
            loadingDiv.style.display = 'block';
            return loadingDiv;
        }

        // Fun√ß√µes para controle dos campos de data
        function disableDateInputs() {
            document.getElementById('checkinDate').disabled = true;
            document.getElementById('checkoutDate').disabled = true;
        }

        function enableDateInputs() {
            document.getElementById('checkinDate').disabled = false;
            document.getElementById('checkoutDate').disabled = false;
        }

        function resetQuoteForm() {
            selectedRooms = [];
            currentQuoteData = null;
            enableDateInputs();
            document.getElementById('quoteForm').reset();
            document.getElementById('roomSelectionSection').style.display = 'none';
            document.getElementById('quoteResultContainer').style.display = 'none';
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('errorIndicator').style.display = 'none';
            document.getElementById('noAvailabilityIndicator').style.display = 'none';
            document.getElementById('childAgeGroup1').style.display = 'none';
            document.getElementById('childAgeGroup2').style.display = 'none';

            // Limpar checkboxes se existirem
            const roomsContainer = document.getElementById('roomsContainer');
            if (roomsContainer) {
                roomsContainer.innerHTML = '';
            }
        }

        // Fun√ß√µes do formul√°rio de cota√ß√£o
        function generateQuoteForm() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const minDate = tomorrow.toISOString().split('T')[0];

            const formHTML = `
                <p><strong>üí∞ Solicitar Or√ßamento de Reserva</strong></p>
                <p>Preencha os dados abaixo para receber seu or√ßamento personalizado em tempo real:</p>
                <div class="quote-form" id="quoteForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Data de Check-in:</label>
                            <input type="date" id="checkinDate" min="${minDate}">
                        </div>
                        <div class="form-group">
                            <label>Data de Check-out:</label>
                            <input type="date" id="checkoutDate" min="${minDate}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>N√∫mero de Adultos:</label>
                        <select id="adults" onchange="validateGuestCombination()">
                            <option value="1">1 Adulto</option>
                            <option value="2" selected>2 Adultos</option>
                            <option value="3">3 Adultos</option>
                        </select>
                    </div>

                    <div class="children-section">
                        <h4>üë∂ Crian√ßas (at√© 17 anos)</h4>
                        <div class="form-group">
                            <label>Quantidade de Crian√ßas:</label>
                            <select id="hasChildren" onchange="toggleChildAge(); validateGuestCombination()">
                                <option value="0">Sem crian√ßas</option>
                                <option value="1">1 Crian√ßa</option>
                                <option value="2">2 Crian√ßas</option>
                            </select>
                        </div>

                        <div class="form-group" id="childAgeGroup1" style="display: none;">
                            <label>Idade da 1¬™ Crian√ßa:</label>
                            <select id="childAge1" onchange="validateGuestCombination()">
                                <option value="0">0 ano</option>
                                <option value="1">1 ano</option>
                                <option value="2">2 anos</option>
                                <option value="3">3 anos</option>
                                <option value="4">4 anos</option>
                                <option value="5">5 anos</option>
                                <option value="6" selected>6 anos</option>
                                <option value="7">7 anos</option>
                                <option value="8">8 anos</option>
                                <option value="9">9 anos</option>
                                <option value="10">10 anos</option>
                                <option value="11">11 anos</option>
                                <option value="12">12 anos</option>
                                <option value="13">13 anos</option>
                                <option value="14">14 anos</option>
                                <option value="15">15 anos</option>
                                <option value="16">16 anos</option>
                                <option value="17">17 anos</option>
                            </select>
                        </div>

                        <div class="form-group" id="childAgeGroup2" style="display: none;">
                            <label>Idade da 2¬™ Crian√ßa:</label>
                            <select id="childAge2" onchange="validateGuestCombination()">
                                <option value="0">0 ano</option>
                                <option value="1">1 ano</option>
                                <option value="2">2 anos</option>
                                <option value="3">3 anos</option>
                                <option value="4">4 anos</option>
                                <option value="5">5 anos</option>
                                <option value="6" selected>6 anos</option>
                                <option value="7">7 anos</option>
                                <option value="8">8 anos</option>
                                <option value="9">9 anos</option>
                                <option value="10">10 anos</option>
                                <option value="11">11 anos</option>
                                <option value="12">12 anos</option>
                                <option value="13">13 anos</option>
                                <option value="14">14 anos</option>
                                <option value="15">15 anos</option>
                                <option value="16">16 anos</option>
                                <option value="17">17 anos</option>
                            </select>
                        </div>
                        <div id="invalidCombinationMsg" class="invalid-combination"></div>
                    </div>

                    <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin: 15px 0; font-size: 14px;">
                        <p><strong>‚ÑπÔ∏è Informa√ß√µes Importantes:</strong></p>
                        <ul style="margin: 8px 0; padding-left: 20px;">
                            <li>Check-in: ${HOTEL_CONFIG.horarios.checkin} | Check-out: ${HOTEL_CONFIG.horarios.checkout}</li>
                            <li>Hotel 100% n√£o fumante</li>
                            <li>Animais de estima√ß√£o n√£o s√£o permitidos</li>
                            <li>Atestado m√©dico obrigat√≥rio para √°reas externas ao Hotel (sauna, academia e piscinas) - v√°lido por 6 meses.</li>
                            <li>O tarif√°rio e a disponibilidade est√£o sujeitos a altera√ß√£o sem aviso pr√©vio. As informa√ß√µes fornecidas nesta consulta ser√£o confirmadas pelo agente de reservas no momento da resposta √† sua cota√ß√£o.</li>
                        </ul>
                    </div>

                    <button id="checkAvailabilityBtn" class="quote-button">
                        üîç Consultar Disponibilidade
                    </button>

                    <div id="loadingIndicator" style="display: none;"></div>
                    <div id="errorIndicator" style="display: none;"></div>
                    <div id="noAvailabilityIndicator" style="display: none;"></div>

                    <div id="roomSelectionSection" style="display: none; margin-top: 15px;"></div>

                    <div id="quoteResultContainer" style="display: none;"></div>
                </div>
            `;

            return formHTML;
        }

        function toggleChildAge() {
            const hasChildren = document.getElementById('hasChildren').value;
            const childAgeGroup1 = document.getElementById('childAgeGroup1');
            const childAgeGroup2 = document.getElementById('childAgeGroup2');

            if (hasChildren === '1') {
                childAgeGroup1.style.display = 'block';
                childAgeGroup2.style.display = 'none';
            } else if (hasChildren === '2') {
                childAgeGroup1.style.display = 'block';
                childAgeGroup2.style.display = 'block';
            } else {
                childAgeGroup1.style.display = 'none';
                childAgeGroup2.style.display = 'none';
            }

            validateGuestCombination();
        }

        function validateGuestCombination() {
            const adults = parseInt(document.getElementById('adults').value);
            const hasChildren = document.getElementById('hasChildren').value !== '0';
            const childrenCount = hasChildren ? parseInt(document.getElementById('hasChildren').value) : 0;
            const childAge1 = hasChildren ? parseInt(document.getElementById('childAge1').value) : 0;
            const childAge2 = childrenCount === 2 ? parseInt(document.getElementById('childAge2').value) : 0;
            const errorMsg = document.getElementById('invalidCombinationMsg');
            const checkBtn = document.getElementById('checkAvailabilityBtn');

            errorMsg.style.display = 'none';
            checkBtn.disabled = false;

            if (adults === 0 && hasChildren) {
                errorMsg.textContent = 'Para reservas com crian√ßas, √© necess√°rio pelo menos 1 adulto';
                errorMsg.style.display = 'block';
                checkBtn.disabled = true;
                return false;
            }

            if (adults + childrenCount > 3) {
                errorMsg.textContent = 'Capacidade m√°xima excedida (m√°ximo 3 h√≥spedes)';
                errorMsg.style.display = 'block';
                checkBtn.disabled = true;
                return false;
            }

            return true;
        }

        function updateRoomOptions() {
            if (!validateGuestCombination()) return;
            if (!currentAvailabilityData) return;

            const adults = parseInt(document.getElementById('adults').value);
            const hasChildren = document.getElementById('hasChildren').value !== '0';
            const childrenCount = hasChildren ? parseInt(document.getElementById('hasChildren').value) : 0;
            const childAge1 = hasChildren ? parseInt(document.getElementById('childAge1').value) : 0;
            const childAge2 = childrenCount === 2 ? parseInt(document.getElementById('childAge2').value) : 0;
            const totalGuests = adults + childrenCount;

            const infoDiv = document.getElementById('roomSelectionInfo');

            const startDate = document.getElementById('checkinDate').value;
            const endDate = document.getElementById('checkoutDate').value;
            const datesToCheck = getDatesBetween(startDate, endDate);

            let infoMessage = '';
            let hasAvailableOptions = false;

            // Atualizar checkboxes existentes
            const checkboxes = document.querySelectorAll('#roomsContainer input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                const roomData = JSON.parse(checkbox.value);
                const roomName = roomData.descricao.toLowerCase();
                const roomCode = roomData.codigo;

                const isSuite = roomName.includes('su√≠te') || roomName.includes('suite');
                const isSuperior = roomName.includes('apartamento superior');

                let isAvailable = true;
                let reason = '';

                // Verificar disponibilidade para todas as datas
                const hasAvailability = datesToCheck.every(date => {
                    return currentAvailabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode] &&
                           currentAvailabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode].diaria[date] > 0;
                });

                if (!hasAvailability) {
                    isAvailable = false;
                    reason = ' (indispon√≠vel para todas as datas selecionadas)';
                } else if (isSuperior && totalGuests > 2) {
                    isAvailable = false;
                    reason = ' (capacidade m√°xima de 2 h√≥spedes)';
                } else if (hasChildren && (childAge1 <= 6 || (childrenCount === 2 && childAge2 <= 6)) && !isSuite) {
                    isAvailable = false;
                    reason = ' (crian√ßas at√© 6 anos exigem su√≠te com sof√°-cama)';
                }

                if (!isAvailable) {
                    checkbox.disabled = true;
                    checkbox.parentElement.style.opacity = '0.5';
                    checkbox.parentElement.style.cursor = 'not-allowed';
                    checkbox.parentElement.title = reason.trim();
                } else {
                    checkbox.disabled = false;
                    checkbox.parentElement.style.opacity = '1';
                    checkbox.parentElement.style.cursor = 'pointer';
                    checkbox.parentElement.removeAttribute('title');
                    hasAvailableOptions = true;
                }
            });

            if (hasChildren && (childAge1 <= 6 || (childrenCount === 2 && childAge2 <= 6))) {
                infoMessage = 'Nota: Crian√ßas at√© 6 anos exigem su√≠tes com sof√°-cama (S√™nior ou Master)';
            } else if (hasChildren && (childAge1 > 6 || (childrenCount === 2 && childAge2 > 6))) {
                infoMessage = 'Nota: Crian√ßa acima de 6 anos ser√° cobrada como h√≥spede extra (R$ 102/dia)';
            }

            if (infoDiv) {
                infoDiv.textContent = infoMessage;
            }

            // Retorna se ainda h√° op√ß√µes dispon√≠veis
            return hasAvailableOptions;
        }

        async function checkAvailability() {
            if (isCheckingAvailability) return;
            isCheckingAvailability = true;

            if (!validateGuestCombination()) {
                isCheckingAvailability = false;
                return;
            }

            const startDate = document.getElementById('checkinDate').value;
            const endDate = document.getElementById('checkoutDate').value;
            const adults = parseInt(document.getElementById('adults').value);
            const hasChildren = document.getElementById('hasChildren').value !== '0';
            const childrenCount = hasChildren ? parseInt(document.getElementById('hasChildren').value) : 0;
            const childAge1 = hasChildren ? parseInt(document.getElementById('childAge1').value) : 0;
            const childAge2 = childrenCount === 2 ? parseInt(document.getElementById('childAge2').value) : 0;

            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorIndicator = document.getElementById('errorIndicator');
            const noAvailabilityIndicator = document.getElementById('noAvailabilityIndicator');
            const roomSelectionSection = document.getElementById('roomSelectionSection');
            const quoteResultContainer = document.getElementById('quoteResultContainer');

            // Valida√ß√µes b√°sicas
            if (!startDate || !endDate) {
                errorIndicator.innerHTML = showError('Por favor, selecione as datas de check-in e check-out').outerHTML;
                errorIndicator.style.display = 'block';
                loadingIndicator.style.display = 'none';
                noAvailabilityIndicator.style.display = 'none';
                roomSelectionSection.style.display = 'none';
                quoteResultContainer.style.display = 'none';
                isCheckingAvailability = false;
                enableDateInputs(); // Habilitar campos novamente em caso de erro
                return;
            }

            // Valida√ß√£o de anteced√™ncia de 1 dia
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const checkinDate = new Date(startDate);

            if (checkinDate <= today) {
                errorIndicator.innerHTML = showError('O check-in deve ser feito com pelo menos 1 dia de anteced√™ncia. Por favor, selecione uma data a partir de amanh√£.').outerHTML;
                errorIndicator.style.display = 'block';
                loadingIndicator.style.display = 'none';
                noAvailabilityIndicator.style.display = 'none';
                roomSelectionSection.style.display = 'none';
                quoteResultContainer.style.display = 'none';
                isCheckingAvailability = false;
                enableDateInputs(); // Habilitar campos novamente em caso de erro
                return;
            }

            if (new Date(endDate) <= new Date(startDate)) {
                errorIndicator.innerHTML = showError('A data de check-out deve ser posterior √† data de check-in').outerHTML;
                errorIndicator.style.display = 'block';
                loadingIndicator.style.display = 'none';
                noAvailabilityIndicator.style.display = 'none';
                roomSelectionSection.style.display = 'none';
                quoteResultContainer.style.display = 'none';
                isCheckingAvailability = false;
                enableDateInputs(); // Habilitar campos novamente em caso de erro
                return;
            }

            // Verificar estadia m√≠nima (minLOS)
            const minLOSCheck = checkMinLOS(startDate, endDate);
            if (!minLOSCheck.valid) {
                errorIndicator.innerHTML = showError(minLOSCheck.message).outerHTML;
                errorIndicator.style.display = 'block';
                loadingIndicator.style.display = 'none';
                noAvailabilityIndicator.style.display = 'none';
                roomSelectionSection.style.display = 'none';
                quoteResultContainer.style.display = 'none';
                isCheckingAvailability = false;
                enableDateInputs(); // Habilitar campos novamente em caso de erro
                return;
            }

            loadingIndicator.innerHTML = showLoading('Consultando disponibilidade, aguarde...').outerHTML;
            loadingIndicator.style.display = 'block';
            errorIndicator.style.display = 'none';
            noAvailabilityIndicator.style.display = 'none';
            roomSelectionSection.style.display = 'none';
            quoteResultContainer.style.display = 'none';

            try {
                const formattedStartDate = formatDateToDDMMAAAA(startDate);
                const formattedEndDate = formatDateToDDMMAAAA(endDate);

                let availabilityData;
                try {
                    availabilityData = await fetchAvailability(formattedStartDate, formattedEndDate);
                    currentAvailabilityData = availabilityData;

                    // Registrar no hist√≥rico
                    availabilityHistory.push({
                        timestamp: new Date(),
                        action: 'Consulta inicial de disponibilidade',
                        data: JSON.parse(JSON.stringify(availabilityData))
                    });
                } catch (error) {
                    console.error('Erro na API de disponibilidade:', error);
                    throw new Error('Servi√ßo indispon√≠vel no momento. Por favor, tente novamente mais tarde.');
                }

                if (!availabilityData.wsrolRS || !availabilityData.wsrolRS.disponibilidadeRS || !availabilityData.wsrolRS.disponibilidadeRS.disponibilidade || !availabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result || Object.keys(availabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result).length === 0) {
                    noAvailabilityIndicator.innerHTML = showNoAvailability("N√£o h√° disponibilidade de acomoda√ß√µes para o per√≠odo selecionado. Por favor, tente outras datas.").outerHTML;
                    noAvailabilityIndicator.style.display = 'block';
                    loadingIndicator.style.display = 'none';
                    errorIndicator.style.display = 'none';
                    isCheckingAvailability = false;
                    enableDateInputs(); // Habilitar campos novamente em caso de erro
                    return;
                }

                let apiData;
                try {
                    apiData = await fetchHotelRates(formattedStartDate, formattedEndDate);

                    if (!apiData.data || !apiData.data.dataFormatted || !Array.isArray(apiData.data.dataFormatted)) {
                        throw new Error('Formato de dados inv√°lido retornado pela API');
                    }
                } catch (error) {
                    console.error('Erro na API de tarifas:', error);
                    throw new Error('Erro ao consultar tarifas. Por favor, tente novamente.');
                }

                const availableRooms = apiData.data.dataFormatted.filter(room => {
                    const roomCode = room.codigo;
                    const roomName = room.descricao.toLowerCase();
                    const isSuite = roomName.includes('su√≠te') || roomName.includes('suite');
                    const isSuperior = roomName.includes('apartamento superior');
                    const datesToCheck = getDatesBetween(startDate, endDate);
                    const totalGuests = adults + childrenCount;

                    const isAvailableForDates = datesToCheck.every(date => {
                        return availabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode] &&
                               availabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode].diaria[date] > 0;
                    });

                    if (!isAvailableForDates) return false;
                    if (isSuperior && totalGuests > 2) return false;
                    if (hasChildren && (childAge1 <= 6 || (childrenCount === 2 && childAge2 <= 6)) && !isSuite) return false;

                    return true;
                });

                if (availableRooms.length === 0) {
                    let message = "N√£o h√° acomoda√ß√µes dispon√≠veis para o per√≠odo selecionado com a configura√ß√£o de h√≥spedes informada.";

                    if (hasChildren && (childAge1 <= 6 || (childrenCount === 2 && childAge2 <= 6))) {
                        message += " Crian√ßas at√© 6 anos exigem su√≠tes com sof√°-cama (S√™nior ou Master).";
                    } else if (adults > 2) {
                        message += " Para 3 adultos, apenas su√≠tes Master ou S√™nior est√£o dispon√≠veis.";
                    }

                    noAvailabilityIndicator.innerHTML = showNoAvailability(message).outerHTML;
                    noAvailabilityIndicator.style.display = 'block';
                    loadingIndicator.style.display = 'none';
                    errorIndicator.style.display = 'none';
                    isCheckingAvailability = false;
                    enableDateInputs(); // Habilitar campos novamente em caso de erro
                    return;
                }

                // Esconde o loading antes de exibir as op√ß√µes
                loadingIndicator.style.display = 'none';
                displayAvailableRooms(apiData, startDate, endDate, availableRooms, adults, hasChildren, childAge1, childAge2);
            } catch (error) {
                console.error('Erro na consulta:', error);
                errorIndicator.innerHTML = showError(error.message).outerHTML;
                errorIndicator.style.display = 'block';
                loadingIndicator.style.display = 'none';
                noAvailabilityIndicator.style.display = 'none';
                enableDateInputs(); // Habilitar campos novamente em caso de erro
            } finally {
                isCheckingAvailability = false;
            }
        }

        function displayAvailableRooms(apiData, startDate, endDate, availableRooms, adults, hasChildren, childAge1, childAge2) {
            const roomSelectionSection = document.getElementById('roomSelectionSection');
            const quoteResultContainer = document.getElementById('quoteResultContainer');
            const loadingIndicator = document.getElementById('loadingIndicator');

            loadingIndicator.style.display = 'none';
            roomSelectionSection.style.display = 'block';
            quoteResultContainer.style.display = 'none';

            // Criar container para as op√ß√µes de quarto
            const roomsContainer = document.createElement('div');
            roomsContainer.id = 'roomsContainer';
            roomsContainer.style.marginBottom = '15px';

            // Limpar se√ß√£o de sele√ß√£o de quartos
            roomSelectionSection.innerHTML = '';
            roomSelectionSection.appendChild(roomsContainer);

            // Adicionar t√≠tulo
            const title = document.createElement('p');
            title.innerHTML = '<strong>Selecione as acomoda√ß√µes desejadas:</strong>';
            roomsContainer.appendChild(title);

            // 1. Primeiro filtra e ordena os quartos na ordem espec√≠fica
            const roomTypesInOrder = [
                { name: "Apartamento Superior", code: "SUP" },
                { name: "Su√≠te S√™nior", code: "SEN" },
                { name: "Su√≠te Master (Cobertura)", code: "MAS" }
            ];

            // 2. Criar array ordenado
            const orderedRooms = [];
            roomTypesInOrder.forEach(type => {
                const room = availableRooms.find(r =>
                    r.descricao.includes(type.name) ||
                    r.codigo === type.code
                );
                if (room) orderedRooms.push(room);
            });

            // 3. Adicionar os quartos na ordem correta
            orderedRooms.forEach(room => {
                const roomDiv = document.createElement('div');
                roomDiv.style.display = 'flex';
                roomDiv.style.alignItems = 'center';
                roomDiv.style.margin = '8px 0';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `room-${room.codigo}`;
                checkbox.value = JSON.stringify({
                    descricao: room.descricao,
                    total: room.total,
                    valorMedio: room.valorMedio,
                    disponivel: true,
                    codigo: room.codigo
                });
                checkbox.style.marginRight = '10px';

                const label = document.createElement('label');
                label.htmlFor = `room-${room.codigo}`;
                label.textContent = `${room.descricao} (${formatCurrency(room.valorMedio)})`;
                label.style.flex = '1';

                roomDiv.appendChild(checkbox);
                roomDiv.appendChild(label);
                roomsContainer.appendChild(roomDiv);
            });

            // Restante do c√≥digo permanece igual...
            const addButton = document.createElement('button');
            addButton.id = 'addToQuoteBtn';
            addButton.className = 'quote-button';
            addButton.textContent = '‚ûï Incluir ao or√ßamento';
            addButton.style.marginTop = '10px';
            addButton.style.width = '100%';

            addButton.addEventListener('click', function () {
                const checkboxes = document.querySelectorAll('#roomsContainer input[type="checkbox"]:checked');

                if (checkboxes.length === 0) {
                    alert('Por favor, selecione pelo menos uma acomoda√ß√£o.');
                    return;
                }

                checkboxes.forEach(checkbox => {
                    try {
                        const selectedRoom = JSON.parse(checkbox.value);
                        askForAdditionalRoom(selectedRoom, startDate, endDate, adults, hasChildren, childAge1, childAge2);
                    } catch (e) {
                        console.error('Erro ao processar sele√ß√£o de quarto:', e);
                    }
                });

                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            });

            roomSelectionSection.appendChild(addButton);
        }

        function askForAdditionalRoom(selectedRoom, startDate, endDate, adults, hasChildren, childAge1, childAge2) {
            // Verificar disponibilidade antes de adicionar
            const roomCode = selectedRoom.codigo;
            const datesToCheck = getDatesBetween(startDate, endDate);

            // Verificar se h√° disponibilidade para todas as datas
            const hasAvailability = datesToCheck.every(date => {
                return currentAvailabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode] &&
                       currentAvailabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode].diaria[date] > 0;
            });

            if (!hasAvailability) {
                const quoteResultContainer = document.getElementById('quoteResultContainer');
                quoteResultContainer.innerHTML = showError("N√£o h√° mais disponibilidade para esta acomoda√ß√£o nas datas selecionadas.").outerHTML;
                quoteResultContainer.style.display = 'block';
                return;
            }

            // Adicionar ao or√ßamento
            selectedRooms.push({
                room: selectedRoom,
                startDate,
                endDate,
                adults,
                hasChildren,
                childrenCount: hasChildren ? parseInt(document.getElementById('hasChildren').value) : 0,
                childAge1,
                childAge2
            });

            // Desabilitar campos de data ap√≥s adicionar a primeira acomoda√ß√£o
            if (selectedRooms.length === 1) {
                disableDateInputs();
            }

            // Atualizar disponibilidade
            updateAvailabilityAfterSelection(roomCode);

            // Obter disponibilidade atualizada para todas as acomoda√ß√µes
            const roomTypes = [
                { name: "Apartamento Superior", code: "SUP" },
                { name: "Su√≠te S√™nior", code: "SEN" },
                { name: "Su√≠te Master (Cobertura)", code: "MAS" }
            ];

            // Criar pr√©via do carrinho de compras
            let cartPreview = `
                <div style="background: #f8f9fa; border-left: 4px solid #075e54; padding: 10px; margin: 10px 0; border-radius: 4px;">
                    <p style="font-weight: bold; margin-bottom: 5px;">üõí Seu Or√ßamento Parcial</p>
                    <div style="max-height: 200px; overflow-y: auto;">
            `;

            selectedRooms.forEach((room, index) => {
                const nights = Math.ceil((new Date(room.endDate) - new Date(room.startDate)) / (1000 * 60 * 60 * 24));
                const total = room.room.valorMedio * nights;

                cartPreview += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee;">
                        <div>
                            <p style="margin: 0; font-size: 14px;"><strong>${index + 1}. ${room.room.descricao}</strong></p>
                            <p style="margin: 0; font-size: 12px;">${room.adults} adulto(s)${room.hasChildren ? ` + ${room.childrenCount} crian√ßa(s)` : ''}</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="margin: 0; font-size: 14px;">${formatCurrency(total)}</p>
                            <p style="margin: 0; font-size: 12px;">${nights} noite(s)</p>
                        </div>
                    </div>
                `;
            });

            cartPreview += `
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                        <p style="margin: 0; font-weight: bold;">Subtotal:</p>
                        <p style="margin: 0; font-weight: bold;">${formatCurrency(selectedRooms.reduce((sum, room) => {
                            const nights = Math.ceil((new Date(room.endDate) - new Date(room.startDate)) / (1000 * 60 * 60 * 24));
                            return sum + (room.room.valorMedio * nights);
                        }, 0))}</p>
                    </div>
                </div>
            `;

            let availabilityMessage = '<div style="background: #f8f9fa; border-left: 4px solid #075e54; padding: 10px; margin: 10px 0; border-radius: 4px;">';
            availabilityMessage += '<p style="font-weight: bold; margin-bottom: 5px;">üìä Disponibilidade restante para o per√≠odo:</p>';

            roomTypes.forEach(roomType => {
                const minAvailability = Math.min(
                    ...datesToCheck.map(date => {
                        const roomData = currentAvailabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomType.code];
                        return roomData ? (roomData.diaria[date] || 0) : 0;
                    })
                );

                if (minAvailability > 0) {
                    availabilityMessage += `<p style="margin: 3px 0;">${roomType.name}: <strong>${minAvailability} unidade(s)</strong></p>`;
                } else {
                    availabilityMessage += `<p style="margin: 3px 0; color: #999;">${roomType.name}: <strong>0 unidades</strong></p>`;
                }
            });

            availabilityMessage += '</div>';

            const questionDiv = document.createElement('div');

            if (roomTypes.every(rt => {
                const minAvail = Math.min(...datesToCheck.map(date => {
                    const rd = currentAvailabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[rt.code];
                    return rd ? (rd.diaria[date] || 0) : 0;
                }));
                return minAvail <= 0;
            })) {
                // Caso n√£o haja mais disponibilidade
                questionDiv.innerHTML = `
                    ${cartPreview}
                    <hr style="margin: 15px 0; border: 1px solid rgba(255,255,255,0.3);">
                    <div style="background: #fff8e1; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <p>‚ö†Ô∏è <strong>N√£o h√° mais disponibilidade para o per√≠odo solicitado.</strong></p>
                        <p>‚ö†Ô∏è <strong>√öltima unidade dispon√≠vel para o per√≠odo solicitado.</strong></p>
                    </div>
                    <div class="quick-actions">
                        <button class="quick-action" id="finishReservationBtn">Gerar Or√ßamento</button>
                    </div>
                `;
            } else {
                // Caso ainda haja disponibilidade
                questionDiv.innerHTML = `
                    ${cartPreview}
                    ${availabilityMessage}
                    <hr style="margin: 15px 0; border: 1px solid rgba(255,255,255,0.3);">
                    <p>Deseja incluir outra acomoda√ß√£o √† sua reserva?</p>
                    <div class="quick-actions">
                        <button class="quick-action" id="addAnotherRoomBtn">Sim</button>
                        <button class="quick-action" id="finishReservationBtn">N√£o, finalizar</button>
                    </div>
                `;
            }

            const quoteResultContainer = document.getElementById('quoteResultContainer');
            quoteResultContainer.innerHTML = '';
            quoteResultContainer.appendChild(questionDiv);
            quoteResultContainer.style.display = 'block';

            // Configurar listeners dos bot√µes
            const addAnotherBtn = document.getElementById('addAnotherRoomBtn');
            if (addAnotherBtn) {
                addAnotherBtn.addEventListener('click', () => {
                    quoteResultContainer.style.display = 'none';
                });
            }

            document.getElementById('finishReservationBtn').addEventListener('click', () => {
                showFinalQuote();
            });
        }

        function updateAvailabilityAfterSelection(roomCode) {
            if (!currentAvailabilityData || !roomCode) return;

            // Registrar estado anterior no hist√≥rico
            const beforeUpdate = JSON.parse(JSON.stringify(currentAvailabilityData));

            const datesToUpdate = getDatesBetween(
                document.getElementById('checkinDate').value,
                document.getElementById('checkoutDate').value
            );

            datesToUpdate.forEach(date => {
                if (currentAvailabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode] &&
                    currentAvailabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode].diaria[date] > 0) {
                    currentAvailabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode].diaria[date] -= 1;
                }
            });

            // Registrar no hist√≥rico
            availabilityHistory.push({
                timestamp: new Date(),
                action: `Reserva de ${roomCode}`,
                before: beforeUpdate,
                after: JSON.parse(JSON.stringify(currentAvailabilityData))
            });

            // Atualizar imediatamente as op√ß√µes de quarto dispon√≠veis
            updateRoomOptions();
        }

        function showFinalQuote() {
            if (selectedRooms.length === 0) return;

            const quoteResultContainer = document.getElementById('quoteResultContainer');
            const startDate = selectedRooms[0].startDate;
            const endDate = selectedRooms[0].endDate;

            const start = new Date(startDate);
            const end = new Date(endDate);
            const offset = start.getTimezoneOffset();
            start.setMinutes(start.getMinutes() + offset);
            end.setMinutes(end.getMinutes() + offset);
            const nights = Math.ceil((end - start) / (1000 * 60 * 60 * 24));

            let totalRooms = 0;
            let totalExtraGuests = 0;
            let roomsDescription = '';

            selectedRooms.forEach((reservation, index) => {
                const room = reservation.room;
                const adults = reservation.adults;
                const hasChildren = reservation.hasChildren;
                const childrenCount = reservation.childrenCount;
                const childAge1 = reservation.childAge1;
                const childAge2 = reservation.childrenCount === 2 ? reservation.childAge2 : 0;

                const dailyRate = room.valorMedio;

                let extraGuestFee = 0;
                let extraGuestMessage = '';

                if (hasChildren) {
                    const totalPayingGuests = adults + (childAge1 > 6 ? 1 : 0) + (childrenCount === 2 && childAge2 > 6 ? 1 : 0);

                    if (totalPayingGuests > 2) {
                        const extraGuests = totalPayingGuests - 2;
                        extraGuestFee = 102 * nights * extraGuests;

                        const childAges = [];
                        if (childAge1 > 6) childAges.push(childAge1);
                        if (childrenCount === 2 && childAge2 > 6) childAges.push(childAge2);

                        if (childAges.length > 0) {
                            extraGuestMessage = `<p><strong>üë∂ Crian√ßa(s) (${childAges.join(' e ')} anos):</strong> ${formatCurrency(extraGuestFee)} (R$ 102/dia por h√≥spede extra acima do limite de 2)</p>`;
                        }
                    }
                } else if (adults > 2) {
                    extraGuestFee = 102 * nights;
                    extraGuestMessage = `<p><strong>üë• H√≥spede extra:</strong> ${formatCurrency(extraGuestFee)} (R$ 102/dia)</p>`;
                }

                totalRooms += (dailyRate * nights);
                totalExtraGuests += extraGuestFee;

                roomsDescription += `
                    <hr class="accommodation-divider">
                    <div style="margin-bottom: 15px; padding-bottom: 15px;">
                        <p><strong>üè® Acomoda√ß√£o ${index + 1}:</strong> ${room.descricao}</p>
                        <p><strong>üë• H√≥spedes:</strong> ${adults} adulto(s)${hasChildren ? ` + ${childrenCount} crian√ßa(s) (${childAge1}${childrenCount === 2 ? ` e ${childAge2}` : ''} anos)` : ''}</p>
                        <p><strong>üí∞ Di√°ria:</strong> ${formatCurrency(dailyRate)}</p>
                        ${extraGuestMessage}
                    </div>
                `;
            });

            const subtotal = totalRooms + totalExtraGuests;
            const total = subtotal;

            const formatDisplayDate = (dateString) => {
                const date = new Date(dateString);
                date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
                return date.toLocaleDateString('pt-BR');
            };

            quoteResultContainer.innerHTML = `
                <div class="quote-result">
                    <h3>üìã Seu Or√ßamento Final - Hotel Granja Brasil</h3>
                    <hr style="margin: 15px 0; border: 1px solid rgba(255,255,255,0.3);">
                    <p><strong>üìÖ Per√≠odo:</strong> ${formatDisplayDate(startDate)} a ${formatDisplayDate(endDate)}</p>
                    <p><strong>üåô Noites:</strong> ${nights}</p>

                    ${roomsDescription}

                    <hr style="margin: 15px 0; border: 1px solid rgba(255,255,255,0.3);">
                    <p><strong>üíµ Subtotal Acomoda√ß√µes:</strong> ${formatCurrency(totalRooms)}</p>
                    <p><strong>üë• Taxas de H√≥spedes Extras:</strong> ${formatCurrency(totalExtraGuests)}</p>
                    <h4 style="font-size: 20px; margin-top: 10px;"><strong>üéØ TOTAL: ${formatCurrency(total)}</strong></h4>

                    <p style="margin-top: 15px; font-size: 14px; opacity: 0.9;">
                        * ${HOTEL_CONFIG.politicas.cancelamento}<br>
                        * ${HOTEL_CONFIG.politicas.criancas}<br>
                        * ${HOTEL_CONFIG.politicas.hospedeExtra}
                    </p>

                    <div class="form-group" style="margin-top: 20px;">
                        <input type="text" id="customerName" placeholder="Seu nome completo">
                    </div>

                    <button id="whatsappBtn" class="whatsapp-button">
                        ‚úÖ Fechar Reserva via WhatsApp
                    </button>
                </div>
            `;

            currentQuoteData = {
                rooms: selectedRooms,
                startDate,
                endDate,
                nights,
                totalRooms,
                totalExtraGuests,
                total
            };

            setupButtonListeners();
        }

        function sendQuoteToWhatsApp() {
            if (!currentQuoteData) return;

            const customerName = document.getElementById('customerName').value;
            if (!customerName) {
                alert('Por favor, informe seu nome completo para prosseguir com a reserva.');
                return;
            }

            currentQuoteData.customerName = customerName;

            let roomsDescription = '';
            currentQuoteData.rooms.forEach((reservation, index) => {
                const room = reservation.room;
                const adults = reservation.adults;
                const hasChildren = reservation.hasChildren;
                const childrenCount = reservation.childrenCount;
                const childAge1 = reservation.childAge1;
                const childAge2 = reservation.childrenCount === 2 ? reservation.childAge2 : 0;

                let extraGuestMessage = '';
                if (hasChildren) {
                    const totalPayingGuests = adults + (childAge1 > 6 ? 1 : 0) + (childrenCount === 2 && childAge2 > 6 ? 1 : 0);

                    if (totalPayingGuests > 2) {
                        const extraGuests = totalPayingGuests - 2;
                        const extraGuestFee = 102 * currentQuoteData.nights * extraGuests;

                        const childAges = [];
                        if (childAge1 > 6) childAges.push(childAge1);
                        if (childrenCount === 2 && childAge2 > 6) childAges.push(childAge2);

                        if (childAges.length > 0) {
                            extraGuestMessage = `\nüë∂ *Crian√ßa(s) (${childAges.join(' e ')} anos):* ${formatCurrency(extraGuestFee)} (h√≥spede extra)`;
                        }
                    }
                } else if (adults > 2) {
                    const extraGuestFee = 102 * currentQuoteData.nights;
                    extraGuestMessage = `\nüë• *H√≥spede extra:* ${formatCurrency(extraGuestFee)}`;
                }

                roomsDescription += `
üè® *Acomoda√ß√£o ${index + 1}:* ${room.descricao}
üë• *H√≥spedes:* ${adults} adulto(s)${hasChildren ? ` + ${childrenCount} crian√ßa(s) (${childAge1}${childrenCount === 2 ? ` e ${childAge2}` : ''} anos)` : ''}
üí∞ *Di√°ria:* ${formatCurrency(room.valorMedio)}${extraGuestMessage}

`;
            });

            const message = `
üè® *SOLICITA√á√ÉO DE RESERVA - HOTEL GRANJA BRASIL*

üë§ *Cliente:* ${currentQuoteData.customerName}

üìÖ *Check-in:* ${formatDisplayDate(currentQuoteData.startDate)}
üìÖ *Check-out:* ${formatDisplayDate(currentQuoteData.endDate)}
üåô *Noites:* ${currentQuoteData.nights}

${roomsDescription}
üí∞ *VALORES:*
‚Ä¢ Subtotal Acomoda√ß√µes: ${formatCurrency(currentQuoteData.totalRooms)}
‚Ä¢ Taxas de H√≥spedes Extras: ${formatCurrency(currentQuoteData.totalExtraGuests)}
‚Ä¢ *TOTAL: ${formatCurrency(currentQuoteData.total)}*

üìù Cliente interessado em fechar a reserva!
            `.trim();

            openWhatsApp(message);
        }

        function formatDisplayDate(dateString) {
            const date = new Date(dateString);
            date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
            return date.toLocaleDateString('pt-BR');
        }

        function openWhatsApp(message) {
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${HOTEL_CONFIG.whatsappNumber.replace(/\D/g, '')}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }

        function sendCorporateEmail() {
            const subject = encodeURIComponent('Solicita√ß√£o de Reserva Corporativa - Hotel Granja Brasil');
            const body = encodeURIComponent(`
Ol√°,

Gostaria de solicitar informa√ß√µes sobre reservas corporativas no Hotel Granja Brasil.

Por favor, entrem em contato para discutirmos:
- Datas pretendidas
- N√∫mero de colaboradores
- Tipo de acomoda√ß√µes necess√°rias
- Condi√ß√µes especiais para grupos corporativos

Aguardo retorno.

Atenciosamente,
[Seu nome]
[Sua empresa]
[Seu telefone]
            `.trim());

            const mailtoUrl = `mailto:${HOTEL_CONFIG.emailCorporativo}?subject=${subject}&body=${body}`;
            window.open(mailtoUrl, '_blank');

            showTyping();
            setTimeout(() => {
                hideTyping();
                addMessage(`
                    <p>üìß <strong>Solicita√ß√£o de Reserva Corporativa enviada!</strong></p>
                    <p>Seu email foi direcionado para: <strong>${HOTEL_CONFIG.emailCorporativo}</strong></p>
                    <p>Nossa equipe comercial entrar√° em contato em breve para apresentar as melhores condi√ß√µes para sua empresa.</p>
                    <p>Para informa√ß√µes mais r√°pidas, voc√™ tamb√©m pode entrar em contato via WhatsApp:</p>
                    <button class="whatsapp-button" onclick="openWhatsApp('Ol√°! Tenho interesse em reservas corporativas para o Hotel Granja Brasil.')">
                        üí¨ WhatsApp Comercial
                    </button>
                `);
            }, 1000);
        }

        // ========= FUN√á√ÉO PRINCIPAL PARA ENVIAR MENSAGENS =========
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            // Verificar se √© uma mensagem de or√ßamento/reserva
            const lowerMessage = message.toLowerCase();
            const isQuoteRelated = lowerMessage.includes('or√ßamento') || 
                                  lowerMessage.includes('pre√ßo') || 
                                  lowerMessage.includes('valor') || 
                                  lowerMessage.includes('reserva') ||
                                  lowerMessage.includes('disponibilidade') ||
                                  lowerMessage.includes('tarifa') ||
                                  lowerMessage.includes('quarto') ||
                                  lowerMessage.includes('acomoda√ß√£o');

            addMessage(message, true);
            input.value = '';

            if (isQuoteRelated) {
                // Usar o processamento local para or√ßamentos
                showTyping();
                setTimeout(() => {
                    const response = generateQuoteForm();
                    hideTyping();
                    addMessage(response);
                }, 800);
            } else {
                // Usar a IA para outras perguntas
                showTyping();
                
                try {
                    const aiResponse = await callHotelAI(message);
                    hideTyping();
                    
                    // Usar a nova fun√ß√£o com digita√ß√£o humana
                    await addMessageWithHumanTyping(aiResponse);
                } catch (error) {
                    hideTyping();
                    addMessage(`
                        <p>Desculpe, ocorreu um erro ao processar sua mensagem.</p>
                        <p>Voc√™ pode:</p>
                        <div class="quick-actions">
                            <button class="quick-action" data-action="solicitar-orcamento">üí∞ Solicitar Or√ßamento</button>
                            <button class="quick-action" onclick="openWhatsApp('Ol√°, preciso de ajuda com o Hotel Granja Brasil')">
                                üí¨ WhatsApp
                            </button>
                        </div>
                    `);
                }
            }
        }

        // ========= FUN√á√ÉO ORIGINAL processUserMessage =========
        async function processUserMessage(message) {
            const lowerMessage = message.toLowerCase();

            if (lowerMessage.includes('or√ßamento') || lowerMessage.includes('pre√ßo') || lowerMessage.includes('valor') || lowerMessage.includes('tarifa')) {
                return generateQuoteForm();
            }

            if (lowerMessage.includes('localiza√ß√£o') || lowerMessage.includes('endere√ßo') || lowerMessage.includes('onde fica')) {
                return `
                    <p><strong>üìç Localiza√ß√£o Privilegiada</strong></p>
                    <p><strong>${HOTEL_CONFIG.localizacao}</strong></p>
                    <p>üç¥ <strong>Proximidade aos melhores restaurantes da regi√£o</strong> - ideal para quem busca tranquilidade sem abrir m√£o do f√°cil acesso √† gastronomia local.</p>
                    <p>üöó <strong>Estacionamento Gratuito:</strong> Coberto (mediante disponibilidade) ou descoberto.</p>
                    <div class="quick-actions">
                        <button class="quick-action" data-action="solicitar-orcamento">üí∞ Solicitar Or√ßamento</button>
                    </div>
                `;
            }

            if (lowerMessage.includes('servi√ßo') || lowerMessage.includes('facilidade') || lowerMessage.includes('comodidade') || lowerMessage.includes('lazer')) {
                return `
                    <p><strong>üåü Lazer para Todos os Perfis</strong></p>
                    <p>Desfrute de nossa infraestrutura exclusiva:</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        ${HOTEL_CONFIG.servicos.map(servico => `<li>‚úÖ ${servico}</li>`).join('')}
                    </ul>
                    <p><strong>‚è∞ Hor√°rio da Piscina:</strong> ${HOTEL_CONFIG.horarios.piscina}</p>
                    <div class="quick-actions">
                        <button class="quick-action" data-action="solicitar-orcamento">üí∞ Fazer Or√ßamento</button>
                    </div>
                `;
            }

            if (lowerMessage.includes('contato') || lowerMessage.includes('telefone') || lowerMessage.includes('whatsapp')) {
                return `
                    <p><strong>üìû Entre em Contato</strong></p>
                    <p>WhatsApp: <strong>${HOTEL_CONFIG.whatsappNumber}</strong></p>
                    <p><strong>‚è∞ Hor√°rios de Atendimento:</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Recep√ß√£o:</strong> ${HOTEL_CONFIG.horarios.recepcao}</li>
                        <li><strong>Governan√ßa:</strong> ${HOTEL_CONFIG.horarios.governanca}</li>
                    </ul>
                    <button id="initialWhatsappBtn" class="whatsapp-button">
                        üí¨ Chamar no WhatsApp
                    </button>
                `;
            }

            if (lowerMessage.includes('pol√≠tica') || lowerMessage.includes('regra') || lowerMessage.includes('cancelamento') || lowerMessage.includes('crian√ßa')) {
                return `
                    <p><strong>üìã Pol√≠ticas do Hotel</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>‚úÖ <strong>Cancelamento:</strong> ${HOTEL_CONFIG.politicas.cancelamento}</li>
                        <li>üë∂ <strong>Crian√ßas:</strong> ${HOTEL_CONFIG.politicas.criancas}</li>
                        <li>üë• <strong>H√≥spedes Extras:</strong> ${HOTEL_CONFIG.politicas.hospedeExtra}</li>
                        <li>üö≠ <strong>Ambiente:</strong> ${HOTEL_CONFIG.politicas.fumante}</li>
                        <li>üêï <strong>Animais:</strong> ${HOTEL_CONFIG.politicas.animais}</li>
                        <li>üìã <strong>Atestado M√©dico:</strong> ${HOTEL_CONFIG.politicas.atestatMedico}</li>
                    </ul>
                    <div class="quick-actions">
                        <button class="quick-action" data-action="solicitar-orcamento">üí∞ Fazer Or√ßamento</button>
                    </div>
                `;
            }

            if (lowerMessage.includes('hor√°rio') || lowerMessage.includes('check') || lowerMessage.includes('piscina')) {
                return `
                    <p><strong>‚è∞ Hor√°rios de Funcionamento</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Check-in:</strong> ${HOTEL_CONFIG.horarios.checkin}</li>
                        <li><strong>Check-out:</strong> ${HOTEL_CONFIG.horarios.checkout}</li>
                        <li><strong>Recep√ß√£o:</strong> ${HOTEL_CONFIG.horarios.recepcao}</li>
                        <li><strong>Governan√ßa:</strong> ${HOTEL_CONFIG.horarios.governanca}</li>
                        <li><strong>Piscina:</strong> ${HOTEL_CONFIG.horarios.piscina}</li>
                    </ul>
                    <div class="quick-actions">
                        <button class="quick-action" data-action="solicitar-orcamento">üí∞ Solicitar Or√ßamento</button>
                    </div>
                `;
            }

            if (lowerMessage.includes('informa√ß√£o') || lowerMessage.includes('sobre') || lowerMessage.includes('hotel')) {
                return `
                    <div style="background: #f8f9fa; border-radius: 8px; overflow: hidden; margin: 15px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="background: #075e54; color: white; padding: 12px 15px;">
                            <h3 style="margin: 0; font-size: 18px;">üè® Nossas Acomoda√ß√µes</h3>
                        </div>

                        <div style="padding: 15px;">
                            <!-- Apartamento Superior -->
                            <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <div style="background: #128c7e; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                                        üõèÔ∏è
                                    </div>
                                    <h4 style="margin: 0; color: #075e54;">Apartamento Superior</h4>
                                </div>

                                <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                    <div style="flex: 1; min-width: 200px;">
                                        <p style="margin: 5px 0; color: #555;"><strong>üë• Capacidade:</strong> At√© 2 pessoas</p>
                                        <p style="margin: 5px 0; color: #555;"><strong>üìè √Årea:</strong> 26 m¬≤</p>
                                        <p style="margin: 5px 0; color: #555;"><strong>üõå Camas:</strong> 2 camas separadas (padr√£o vi√∫va)</p>
                                    </div>

                                    <div style="flex: 1; min-width: 200px;">
                                        <p style="margin: 5px 0; color: #555;"><strong>üåü Destaques:</strong></p>
                                        <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                            <li>Ideal para solteiros</li>
                                            <li>Mesa de trabalho</li>
                                        </ul>
                                    </div>

                                    <div style="flex: 1; min-width: 200px;">
                                        <p style="margin: 5px 0; color: #555;"><strong>üõÅ Comodidades:</strong></p>
                                        <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                            <li>Ar-condicionado</li>
                                            <li>Frigobar</li>
                                            <li>Secador de cabelos</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Su√≠te S√™nior -->
                            <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <div style="background: #128c7e; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                                        üõãÔ∏è
                                    </div>
                                    <h4 style="margin: 0; color: #075e54;">Su√≠te S√™nior</h4>
                                </div>

                                <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                    <div style="flex: 1; min-width: 200px;">
                                        <p style="margin: 5px 0; color: #555;"><strong>üë• Capacidade:</strong> At√© 3 pessoas</p>
                                        <p style="margin: 5px 0; color: #555;"><strong>üìè √Årea:</strong> 41 m¬≤</p>
                                        <p style="margin: 5px 0; color: #555;"><strong>üõå Camas:</strong> 1 cama King Size + sof√°-cama</p>
                                    </div>

                                    <div style="flex: 1; min-width: 200px;">
                                        <p style="margin: 5px 0; color: #555;"><strong>üåü Destaques:</strong></p>
                                        <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                            <li>Conforto ampliado</li>
                                            <li>Sala com sof√°-cama</li>
                                            <li>Mesa de trabalho</li>
                                        </ul>
                                    </div>

                                    <div style="flex: 1; min-width: 200px;">
                                        <p style="margin: 5px 0; color: #555;"><strong>üõÅ Comodidades:</strong></p>
                                        <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                            <li>Ar-condicionado</li>
                                            <li>Frigobar</li>
                                            <li>Microondas</li>
                                            <li>Pia</li>
                                            <li>Sacada</li>
                                            <li>Secador de cabelos</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Su√≠te Master -->
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <div style="background: #128c7e; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                                        üåü
                                    </div>
                                    <h4 style="margin: 0; color: #075e54;">Su√≠te Master (Cobertura)</h4>
                                </div>

                                <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                    <div style="flex: 1; min-width: 200px;">
                                        <p style="margin: 5px 0; color: #555;"><strong>üë• Capacidade:</strong> At√© 3 pessoas</p>
                                        <p style="margin: 5px 0; color: #555;"><strong>üìè √Årea:</strong> 56 m¬≤</p>
                                        <p style="margin: 5px 0; color: #555;"><strong>üõå Camas:</strong> 1 cama King Size + sof√°-cama</p>
                                    </div>

                                    <div style="flex: 1; min-width: 200px;">
                                        <p style="margin: 5px 0; color: #555;"><strong>üåü Destaques:</strong></p>
                                        <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                            <li>Vista privilegiada</li>
                                            <li>Varanda espa√ßosa</li>
                                            <li>Mesa de trabalho</li>
                                        </ul>
                                    </div>

                                    <div style="flex: 1; min-width: 200px;">
                                        <p style="margin: 5px 0; color: #555;"><strong>üõÅ Comodidades:</strong></p>
                                        <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                            <li>Ar-condicionado</li>
                                            <li>Frigobar</li>
                                            <li>Microondas</li>
                                            <li>Pia</li>
                                            <li>Varanda</li>
                                            <li>Secador de cabelos</li>
                                        </ul>
                                        <p style="margin: 5px 0; color: #555;"><strong>‚ö†Ô∏è Observa√ß√£o:</strong> Acesso por escada (15 degraus)</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="background: #f0f8ff; padding: 12px 15px; border-top: 1px solid #e0e0e0;">
                            <div class="quick-actions">
                                <button class="quick-action" data-action="solicitar-orcamento" style="background: #075e54; color: white;">
                                    üí∞ Solicitar Or√ßamento
                                </button>
                                <button class="quick-action" data-action="politicas">
                                    üìã Ver Pol√≠ticas
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Para perguntas que n√£o sejam sobre reservas/or√ßamentos, usar a IA
            showTyping();
            try {
                const aiResponse = await callHotelAI(message);
                hideTyping();
                
                // Usar a nova fun√ß√£o com digita√ß√£o humana
                await addMessageWithHumanTyping(aiResponse);
                return aiResponse;
            } catch (error) {
                hideTyping();
                return `
                    <p>Entendi! Estou aqui para ajud√°-lo com informa√ß√µes sobre o Hotel Granja Brasil.</p>
                    <p>Posso ajud√°-lo com:</p>
                    <div class="quick-actions">
                        <button class="quick-action" data-action="solicitar-orcamento">üí∞ Or√ßamento</button>
                        <button class="quick-action" data-action="informacoes-hotel">üè® Informa√ß√µes</button>
                        <button class="quick-action" data-action="contato">üìû Contato</button>
                    </div>
                `;
            }
        }

        // ========= FUN√á√ÉO ORIGINAL handleQuickAction =========
        async function handleQuickAction(action) {
            if (isProcessingQuickAction) return;
            isProcessingQuickAction = true;

            let response = '';

            try {
                switch(action) {
                    case 'solicitar-orcamento':
                        if (currentQuoteData || selectedRooms.length > 0) {
                            location.reload();
                            return;
                        }
                        response = generateQuoteForm();
                        break;
                    case 'informacoes-hotel':
                        response = `
                            <div style="background: #f8f9fa; border-radius: 8px; overflow: hidden; margin: 15px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <div style="background: #075e54; color: white; padding: 12px 15px;">
                                    <h3 style="margin: 0; font-size: 18px;">üè® Hotel Granja Brasil</h3>
                                </div>

                                <div style="padding: 15px;">
                                    <p><em>Descubra Conforto, Lazer e Sofistica√ß√£o no Cora√ß√£o de Itaipava</em></p>

                                    <hr style="border: 0; height: 1px; background: #eee; margin: 15px 0;">

                                    <p><strong>üìç Localiza√ß√£o:</strong> ${HOTEL_CONFIG.localizacao}</p>

                                    <hr style="border: 0; height: 1px; background: #eee; margin: 15px 0;">

                                    <!-- Apartamento Superior -->
                                    <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                            <div style="background: #128c7e; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                                                üõèÔ∏è
                                            </div>
                                            <h4 style="margin: 0; color: #075e54;">Apartamento Superior</h4>
                                        </div>

                                        <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                            <div style="flex: 1; min-width: 200px;">
                                                <p style="margin: 5px 0; color: #555;"><strong>üë• Capacidade:</strong> At√© 2 pessoas</p>
                                                <p style="margin: 5px 0; color: #555;"><strong>üìè √Årea:</strong> 26 m¬≤</p>
                                                <p style="margin: 5px 0; color: #555;"><strong>üõå Camas:</strong> 2 camas separadas (padr√£o vi√∫va)</p>
                                            </div>

                                            <div style="flex: 1; min-width: 200px;">
                                                <p style="margin: 5px 0; color: #555;"><strong>üåü Destaques:</strong></p>
                                                <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                                    <li>Ideal para solteiros</li>
                                                    <li>Mesa de trabalho</li>
                                                </ul>
                                            </div>

                                            <div style="flex: 1; min-width: 200px;">
                                                <p style="margin: 5px 0; color: #555;"><strong>üõÅ Comodidades:</strong></p>
                                                <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                                    <li>Ar-condicionado</li>
                                                    <li>Frigobar</li>
                                                    <li>Secador de cabelos</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Su√≠te S√™nior -->
                                    <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                            <div style="background: #128c7e; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                                                üõãÔ∏è
                                            </div>
                                            <h4 style="margin: 0; color: #075e54;">Su√≠te S√™nior</h4>
                                        </div>

                                        <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                            <div style="flex: 1; min-width: 200px;">
                                                <p style="margin: 5px 0; color: #555;"><strong>üë• Capacidade:</strong> At√© 3 pessoas</p>
                                                <p style="margin: 5px 0; color: #555;"><strong>üìè √Årea:</strong> 41 m¬≤</p>
                                                <p style="margin: 5px 0; color: #555;"><strong>üõå Camas:</strong> 1 cama King Size + sof√°-cama</p>
                                            </div>

                                            <div style="flex: 1; min-width: 200px;">
                                                <p style="margin: 5px 0; color: #555;"><strong>üåü Destaques:</strong></p>
                                                <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                                    <li>Conforto ampliado</li>
                                                    <li>Sala com sof√°-cama</li>
                                                    <li>Mesa de trabalho</li>
                                                </ul>
                                            </div>

                                            <div style="flex: 1; min-width: 200px;">
                                                <p style="margin: 5px 0; color: #555;"><strong>üõÅ Comodidades:</strong></p>
                                                <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                                    <li>Ar-condicionado</li>
                                                    <li>Frigobar</li>
                                                    <li>Microondas</li>
                                                    <li>Pia</li>
                                                    <li>Sacada</li>
                                                    <li>Secador de cabelos</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Su√≠te Master -->
                                    <div style="margin-bottom: 10px;">
                                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                            <div style="background: #128c7e; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                                                üåü
                                            </div>
                                            <h4 style="margin: 0; color: #075e54;">Su√≠te Master (Cobertura)</h4>
                                        </div>

                                        <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                            <div style="flex: 1; min-width: 200px;">
                                                <p style="margin: 5px 0; color: #555;"><strong>üë• Capacidade:</strong> At√© 3 pessoas</p>
                                                <p style="margin: 5px 0; color: #555;"><strong>üìè √Årea:</strong> 56 m¬≤</p>
                                                <p style="margin: 5px 0; color: #555;"><strong>üõå Camas:</strong> 1 cama King Size + sof√°-cama</p>
                                            </div>

                                            <div style="flex: 1; min-width: 200px;">
                                                <p style="margin: 5px 0; color: #555;"><strong>üåü Destaques:</strong></p>
                                                <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                                    <li>Vista privilegiada</li>
                                                    <li>Varanda espa√ßosa</li>
                                                    <li>Mesa de trabalho</li>
                                                </ul>
                                            </div>

                                            <div style="flex: 1; min-width: 200px;">
                                                <p style="margin: 5px 0; color: #555;"><strong>üõÅ Comodidades:</strong></p>
                                                <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                                    <li>Ar-condicionado</li>
                                                    <li>Frigobar</li>
                                                    <li>Microondas</li>
                                                    <li>Pia</li>
                                                    <li>Varanda</li>
                                                    <li>Secador de cabelos</li>
                                                </ul>
                                                <p style="margin: 5px 0; color: #555;"><strong>‚ö†Ô∏è Observa√ß√£o:</strong> Acesso por escada (15 degraus)</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div style="background: #f0f8ff; padding: 12px 15px; border-top: 1px solid #e0e0e0;">
                                    <div class="quick-actions">
                                        <button class="quick-action" data-action="servicos">üåü Servi√ßos</button>
                                        <button class="quick-action" data-action="politicas">üìã Pol√≠ticas</button>
                                        <button class="quick-action" data-action="solicitar-orcamento">üí∞ Or√ßamento</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        break;
                    case 'servicos':
                        response = `
                            <p><strong>üåü Lazer e Servi√ßos</strong></p>
                            <p>Desfrute de nossa infraestrutura exclusiva:</p>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                ${HOTEL_CONFIG.servicos.map(servico => `<li>‚úÖ ${servico}</li>`).join('')}
                            </ul>

                            <p><strong>‚è∞ Hor√°rio da Piscina:</strong> ${HOTEL_CONFIG.horarios.piscina}</p>

                            <div class="quick-actions">
                                <button class="quick-action" data-action="informacoes-hotel">üè® Sobre o Hotel</button>
                                <button class="quick-action" data-action="solicitar-orcamento">üí∞ Fazer Or√ßamento</button>
                            </div>
                        `;
                        break;
                    case 'politicas':
                        response = `
                            <p><strong>üìã Pol√≠ticas do Hotel</strong></p>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>‚úÖ <strong>Check-in:</strong> ${HOTEL_CONFIG.horarios.checkin}</li>
                                <li>‚úÖ <strong>Check-out:</strong> ${HOTEL_CONFIG.horarios.checkout}</li>
                                <li>‚úÖ <strong>Cancelamento:</strong> ${HOTEL_CONFIG.politicas.cancelamento}</li>
                                <li>üë∂ <strong>Crian√ßas:</strong> ${HOTEL_CONFIG.politicas.criancas}</li>
                                <li>üë• <strong>H√≥spedes Extras:</strong> ${HOTEL_CONFIG.politicas.hospedeExtra}</li>
                                <li>üö≠ <strong>Ambiente:</strong> ${HOTEL_CONFIG.politicas.fumante}</li>
                                <li>üêï <strong>Animais:</strong> ${HOTEL_CONFIG.politicas.animais}</li>
                                <li>üìã <strong>Atestado M√©dico:</strong> ${HOTEL_CONFIG.politicas.atestatMedico}</li>
                            </ul>

                            <div class="quick-actions">
                                <button class="quick-action" data-action="solicitar-orcamento">üí∞ Fazer Or√ßamento</button>
                            </div>
                        `;
                        break;
                    case 'localizacao':
    response = `
        <p><strong>üìç Localiza√ß√£o Privilegiada</strong></p>
        <p>
            <strong>${HOTEL_CONFIG.localizacao}</strong><br>
            <a href="https://maps.google.com/?daddr=Hotel%20Granja%20Brasil%20Resort" 
               target="_blank" 
               style="color: #075e54; text-decoration: none; font-weight: bold; padding: 4px 8px; border-radius: 4px; background: #f0f8ff; display: inline-block; margin-top: 5px; transition: all 0.2s;"
               onmouseover="this.style.background='#e1f5fe'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'"
               onmouseout="this.style.background='#f0f8ff'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                üó∫Ô∏è Ver no Google Maps
            </a>
        </p>
        <p>üç¥ <strong>Proximidade aos melhores restaurantes da regi√£o</strong></p>
        <p>üöó <strong>Estacionamento Gratuito:</strong> Coberto (mediante disponibilidade) ou descoberto.</p>
        
        <div style="background: #e8f4fd; padding: 12px; border-radius: 8px; margin: 12px 0; font-size: 14px;">
            <p><strong>üìç Como chegar:</strong></p>
            <ul style="margin: 8px 0; padding-left: 20px;">
                <li><strong>De Petr√≥polis:</strong> 20 minutos pela Estrada Uni√£o e Ind√∫stria</li>
                <li><strong>Do Rio de Janeiro:</strong> 1h30 pela BR-040</li>
                <li><strong>De Teres√≥polis:</strong> 40 minutos pela BR-116 e BR-040</li>
            </ul>
        </div>
        
        <div class="quick-actions">
            <button class="quick-action" data-action="solicitar-orcamento">üí∞ Solicitar Or√ßamento</button>
            <button class="quick-action" data-action="informacoes-hotel">üè® Sobre o Hotel</button>
        </div>
    `;
    break;
                    case 'contato':
                        response = `
                            <p><strong>üìû Entre em Contato</strong></p>
                            <p>WhatsApp: <strong>${HOTEL_CONFIG.whatsappNumber}</strong></p>
                            <p>E-mail Corporativo: <strong>${HOTEL_CONFIG.emailCorporativo}</strong></p>

                            <p><strong>‚è∞ Hor√°rios de Atendimento:</strong></p>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li><strong>Recep√ß√£o:</strong> ${HOTEL_CONFIG.horarios.recepcao}</li>
                                <li><strong>Governan√ßa:</strong> ${HOTEL_CONFIG.horarios.governanca}</li>
                            </ul>

                            <button id="initialWhatsappBtn" class="whatsapp-button">
                                üí¨ Chamar no WhatsApp
                            </button>
                        `;
                        break;
                }

                if (response) {
                    showTyping();
                    setTimeout(async () => {
                        hideTyping();
                        // Usar a nova fun√ß√£o com digita√ß√£o humana
                        await addMessageWithHumanTyping(response);
                        isProcessingQuickAction = false;
                    }, 800);
                } else {
                    isProcessingQuickAction = false;
                }
            } catch (error) {
                console.error('Erro ao processar a√ß√£o r√°pida:', error);
                isProcessingQuickAction = false;
            }
        }

        function setupButtonListeners() {
            const sendButton = document.getElementById('sendButton');
            const messageInput = document.getElementById('messageInput');

            // Remover listeners antigos
            sendButton.removeEventListener('click', sendMessage);
            
            // Adicionar novos listeners
            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }

            const checkAvailabilityBtn = document.getElementById('checkAvailabilityBtn');
            if (checkAvailabilityBtn) {
                checkAvailabilityBtn.removeEventListener('click', checkAvailability);
                checkAvailabilityBtn.addEventListener('click', checkAvailability);
            }

            const whatsappBtn = document.getElementById('whatsappBtn');
            if (whatsappBtn) {
                whatsappBtn.removeEventListener('click', sendQuoteToWhatsApp);
                whatsappBtn.addEventListener('click', sendQuoteToWhatsApp);
            }

            const initialWhatsappBtn = document.getElementById('initialWhatsappBtn');
            if (initialWhatsappBtn) {
                initialWhatsappBtn.removeEventListener('click', initialWhatsappClick);
                
                function initialWhatsappClick() {
                    const message = "Ol√°, vim do assistente virtual e gostaria de ter informa√ß√µes a respeito de reservas.";
                    openWhatsApp(message);
                }

                initialWhatsappBtn.addEventListener('click', initialWhatsappClick);
            }

            const corporateBtn = document.getElementById('corporateBtn');
            if (corporateBtn) {
                corporateBtn.removeEventListener('click', sendCorporateEmail);
                corporateBtn.addEventListener('click', sendCorporateEmail);
            }

            // Configurar a√ß√µes r√°pidas
            const quickActions = document.querySelectorAll('.quick-action');
            quickActions.forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);

                newButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    const action = this.getAttribute('data-action');
                    handleQuickAction(action);
                });
            });

            // Configurar tecla Enter
            if (messageInput) {
                messageInput.removeEventListener('keypress', handleEnterKey);
                
                function handleEnterKey(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                }
                
                messageInput.addEventListener('keypress', handleEnterKey);
            }
        }

        // Iniciar atualiza√ß√£o peri√≥dica de disponibilidade
        function startAvailabilityRefresh() {
            setInterval(() => {
                if (currentAvailabilityData && selectedRooms.length > 0) {
                    const startDate = document.getElementById('checkinDate').value;
                    const endDate = document.getElementById('checkoutDate').value;

                    if (startDate && endDate) {
                        const formattedStartDate = formatDateToDDMMAAAA(startDate);
                        const formattedEndDate = formatDateToDDMMAAAA(endDate);

                        fetchAvailability(formattedStartDate, formattedEndDate)
                            .then(newData => {
                                currentAvailabilityData = newData;
                                updateRoomOptions();

                                // Registrar no hist√≥rico
                                availabilityHistory.push({
                                    timestamp: new Date(),
                                    action: 'Atualiza√ß√£o peri√≥dica de disponibilidade',
                                    data: JSON.parse(JSON.stringify(newData))
                                });
                            })
                            .catch(error => {
                                console.error('Erro ao atualizar disponibilidade:', error);
                            });
                    }
                }
            }, 300000); // Atualiza a cada 5 minutos
        }

        // Inicializar o chat
        document.addEventListener('DOMContentLoaded', function() {
            setupButtonListeners();
            document.getElementById('messageInput').focus();
            startAvailabilityRefresh();
            
            // Testar conex√£o com a IA
            console.log('Hotel Granja Brasil Assistente inicializado');
            console.log('Endpoint IA: https://intrega-ia.paulo-migueoli.workers.dev/');
        });
    </script>
</body>
</html>
