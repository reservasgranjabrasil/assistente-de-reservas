async function fetchAvailability(startDate, endDate) {
    const cacheKey = `${startDate}-${endDate}`;

    if (availabilityCache[cacheKey]) {
        return availabilityCache[cacheKey];
    }

    // Diferentes proxies CORS para tentar
    const proxies = [
        'https://api.allorigins.win/raw?url=',
        'https://corsproxy.io/?',
        'https://cors-anywhere.herokuapp.com/'
    ];

    let lastError;

    for (const proxy of proxies) {
        try {
            const targetUrl = 'https://reservas.desbravador.com.br/reservas/modules/ws/interface.php';
            const encodedUrl = encodeURIComponent(targetUrl);
            const fullUrl = proxy + encodedUrl;

            const payload = {
                "wsrolRQ": {
                    "hotelLoginRQ": {
                        "slug": "hotel-granja-brasil-resort",
                        "origem": "rolweb",
                        "ip": "191.31.44.244"
                    },
                    "disponibilidadeRQ": {
                        "disponibilidade": {
                            "datainicio": startDate,
                            "datafim": endDate,
                            "detalhes": true,
                            "cdvoucher": 0
                        }
                    }
                }
            };

            const response = await fetch(fullUrl, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': 'Basic cm9sRHNsOkJyNDVpMUAyMDE4',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Erro na consulta de disponibilidade: ${response.status}`);
            }

            const data = await response.json();
            availabilityCache[cacheKey] = data;
            return data;

        } catch (error) {
            console.error(`Proxy ${proxy} falhou:`, error);
            lastError = error;
            continue; // Tenta o próximo proxy
        }
    }

    // Se todos os proxies falharem
    throw new Error('Serviço indisponível no momento. Por favor, tente novamente mais tarde.');
}
