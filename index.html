<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistente de Reservas - Hotel Granja Brasil</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
        }

        body {
            background-color: #e5ddd5;
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 0;
            background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AkEEjIZzQJpLgAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAAJUlEQVQ4y2NgGAWjYBSMglEwCkbBKJhYwMjAwMDw//9/BqoBAG4FBGj6r1jZAAAAAElFTkSuQmCC");
        }

        .chat-container {
            background: #e5ddd5;
            border-radius: 0;
            box-shadow: none;
            width: 100%;
            max-width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: #075e54;
            color: white;
            padding: 10px 15px;
            text-align: left;
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hotel-logo {
            font-size: 16px;
            font-weight: 500;
            flex-grow: 1;
        }

        .hotel-subtitle {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 2px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #4ad504;
            border-radius: 50%;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #e5ddd5;
            -webkit-overflow-scrolling: touch;
            background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AkEEjIZzQJpLgAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAAJUlEQVQ4y2NgGAWjYBSMglEwCkbBKJhYwMjAwMDw//9/BqoBAG4FBGj6r1jZAAAAAElFTkSuQmCC");
        }

        .message {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
            animation: slideIn 0.3s ease;
            scroll-margin-top: 10px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .bot-avatar {
            background: #075e54;
        }

        .user-avatar {
            background: #128c7e;
        }

        .message-content {
            background: white;
            padding: 8px 12px;
            border-radius: 7.5px;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
            max-width: 85%;
            word-wrap: break-word;
            font-size: 15px;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: #dcf8c6;
            color: #000;
        }

        .typing-message {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .typing-indicator {
            padding: 12px 16px;
            background: white;
            border-radius: 7.5px;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
            min-width: 80px;
        }

        .typing-dots {
            display: flex;
            gap: 6px;
            justify-content: center;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: typingPulse 1.4s ease-in-out infinite both;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typingPulse {
            0%, 80%, 100% {
                transform: scale(0.6);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .chat-input {
            padding: 8px;
            background: #f0f0f0;
            border-top: 1px solid #ddd;
            position: sticky;
            bottom: 0;
            z-index: 100;
        }

        .input-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            outline: none;
            font-size: 15px;
            background: white;
        }

        .message-input:disabled {
            background: #f0f0f0;
            color: #666;
            cursor: not-allowed;
        }

        .send-button {
            width: 40px;
            height: 40px;
            background: #075e54;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            font-size: 16px;
        }

        .send-button:hover:not(:disabled) {
            background: #128c7e;
        }

        .send-button:disabled {
            background: #999;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 8px 0;
        }

        .quick-action {
            background: white;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 18px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

            .quick-action:hover {
                background: #f5f5f5;
            }

        .quote-button, .whatsapp-button, .corporate-button {
            border-radius: 18px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: background 0.3s;
            width: 100%;
            font-size: 15px;
            border: none;
        }

        .quote-button {
            background: #075e54;
            color: white;
        }

        .whatsapp-button {
            background: #25d366;
            color: white;
        }

        .corporate-button {
            background: #075e54;
            color: white;
        }

        .quote-form {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 8px 0;
            border: 1px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 12px;
        }

            .form-group label {
                display: block;
                margin-bottom: 4px;
                font-weight: 600;
                color: #2c3e50;
                font-size: 13px;
            }

            .form-group input, .form-group select {
                width: 100%;
                padding: 8px 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 13px;
            }

        .form-row {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

            .form-row .form-group {
                flex: 1;
            }

        .quote-result {
            background: #075e54;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 14px;
        }

        .loading {
            color: #075e54;
            text-align: center;
            margin: 10px 0;
            font-size: 14px;
            display: none;
        }

        .error-message {
            color: #e74c3c;
            text-align: center;
            margin: 10px 0;
            display: none;
            font-size: 14px;
        }

        .no-availability {
            color: #e67e22;
            text-align: center;
            margin: 10px 0;
            display: none;
            font-size: 14px;
            font-weight: 600;
        }

        .disabled-option {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .children-section {
            background: #f0f8ff;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border-left: 4px solid #3498db;
        }

            .children-section h4 {
                margin-bottom: 8px;
                color: #2c3e50;
            }

        .invalid-combination {
            color: #e74c3c;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        .accommodation-divider {
            margin: 15px 0;
            border: none;
            border-top: 1px dashed rgba(255,255,255,0.3);
        }

        input:disabled, select:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.7;
        }

        #roomsContainer {
            max-height: none;
            overflow-y: visible;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #roomsContainer label {
            cursor: pointer;
            user-select: none;
            font-size: 15px;
            display: inline-block;
            margin-left: 8px;
        }

        #roomsContainer input[type="checkbox"] {
            cursor: pointer;
            margin-right: 12px;
            width: 18px;
            height: 18px;
            transform: scale(1.1);
        }

        #roomsContainer > div {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin: 0;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        #roomsContainer > div:hover {
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        #roomsContainer > div:last-child {
            border-bottom: none;
        }

        #roomsContainer .video-button {
            margin-left: auto;
            background-color: #e6f3f0;
            border: none;
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
            color: #075e54;
            font-weight: 500;
            transition: background-color 0.2s;
            white-space: nowrap;
        }

        #roomsContainer .video-button:hover {
            background-color: #c8e6e0;
        }

        #roomsContainer span[style*="color: #075e54"] {
            margin-left: 12px;
            font-size: 14px;
            white-space: nowrap;
        }

        .ai-response {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #128c7e;
        }

        .ai-response ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .ai-response li {
            margin: 8px 0;
            padding-left: 5px;
            line-height: 1.5;
        }
        
        .ai-response strong {
            color: #075e54;
        }
        
        .ai-response a.phone-link {
            color: #075e54;
            text-decoration: none;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            background: #f0f8ff;
            transition: all 0.2s;
            display: inline-block;
            margin-left: 5px;
        }
        
        .ai-response a.phone-link:hover {
            background: #e1f5fe;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .message-part {
            margin-bottom: 10px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .human-typing {
            font-style: italic;
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .video-button {
            background: none;
            border: none;
            color: #128c7e;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 2px 8px;
            margin-left: 8px;
            border-radius: 12px;
            background-color: #e6f3f0;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: background-color 0.2s;
            font-weight: 500;
            white-space: nowrap;
        }

        .video-button:hover {
            background-color: #c8e6e0;
            text-decoration: underline;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(3px);
        }

        .modal-content {
            position: relative;
            margin: auto;
            padding: 0;
            width: 90%;
            max-width: 800px;
            top: 50%;
            transform: translateY(-50%);
            background-color: transparent;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border-radius: 8px;
            overflow: hidden;
        }

        .video-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            background: #000;
        }

        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            display: block;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 20px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
            line-height: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .close-modal:hover {
            color: #bbb;
        }

        .accommodation-item {
            background: white;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .accommodation-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .accommodation-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .accommodation-content {
            padding: 15px;
        }

        .accommodation-features {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .feature-column {
            flex: 1;
            min-width: 200px;
        }

        .video-button-accommodation {
            background: #075e54;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 15px;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background 0.2s;
        }

        .video-button-accommodation:hover {
            background: #128c7e;
        }

        .remove-room-btn {
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 18px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 10px;
            padding: 0;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        
        .remove-room-btn:hover {
            background-color: #cc0000;
        }

        .cart-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            background: white;
            border-radius: 4px;
        }

        .cart-item-content {
            flex: 1;
        }

        #roomsContainer > div {
            display: flex !important;
            align-items: flex-start !important;
            gap: 10px !important;
        }

        #roomsContainer > div > div:nth-child(2) {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 4px !important;
        }

        #roomsContainer > div > div:nth-child(2) > div:nth-child(2) {
            display: flex !important;
            flex-wrap: wrap !important;
            align-items: center !important;
            justify-content: space-between !important;
            gap: 8px !important;
        }

        .video-button {
            white-space: nowrap !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 4px !important;
        }

        @media (max-width: 480px) {
            #roomsContainer > div > div:nth-child(2) > div:nth-child(2) {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
            
            .video-button {
                width: 100% !important;
                justify-content: center !important;
            }
        }

        @media (min-width: 768px) {
            body {
                align-items: center;
                padding: 20px;
            }

            .chat-container {
                border-radius: 8px;
                box-shadow: 0 6px 18px rgba(0,0,0,0.1);
                max-width: 675px;
                height: 80vh;
            }

            .chat-header {
                padding: 12px 15px;
            }

            .hotel-logo {
                font-size: 22px;
            }

            .hotel-subtitle {
                font-size: 14px;
            }

            .message-content {
                max-width: 70%;
                font-size: 16px;
                padding: 12px 16px;
            }

            .quick-action {
                font-size: 14px;
                padding: 8px 16px;
            }

            .quote-form {
                padding: 20px;
            }

            .form-group input,
            .form-group select {
                padding: 10px 12px;
                font-size: 15px;
            }

            .form-group label {
                font-size: 15px;
            }

            #roomType {
                font-size: 15px;
                padding: 10px;
            }

            .accommodation-divider {
                margin: 20px 0;
            }

            .quote-button,
            .whatsapp-button,
            .corporate-button {
                padding: 12px 20px;
                font-size: 16px;
            }

            .send-button {
                width: 48px;
                height: 48px;
                font-size: 20px;
            }

            .quote-result {
                padding: 20px;
            }

                .quote-result h3 {
                    font-size: 20px;
                }

                .quote-result h4 {
                    font-size: 22px;
                }

            .form-row {
                flex-direction: row;
                gap: 20px;
            }

                .form-row .form-group {
                    flex: 1;
                }

            @media (max-width: 768px) {
                #roomsContainer > div {
                    flex-wrap: wrap;
                    gap: 8px;
                }
                
                #roomsContainer .video-button {
                    margin-left: 0;
                    width: 100%;
                    text-align: center;
                }
                
                #roomsContainer span[style*="color: #075e54"] {
                    margin-left: 0;
                }
            }
        }

        .price-display {
            font-weight: 600;
            color: #075e54;
            font-size: 15px;
            margin-left: 12px;
            white-space: nowrap;
        }

        .room-price-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        /* Melhorias para v√≠deos em tela cheia */
        video:-webkit-full-screen {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: black;
        }

        video:-moz-full-screen {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: black;
        }

        video:-ms-fullscreen {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: black;
        }

        video:fullscreen {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: black;
        }

        /* Bot√£o de tela cheia para v√≠deos */
        .video-fullscreen-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .video-fullscreen-btn:hover {
            background: rgba(0,0,0,0.8);
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .video-container video {
                object-fit: contain !important;
                background: black;
            }
            
            .video-container video:fullscreen {
                object-fit: contain;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span>Online</span>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <div class="message-avatar bot-avatar">ü§ñ</div>
                <div class="message-content">
                    <p>Ol√°! Bem-vindo ao <strong>Hotel Granja Brasil</strong>! üëã</p>
                    <p>Sou seu assistente virtual e estou aqui para ajud√°-lo com:</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>üè∑Ô∏è Or√ßamentos de reservas em tempo real</li>
                        <li>üìã Informa√ß√µes sobre acomoda√ß√µes</li>
                        <li>üåü Servi√ßos e facilidades</li>
                        <li>‚ùì Esclarecimento de d√∫vidas</li>
                        <li>üìç Informa√ß√µes sobre estabelecimentos locais</li>
                    </ul>
                    <p>Como posso ajud√°-lo hoje?</p>

                    <div class="quick-actions">
                        <button class="quick-action" data-action="solicitar-orcamento">üí∞ Solicitar Or√ßamento</button>
                        <button class="quick-action" data-action="informacoes-hotel">üè® Acomoda√ß√µes</button>
                        <button class="quick-action" data-action="servicos">üåü Servi√ßos e Lazer</button>
                        <button class="quick-action" data-action="politicas">üìã Pol√≠ticas</button>
                        <button class="quick-action" data-action="localizacao">üìç Localiza√ß√£o</button>
                        <button class="quick-action" data-action="contato">üìû Contato</button>
                    </div>

                    <button id="corporateBtn" class="corporate-button">
                        üè¢ Reservas Corporativas
                    </button>
                </div>
            </div>

            <div class="typing-message" id="typingContainer" style="display: none;">
                <div class="message-avatar bot-avatar">ü§ñ</div>
                <div class="typing-indicator">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-input">
            <div class="input-container">
                <input type="text" id="messageInput" class="message-input" placeholder="Digite sua mensagem...">
                <button id="sendButton" class="send-button">
                    ‚û§
                </button>
            </div>
        </div>
    </div>

    <div id="videoModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeVideoModal()">&times;</span>
            <div class="video-container">
                <video id="modalVideo" controls playsinline>
                    <source src="" type="video/mp4">
                    Seu navegador n√£o suporta a tag de v√≠deo.
                </video>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√µes do hotel
        const HOTEL_CONFIG = {
            name: "Hotel Granja Brasil",
            whatsappNumber: "+5524998275427",
            emailCorporativo: "contato@reservasgranjabrasil.com.br",
            localizacao: "Condom√≠nio das Resid√™ncias do Pau Brasil - Estrada Uni√£o e Ind√∫stria, 9153 - Itaipava - Petr√≥polis, RJ",
            politicas: {
                cancelamento: "Altera√ß√µes ou cancelamentos sem custo at√© 48h antes do check-in",
                criancas: "Crian√ßas at√© 6 anos n√£o pagam, mas exigem su√≠tes com sof√°s-camas",
                hospedeExtra: "H√≥spedes extras: R$ 102/dia (sof√°s-camas)",
                animais: "Animais de estima√ß√£o n√£o s√£o permitidos",
                fumante: "100% n√£o fumante",
                atestatMedico: "Obrigat√≥rio para √°reas externas (sauna, academia, piscinas) - v√°lido por 6 meses"
            },
            servicos: [
                "Caf√© da Manh√£ (Buffet) Incluso",
                "Internet Wifi Gratuita",
                "Piscinas",
                "Quadras Poliesportivas, T√™nis e V√¥lei de Areia",
                "Academia e Sauna a Vapor",
                "Trilha Ecol√≥gica",
                "Parquinho Infantil",
                "Estacionamento Gratuito (coberto/descoberto)"
            ],
            horarios: {
                checkin: "14h √†s 19h",
                checkout: "12h",
                governanca: "7h √†s 22h",
                recepcao: "7h √†s 19h",
                piscina: "Quinta a domingo: 10h √†s 19h"
            },
            acomodacoes: [
                {
                    nome: "Apartamento Superior",
                    descricao: "Camas separadas (padr√£o vi√∫va) ‚Äì ideal para solteiros - 26 m¬≤ - Ar-condicionado - Frigobar - Secador de Cabelos - Mesa de Trabalho",
                    capacidade: 2
                },
                {
                    nome: "Su√≠te S√™nior",
                    descricao: "Conforto ampliado com sof√°-cama na sala - Cama de Casal King Size - 41 m¬≤ - Ar-condicionado - Frigobar - Microondas - Pia - Sacada - Secador de Cabelos - Mesa de Trabalho",
                    capacidade: 3
                },
                {
                    nome: "Su√≠te Master (Cobertura)",
                    descricao: "Cama King Size, sof√°-cama e vista privilegiada - 56 m¬≤ - Ar-condicionado - Frigobar - Microondas - Pia - Varanda - Acesso por escada (15 degraus) - Secador de Cabelos - Mesa de Trabalho",
                    capacidade: 3
                }
            ]
        };

        // Dados de minlos (estadia m√≠nima)
        const MINLOS_DATA = {
            "20/12/2025": 2,
            "27/12/2025": 2,
            "28/12/2025": 4,
            "29/12/2025": 4,
            "30/12/2025": 3,
            "31/12/2025": 3,
            "01/01/2026": 3,
            "03/01/2026": 2,
            "10/01/2026": 2,
            "17/01/2026": 2,
            "18/01/2026": 2,
            "19/01/2026": 2,
            "20/01/2026": 2,
            "24/01/2026": 2,
            "31/01/2026": 2,
            "07/02/2026": 2,
            "07/03/2026": 2,
            "14/03/2026": 2,
            "21/03/2026": 2,
            "28/03/2026": 2,
            "02/04/2026": 3,
            "03/04/2026": 3,
            "04/04/2026": 3,
            "05/04/2026": 3,
            "11/04/2026": 2,
            "18/04/2026": 2,
            "19/04/2026": 2,
            "20/04/2026": 2,
            "21/04/2026": 2,
            "22/04/2026": 2,
            "23/04/2026": 2,
            "25/04/2026": 2,
            "02/05/2026": 2,
            "09/05/2026": 2,
            "16/05/2026": 2,
            "23/05/2026": 2,
            "30/04/2026": 3,
            "01/05/2026": 3,
            "02/05/2026": 3,
            "03/05/2026": 3,
            "30/05/2026": 2,
            "04/06/2026": 3,
            "05/06/2026": 3,
            "06/06/2026": 3,
            "07/06/2026": 3,
            "13/06/2026": 2,
            "20/06/2026": 2,
            "27/06/2026": 2,
            "04/07/2026": 2,
            "11/07/2026": 2,
            "18/07/2026": 2,
            "25/07/2026": 2,
            "01/08/2026": 2,
            "08/08/2026": 2,
            "15/08/2026": 2,
            "22/08/2026": 2,
            "29/08/2026": 2,
            "04/09/2026": 3,
            "05/09/2026": 3,
            "06/09/2026": 3,
            "07/09/2026": 3,
            "12/09/2026": 2,
            "19/09/2026": 2,
            "26/09/2026": 2,
            "03/10/2026": 2,
            "09/10/2026": 3,
            "10/10/2026": 3,
            "11/10/2026": 3,
            "12/10/2026": 3,
            "17/10/2026": 2,
            "24/10/2026": 2,
            "31/10/2026": 2,
            "07/11/2026": 2,
            "14/11/2026": 2,
            "19/11/2026": 3,
            "20/11/2026": 3,
            "21/11/2026": 3,
            "22/11/2026": 3,
            "28/11/2026": 2,
            "05/12/2026": 2,
            "12/12/2026": 2,
            "19/12/2026": 2,
            "26/12/2026": 2,
            "30/12/2026": 4,
            "31/12/2026": 4,
            "01/01/2027": 4,
            "02/01/2027": 4,
            "03/01/2027": 4
        };

        function convertCurrencyToNumber(currencyString) {
            if (!currencyString) return 0;
            const numericString = currencyString.toString()
                .replace(/R\$\s?/g, '')
                .replace(/\./g, '')
                .replace(',', '.');
            return parseFloat(numericString) || 0;
        }

        function formatCurrency(value) {
            const numericValue = typeof value === 'string' ?
                parseFloat(value.replace(/[^\d.-]/g, '')) :
                Number(value);
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2
            }).format(numericValue);
        }

        function formatDateToDDMMAAAA(dateString) {
            const date = new Date(dateString);
            const offset = date.getTimezoneOffset();
            date.setMinutes(date.getMinutes() + offset);

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function getDatesBetween(startDateStr, endDateStr) {
            const dates = [];
            let currentDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);

            while (currentDate < endDate) {
                dates.push(formatDateToDDMMAAAA(currentDate.toISOString().split('T')[0]));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        function checkMinLOS(startDateStr, endDateStr) {
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            const nights = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));

            const datesInPeriod = getDatesBetween(startDateStr, endDateStr);
            
            let maxMinLOS = 1;
            let dateWithMaxMinLOS = '';
            
            datesInPeriod.forEach(dateStr => {
                const minLOS = MINLOS_DATA[dateStr] || 1;
                if (minLOS > maxMinLOS) {
                    maxMinLOS = minLOS;
                    dateWithMaxMinLOS = dateStr;
                }
            });

            if (nights < maxMinLOS) {
                return {
                    valid: false,
                    message: `Para o per√≠odo selecionado, h√° restri√ß√£o de estadia m√≠nima de ${maxMinLOS} noites (a partir de ${dateWithMaxMinLOS}). Por favor, ajuste suas datas.`
                };
            }

            return { valid: true };
        }

        const availabilityCache = {};

        async function fetchAvailability(startDate, endDate) {
            const cacheKey = `${startDate}-${endDate}`;

            if (availabilityCache[cacheKey]) {
                return availabilityCache[cacheKey];
            }

            const proxies = [
                { url: 'https://broken-hall-6760.paulo-migueoli.workers.dev/', type: 'direct' }
            ];

            let lastError;

            for (const proxy of proxies) {
                try {
                    const targetUrl = 'https://reservas.desbravador.com.br/reservas/modules/ws/interface.php';
                    let fullUrl;
                    
                    if (proxy.type === 'allorigins') {
                        fullUrl = proxy.url + encodeURIComponent(targetUrl);
                    } else {
                        fullUrl = proxy.url + targetUrl;
                    }

                    const payload = {
                        "wsrolRQ": {
                            "hotelLoginRQ": {
                                "slug": "hotel-granja-brasil-resort",
                                "origem": "rolweb",
                                "ip": "191.31.44.244"
                            },
                            "disponibilidadeRQ": {
                                "disponibilidade": {
                                    "datainicio": startDate,
                                    "datafim": endDate,
                                    "detalhes": true,
                                    "cdvoucher": 0
                                }
                            }
                        }
                    };

                    let response;
                    if (proxy.type === 'allorigins') {
                        response = await fetch(fullUrl, {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Basic cm9sRHNsOkJyNDVpMUAyMDE4',
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload)
                        });
                    } else {
                        response = await fetch(fullUrl, {
                            method: 'POST',
                            headers: {
                                'Accept': 'application/json',
                                'Authorization': 'Basic cm9sRHNsOkJyNDVpMUAyMDE4',
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload)
                        });
                    }

                    if (!response.ok) {
                        throw new Error(`Erro ${response.status} no proxy ${proxy.url}`);
                    }

                    let data = await response.json();
                    
                    if (proxy.type === 'allorigins' && data.contents) {
                        try {
                            data = JSON.parse(data.contents);
                        } catch (e) {}
                    }

                    availabilityCache[cacheKey] = data;
                    return data;

                } catch (error) {
                    console.warn(`Tentativa com proxy ${proxy.url} falhou:`, error.message);
                    lastError = error;
                    continue;
                }
            }

            throw new Error('Servi√ßo indispon√≠vel no momento. Por favor, tente novamente mais tarde.');
        }

        async function fetchHotelRates(startDate, endDate) {
            const url = `https://xeitj4h9fd.execute-api.us-east-1.amazonaws.com/prd/desbravador?start=${encodeURIComponent(startDate)}&end=${encodeURIComponent(endDate)}`;

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Basic Og==',
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erro na consulta: ${response.status}`);
                }

                const data = await response.json();

                if (!data.data || !data.data.dataFormatted || !Array.isArray(data.data.dataFormatted)) {
                    throw new Error('Formato de dados inv√°lido retornado pela API');
                }

                data.data.dataFormatted = data.data.dataFormatted.map(room => {
                    const valorMedio = convertCurrencyToNumber(room.valorMedio || room.total);
                    const total = convertCurrencyToNumber(room.total);

                    return {
                        ...room,
                        valorMedio: valorMedio * 0.95,
                        total: total * 0.95
                    };
                });

                return data;
            } catch (error) {
                console.error('Erro na API de tarifas:', error);
                throw new Error('Erro ao consultar tarifas. Por favor, tente novamente.');
            }
        }

        async function callHotelAI(message) {
            try {
                console.log('Chamando IA para:', message.substring(0, 50) + '...');
                
                let conversationId = localStorage.getItem('granja_conversation_id');
                
                if (!conversationId) {
                    conversationId = `conv_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    localStorage.setItem('granja_conversation_id', conversationId);
                    console.log('üÜî Novo conversation_id gerado:', conversationId);
                } else {
                    console.log('üÜî Reutilizando conversation_id existente:', conversationId);
                }
                
                const historyForAPI = conversationHistory
                    .filter(msg => {
                        const isCurrentMessage = msg.isUser && 
                            typeof msg.content === 'string' && 
                            msg.content.trim() === message.trim();
                        return !isCurrentMessage;
                    })
                    .map(msg => ({
                        role: msg.isUser ? 'user' : 'assistant',
                        content: typeof msg.content === 'string' ? 
                            msg.content.replace(/<[^>]*>/g, ' ').substring(0, 1000) : 'Mensagem com formata√ß√£o',
                        timestamp: msg.timestamp ? msg.timestamp.toISOString() : new Date().toISOString()
                    }));
                
                console.log('üì§ Enviando para o Worker:', {
                    conversation_id: conversationId,
                    historyLength: historyForAPI.length,
                    prompt: message.substring(0, 30)
                });
                
                const response = await fetch('https://intrega-ia.paulo-migueoli.workers.dev/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: message,
                        conversation_id: conversationId,
                        history: historyForAPI.slice(-20)
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.conversation_id && data.conversation_id !== conversationId) {
                    console.log('üÜî Atualizando conversation_id:', data.conversation_id);
                    localStorage.setItem('granja_conversation_id', data.conversation_id);
                }
                
                if (data.success) {
                    console.log('‚úÖ Resposta IA recebida');
                    return formatAIResponse(data.response);
                } else {
                    console.error('‚ùå Erro da API:', data);
                    return getFallbackResponse(message);
                }
            } catch (error) {
                console.error('‚ùå Erro ao chamar IA:', error);
                return getFallbackResponse(message);
            }
        }

        function formatAIResponse(text) {
            if (!text) return text;
            
            let formattedText = text;
            
            formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            formattedText = formattedText.replace(/üí° Dica: Clique em um n√∫mero para ligar diretamente!/g, '');
            
            const patternsToRemove = [
                /Resposta precisa:/g,
                /Informa√ß√£o complementar \(da Categoria \d+\):/g,
                /V√≠nculo com a experi√™ncia no hotel:/g,
                /Call to Action \(Pr√≥ximo Passo\):/g,
                /Gatilho usado:/g,
                /Gatilho para [^:]+:/g
            ];
            
            patternsToRemove.forEach(pattern => {
                formattedText = formattedText.replace(pattern, '');
            });
            
            formattedText = formattedText.replace(/\n\s*\n\s*\n/g, '\n\n');
            
            formattedText = formattedText.replace(/\n\n/g, '</p><p>');
            formattedText = formattedText.replace(/\n/g, '<br>');
            
            if (!formattedText.startsWith('<p>')) {
                formattedText = `<p>${formattedText}</p>`;
            }
            
            formattedText = formattedText.replace(/‚Ä¢\s*/g, '<li>');
            formattedText = formattedText.replace(/<\/li><br>/g, '</li>');
            
            if (formattedText.includes('<li>')) {
                formattedText = formattedText.replace(/<li>(.*?)<\/li>/g, function(match, content) {
                    return `<li style="margin: 5px 0; padding-left: 5px;">${content.trim()}</li>`;
                });
                
                formattedText = formattedText.replace(/<li>/, '<ul style="margin: 10px 0; padding-left: 20px;">');
                formattedText = formattedText.replace(/<\/p>$/, '</ul></p>');
            }
            
            formattedText = formattedText.replace(/(\(\d{2}\)\s*\d{4,5}-\d{4})/g, 
                '<strong style="color: #075e54;">$1</strong>');
            formattedText = formattedText.replace(/(\d{2}\s*\d{4,5}-\d{4})/g, 
                '<strong style="color: #075e54;">$1</strong>');
            
            const estabelecimentos = [
                "Sal√£o Andrea Novena", "Ateli√™ da Beleza", "Farley Frossard", 
                "Divino & Cucina", "Suki Gastronomia Japonesa", "Lenha & Co", 
                "Farfarello", "Bordeaux Vinhos", "Drogaria Pacheco", "Droga Raia", 
                "Drogasil", "Hortifruti Itaipava", "Castelo de Itaipava", 
                "Parque Municipal de Itaipava", "Itaipava Spa", "Academia Granja Brasil", 
                "Shopping Vilarejo", "Shopping Itaipava", "Esta√ß√£o Locanda", 
                "Cine Itaipava", "Mim√¥ Pizzaria", "Hotel Granja Brasil"
            ];
            
            estabelecimentos.forEach(estabelecimento => {
                const regex = new RegExp(estabelecimento, 'g');
                formattedText = formattedText.replace(regex, '<strong>$&</strong>');
            });
            
            formattedText = formattedText.replace(/(Shopping Itaipava|Shopping Vilarejo|Estrada Uni√£o e Ind√∫stria|Estrada Bernardo Coutinho|Rua Francisco dos Santos)/g, 
                '<span style="color: #666;">$1</span>');
            
            formattedText = formattedText.replace(/<p>/g, '<p style="margin: 8px 0; line-height: 1.5;">');
            
            formattedText = `
                <div class="ai-response">
                    ${formattedText}
                </div>
            `;
            
            return formattedText;
        }

        function exportCurrentConversation() {
            const conversationId = localStorage.getItem('granja_conversation_id') || 'conversa_atual';
            
            const exportData = {
                conversation_id: conversationId,
                export_date: new Date().toISOString(),
                messages: conversationHistory.map(msg => ({
                    role: msg.isUser ? 'user' : 'assistant',
                    content: typeof msg.content === 'string' ? 
                        msg.content.replace(/<[^>]*>/g, ' ') : msg.content.outerHTML,
                    timestamp: msg.timestamp
                }))
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `conversa_${conversationId}_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function setupPhoneClicks() {
            setTimeout(() => {
                const phoneRegex = /(\(\d{2}\)\s*\d{4,5}-\d{4})|(\d{2}\s*\d{4,5}-\d{4})/g;
                const messageElements = document.querySelectorAll('.message.bot .message-content');
                
                messageElements.forEach(element => {
                    const html = element.innerHTML;
                    const updatedHtml = html.replace(phoneRegex, (match) => {
                        const cleanNumber = match.replace(/\D/g, '');
                        const telLink = cleanNumber.startsWith('0') ? cleanNumber.substring(1) : cleanNumber;
                        return `<a href="tel:${telLink}" class="phone-link">${match}</a>`;
                    });
                    
                    if (updatedHtml !== html) {
                        element.innerHTML = updatedHtml;
                    }
                });
            }, 100);
        }

        function getFallbackResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('or√ßamento') || lowerMessage.includes('pre√ßo') || lowerMessage.includes('valor') || lowerMessage.includes('reserva')) {
                return generateQuoteForm();
            }
            
            return `
                <p>Desculpe, estou com dificuldades t√©cnicas no momento.</p>
                <p>Voc√™ pode:</p>
                <div class="quick-actions">
                    <button class="quick-action" data-action="solicitar-orcamento">üí∞ Solicitar Or√ßamento</button>
                    <button class="quick-action" data-action="informacoes-hotel">üè® Sobre o Hotel</button>
                    <button class="whatsapp-button" onclick="openWhatsApp('Ol√°, preciso de ajuda com o Hotel Granja Brasil')">
                        üí¨ WhatsApp
                    </button>
                </div>
            `;
        }

        function splitResponseIntoParts(responseText) {
            const parts = [];
            const maxLength = 300;
            
            if (responseText.length <= maxLength) {
                return [responseText];
            }
            
            const paragraphs = responseText.split('</p><p>');
            
            let currentPart = '';
            for (const paragraph of paragraphs) {
                if ((currentPart + paragraph).length > maxLength && currentPart.length > 0) {
                    parts.push(currentPart);
                    currentPart = paragraph;
                } else {
                    currentPart += (currentPart ? '</p><p>' : '') + paragraph;
                }
            }
            
            if (currentPart.length > 0) {
                parts.push(currentPart);
            }
            
            return parts;
        }

        async function addMessageWithHumanTyping(content, isUser = false) {
            if (isUser) {
                addMessage(content, true);
                return;
            }
            
            const parts = splitResponseIntoParts(content);
            
            for (let i = 0; i < parts.length; i++) {
                const part = parts[i];
                
                if (i > 0) {
                    showTyping();
                    await delay(800 + Math.random() * 800);
                    hideTyping();
                }
                
                addMessage(part, false);
                
                if (i < parts.length - 1) {
                    await delay(1000 + Math.random() * 1000);
                }
            }
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        let conversationHistory = [];
        let currentQuoteData = null;
        let selectedRooms = [];
        let currentAvailabilityData = null;
        let isCheckingAvailability = false;
        let isProcessingQuickAction = false;
        let isSendingMessage = false;
        const availabilityHistory = [];

        function addMessage(content, isUser = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const typingContainer = document.getElementById('typingContainer');

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;

            const avatar = document.createElement('div');
            avatar.className = `message-avatar ${isUser ? 'user-avatar' : 'bot-avatar'}`;
            avatar.textContent = isUser ? 'üë§' : 'ü§ñ';

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            if (!isUser && typeof content === 'string' && content.includes('ai-response')) {
                messageContent.innerHTML = content;
            } else if (typeof content === 'string') {
                messageContent.innerHTML = content;
            } else {
                messageContent.appendChild(content);
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);

            messagesContainer.insertBefore(messageDiv, typingContainer);

            setTimeout(() => {
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 50);

            conversationHistory.push({
                content: typeof content === 'string' ? content : content.outerHTML,
                isUser: isUser,
                timestamp: new Date()
            });

            setTimeout(() => {
                setupButtonListeners();
                setupPhoneClicks();
            }, 50);
        }

        function showTyping() {
            const typingContainer = document.getElementById('typingContainer');
            if (typingContainer) {
                typingContainer.style.display = 'flex';
                setTimeout(() => {
                    typingContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 50);
            }
        }

        function hideTyping() {
            const typingContainer = document.getElementById('typingContainer');
            if (typingContainer) {
                typingContainer.style.display = 'none';
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            return errorDiv;
        }

        function showNoAvailability(message) {
            const noAvailDiv = document.createElement('div');
            noAvailDiv.className = 'no-availability';
            noAvailDiv.textContent = message;
            noAvailDiv.style.display = 'block';
            return noAvailDiv;
        }

        function showLoading(message) {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.textContent = message;
            loadingDiv.style.display = 'block';
            return loadingDiv;
        }

        function disableDateInputs() {
            const checkinDate = document.getElementById('checkinDate');
            const checkoutDate = document.getElementById('checkoutDate');
            if (checkinDate) checkinDate.disabled = true;
            if (checkoutDate) checkoutDate.disabled = true;
        }

        function enableDateInputs() {
            const checkinDate = document.getElementById('checkinDate');
            const checkoutDate = document.getElementById('checkoutDate');
            if (checkinDate) checkinDate.disabled = false;
            if (checkoutDate) checkoutDate.disabled = false;
        }

        function resetQuoteForm() {
            selectedRooms = [];
            currentQuoteData = null;
            enableDateInputs();
            const quoteForm = document.getElementById('quoteForm');
            if (quoteForm) quoteForm.reset();
            const roomSelectionSection = document.getElementById('roomSelectionSection');
            if (roomSelectionSection) roomSelectionSection.style.display = 'none';
            const quoteResultContainer = document.getElementById('quoteResultContainer');
            if (quoteResultContainer) quoteResultContainer.style.display = 'none';
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            const errorIndicator = document.getElementById('errorIndicator');
            if (errorIndicator) errorIndicator.style.display = 'none';
            const noAvailabilityIndicator = document.getElementById('noAvailabilityIndicator');
            if (noAvailabilityIndicator) noAvailabilityIndicator.style.display = 'none';
            const childAgeGroup1 = document.getElementById('childAgeGroup1');
            if (childAgeGroup1) childAgeGroup1.style.display = 'none';
            const childAgeGroup2 = document.getElementById('childAgeGroup2');
            if (childAgeGroup2) childAgeGroup2.style.display = 'none';

            const roomsContainer = document.getElementById('roomsContainer');
            if (roomsContainer) {
                roomsContainer.innerHTML = '';
            }
        }

        function generateQuoteForm() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const minDate = tomorrow.toISOString().split('T')[0];

            const formHTML = `
                <p><strong>üí∞ Solicitar Or√ßamento de Reserva</strong></p>
                <p>Preencha os dados abaixo para receber seu or√ßamento personalizado em tempo real:</p>
                <div class="quote-form" id="quoteForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Data de Check-in:</label>
                            <input type="date" id="checkinDate" min="${minDate}">
                        </div>
                        <div class="form-group">
                            <label>Data de Check-out:</label>
                            <input type="date" id="checkoutDate" min="${minDate}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>N√∫mero de Adultos:</label>
                        <select id="adults" onchange="validateGuestCombination()">
                            <option value="1">1 Adulto</option>
                            <option value="2" selected>2 Adultos</option>
                            <option value="3">3 Adultos</option>
                        </select>
                    </div>

                    <div class="children-section">
                        <h4>üë∂ Crian√ßas (at√© 17 anos)</h4>
                        <div class="form-group">
                            <label>Quantidade de Crian√ßas:</label>
                            <select id="hasChildren" onchange="toggleChildAge(); validateGuestCombination()">
                                <option value="0">Sem crian√ßas</option>
                                <option value="1">1 Crian√ßa</option>
                                <option value="2">2 Crian√ßas</option>
                            </select>
                        </div>

                        <div class="form-group" id="childAgeGroup1" style="display: none;">
                            <label>Idade da 1¬™ Crian√ßa:</label>
                            <select id="childAge1" onchange="validateGuestCombination()">
                                <option value="0">0 ano</option>
                                <option value="1">1 ano</option>
                                <option value="2">2 anos</option>
                                <option value="3">3 anos</option>
                                <option value="4">4 anos</option>
                                <option value="5">5 anos</option>
                                <option value="6" selected>6 anos</option>
                                <option value="7">7 anos</option>
                                <option value="8">8 anos</option>
                                <option value="9">9 anos</option>
                                <option value="10">10 anos</option>
                                <option value="11">11 anos</option>
                                <option value="12">12 anos</option>
                                <option value="13">13 anos</option>
                                <option value="14">14 anos</option>
                                <option value="15">15 anos</option>
                                <option value="16">16 anos</option>
                                <option value="17">17 anos</option>
                            </select>
                        </div>

                        <div class="form-group" id="childAgeGroup2" style="display: none;">
                            <label>Idade da 2¬™ Crian√ßa:</label>
                            <select id="childAge2" onchange="validateGuestCombination()">
                                <option value="0">0 ano</option>
                                <option value="1">1 ano</option>
                                <option value="2">2 anos</option>
                                <option value="3">3 anos</option>
                                <option value="4">4 anos</option>
                                <option value="5">5 anos</option>
                                <option value="6" selected>6 anos</option>
                                <option value="7">7 anos</option>
                                <option value="8">8 anos</option>
                                <option value="9">9 anos</option>
                                <option value="10">10 anos</option>
                                <option value="11">11 anos</option>
                                <option value="12">12 anos</option>
                                <option value="13">13 anos</option>
                                <option value="14">14 anos</option>
                                <option value="15">15 anos</option>
                                <option value="16">16 anos</option>
                                <option value="17">17 anos</option>
                            </select>
                        </div>
                        <div id="invalidCombinationMsg" class="invalid-combination"></div>
                    </div>

                    <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin: 15px 0; font-size: 14px;">
                        <p><strong>‚ÑπÔ∏è Informa√ß√µes Importantes:</strong></p>
                        <ul style="margin: 8px 0; padding-left: 20px;">
                            <li>Check-in: ${HOTEL_CONFIG.horarios.checkin} | Check-out: ${HOTEL_CONFIG.horarios.checkout}</li>
                            <li>Hotel 100% n√£o fumante</li>
                            <li>Animais de estima√ß√£o n√£o s√£o permitidos</li>
                            <li>Atestado m√©dico obrigat√≥rio para √°reas externas ao Hotel (sauna, academia e piscinas) - v√°lido por 6 meses.</li>
                            <li>O tarif√°rio e a disponibilidade est√£o sujeitos a altera√ß√£o sem aviso pr√©vio. As informa√ß√µes fornecidas nesta consulta ser√£o confirmadas pelo agente de reservas no momento da resposta √† sua cota√ß√£o.</li>
                        </ul>
                    </div>

                    <button id="checkAvailabilityBtn" class="quote-button">
                        üîç Consultar Disponibilidade
                    </button>

                    <div id="loadingIndicator" style="display: none;"></div>
                    <div id="errorIndicator" style="display: none;"></div>
                    <div id="noAvailabilityIndicator" style="display: none;"></div>

                    <div id="roomSelectionSection" style="display: none; margin-top: 15px;"></div>

                    <div id="quoteResultContainer" style="display: none;"></div>
                </div>
            `;

            return formHTML;
        }

        function toggleChildAge() {
            const hasChildren = document.getElementById('hasChildren').value;
            const childAgeGroup1 = document.getElementById('childAgeGroup1');
            const childAgeGroup2 = document.getElementById('childAgeGroup2');

            if (hasChildren === '1') {
                childAgeGroup1.style.display = 'block';
                childAgeGroup2.style.display = 'none';
            } else if (hasChildren === '2') {
                childAgeGroup1.style.display = 'block';
                childAgeGroup2.style.display = 'block';
            } else {
                childAgeGroup1.style.display = 'none';
                childAgeGroup2.style.display = 'none';
            }

            validateGuestCombination();
        }

        function validateGuestCombination() {
            const adults = parseInt(document.getElementById('adults').value);
            const hasChildren = document.getElementById('hasChildren').value !== '0';
            const childrenCount = hasChildren ? parseInt(document.getElementById('hasChildren').value) : 0;
            const childAge1 = hasChildren ? parseInt(document.getElementById('childAge1').value) : 0;
            const childAge2 = childrenCount === 2 ? parseInt(document.getElementById('childAge2').value) : 0;
            const errorMsg = document.getElementById('invalidCombinationMsg');
            const checkBtn = document.getElementById('checkAvailabilityBtn');

            if (!errorMsg || !checkBtn) return false;

            errorMsg.style.display = 'none';
            checkBtn.disabled = false;

            if (adults === 0 && hasChildren) {
                errorMsg.textContent = 'Para reservas com crian√ßas, √© necess√°rio pelo menos 1 adulto';
                errorMsg.style.display = 'block';
                checkBtn.disabled = true;
                return false;
            }

            if (adults + childrenCount > 3) {
                errorMsg.textContent = 'Capacidade m√°xima excedida (m√°ximo 3 h√≥spedes)';
                errorMsg.style.display = 'block';
                checkBtn.disabled = true;
                return false;
            }

            return true;
        }

        function updateRoomOptions() {
            if (!validateGuestCombination()) return;
            if (!currentAvailabilityData) return;

            const adults = parseInt(document.getElementById('adults').value);
            const hasChildren = document.getElementById('hasChildren').value !== '0';
            const childrenCount = hasChildren ? parseInt(document.getElementById('hasChildren').value) : 0;
            const childAge1 = hasChildren ? parseInt(document.getElementById('childAge1').value) : 0;
            const childAge2 = childrenCount === 2 ? parseInt(document.getElementById('childAge2').value) : 0;
            const totalGuests = adults + childrenCount;

            const infoDiv = document.getElementById('roomSelectionInfo');

            const startDate = document.getElementById('checkinDate').value;
            const endDate = document.getElementById('checkoutDate').value;
            const datesToCheck = getDatesBetween(startDate, endDate);

            let infoMessage = '';
            let hasAvailableOptions = false;

            const checkboxes = document.querySelectorAll('#roomsContainer input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                const roomData = JSON.parse(checkbox.value);
                const roomName = roomData.descricao.toLowerCase();
                const roomCode = roomData.codigo;

                const isSuite = roomName.includes('su√≠te') || roomName.includes('suite');
                const isSuperior = roomName.includes('apartamento superior');

                let isAvailable = true;
                let reason = '';

                const hasAvailability = datesToCheck.every(date => {
                    return currentAvailabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode] &&
                           currentAvailabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode].diaria[date] > 0;
                });

                if (!hasAvailability) {
                    isAvailable = false;
                    reason = ' (indispon√≠vel para todas as datas selecionadas)';
                } else if (isSuperior && totalGuests > 2) {
                    isAvailable = false;
                    reason = ' (capacidade m√°xima de 2 h√≥spedes)';
                } else if (hasChildren && (childAge1 <= 6 || (childrenCount === 2 && childAge2 <= 6)) && !isSuite) {
                    isAvailable = false;
                    reason = ' (crian√ßas at√© 6 anos exigem su√≠te com sof√°-cama)';
                }

                if (!isAvailable) {
                    checkbox.disabled = true;
                    checkbox.parentElement.style.opacity = '0.5';
                    checkbox.parentElement.style.cursor = 'not-allowed';
                    checkbox.parentElement.title = reason.trim();
                } else {
                    checkbox.disabled = false;
                    checkbox.parentElement.style.opacity = '1';
                    checkbox.parentElement.style.cursor = 'pointer';
                    checkbox.parentElement.removeAttribute('title');
                    hasAvailableOptions = true;
                }
            });

            if (hasChildren && (childAge1 <= 6 || (childrenCount === 2 && childAge2 <= 6))) {
                infoMessage = 'Nota: Crian√ßas at√© 6 anos exigem su√≠tes com sof√°-cama (S√™nior ou Master)';
            } else if (hasChildren && (childAge1 > 6 || (childrenCount === 2 && childAge2 > 6))) {
                infoMessage = 'Nota: Crian√ßa acima de 6 anos ser√° cobrada como h√≥spede extra (R$ 102/dia)';
            }

            if (infoDiv) {
                infoDiv.textContent = infoMessage;
            }

            return hasAvailableOptions;
        }

        async function checkAvailability() {
            if (isCheckingAvailability) return;
            isCheckingAvailability = true;

            if (!validateGuestCombination()) {
                isCheckingAvailability = false;
                return;
            }

            const startDate = document.getElementById('checkinDate').value;
            const endDate = document.getElementById('checkoutDate').value;
            const adults = parseInt(document.getElementById('adults').value);
            const hasChildren = document.getElementById('hasChildren').value !== '0';
            const childrenCount = hasChildren ? parseInt(document.getElementById('hasChildren').value) : 0;
            const childAge1 = hasChildren ? parseInt(document.getElementById('childAge1').value) : 0;
            const childAge2 = childrenCount === 2 ? parseInt(document.getElementById('childAge2').value) : 0;

            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorIndicator = document.getElementById('errorIndicator');
            const noAvailabilityIndicator = document.getElementById('noAvailabilityIndicator');
            const roomSelectionSection = document.getElementById('roomSelectionSection');
            const quoteResultContainer = document.getElementById('quoteResultContainer');

            if (!startDate || !endDate) {
                errorIndicator.innerHTML = showError('Por favor, selecione as datas de check-in e check-out').outerHTML;
                errorIndicator.style.display = 'block';
                loadingIndicator.style.display = 'none';
                noAvailabilityIndicator.style.display = 'none';
                roomSelectionSection.style.display = 'none';
                quoteResultContainer.style.display = 'none';
                isCheckingAvailability = false;
                enableDateInputs();
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const checkinDate = new Date(startDate);

            if (checkinDate <= today) {
                errorIndicator.innerHTML = showError('O check-in deve ser feito com pelo menos 1 dia de anteced√™ncia. Por favor, selecione uma data a partir de amanh√£.').outerHTML;
                errorIndicator.style.display = 'block';
                loadingIndicator.style.display = 'none';
                noAvailabilityIndicator.style.display = 'none';
                roomSelectionSection.style.display = 'none';
                quoteResultContainer.style.display = 'none';
                isCheckingAvailability = false;
                enableDateInputs();
                return;
            }

            if (new Date(endDate) <= new Date(startDate)) {
                errorIndicator.innerHTML = showError('A data de check-out deve ser posterior √† data de check-in').outerHTML;
                errorIndicator.style.display = 'block';
                loadingIndicator.style.display = 'none';
                noAvailabilityIndicator.style.display = 'none';
                roomSelectionSection.style.display = 'none';
                quoteResultContainer.style.display = 'none';
                isCheckingAvailability = false;
                enableDateInputs();
                return;
            }

            const minLOSCheck = checkMinLOS(startDate, endDate);
            if (!minLOSCheck.valid) {
                errorIndicator.innerHTML = showError(minLOSCheck.message).outerHTML;
                errorIndicator.style.display = 'block';
                loadingIndicator.style.display = 'none';
                noAvailabilityIndicator.style.display = 'none';
                roomSelectionSection.style.display = 'none';
                quoteResultContainer.style.display = 'none';
                isCheckingAvailability = false;
                enableDateInputs();
                return;
            }

            loadingIndicator.innerHTML = showLoading('Consultando disponibilidade, aguarde...').outerHTML;
            loadingIndicator.style.display = 'block';
            errorIndicator.style.display = 'none';
            noAvailabilityIndicator.style.display = 'none';
            roomSelectionSection.style.display = 'none';
            quoteResultContainer.style.display = 'none';

            try {
                const formattedStartDate = formatDateToDDMMAAAA(startDate);
                const formattedEndDate = formatDateToDDMMAAAA(endDate);

                let availabilityData;
                try {
                    availabilityData = await fetchAvailability(formattedStartDate, formattedEndDate);
                    currentAvailabilityData = availabilityData;

                    availabilityHistory.push({
                        timestamp: new Date(),
                        action: 'Consulta inicial de disponibilidade',
                        data: JSON.parse(JSON.stringify(availabilityData))
                    });
                } catch (error) {
                    console.error('Erro na API de disponibilidade:', error);
                    throw new Error('Servi√ßo indispon√≠vel no momento. Por favor, tente novamente mais tarde.');
                }

                if (!availabilityData.wsrolRS || !availabilityData.wsrolRS.disponibilidadeRS || !availabilityData.wsrolRS.disponibilidadeRS.disponibilidade || !availabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result || Object.keys(availabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result).length === 0) {
                    noAvailabilityIndicator.innerHTML = showNoAvailability("N√£o h√° disponibilidade de acomoda√ß√µes para o per√≠odo selecionado. Por favor, tente outras datas.").outerHTML;
                    noAvailabilityIndicator.style.display = 'block';
                    loadingIndicator.style.display = 'none';
                    errorIndicator.style.display = 'none';
                    isCheckingAvailability = false;
                    enableDateInputs();
                    return;
                }

                let apiData;
                try {
                    apiData = await fetchHotelRates(formattedStartDate, formattedEndDate);

                    if (!apiData.data || !apiData.data.dataFormatted || !Array.isArray(apiData.data.dataFormatted)) {
                        throw new Error('Formato de dados inv√°lido retornado pela API');
                    }
                } catch (error) {
                    console.error('Erro na API de tarifas:', error);
                    throw new Error('Erro ao consultar tarifas. Por favor, tente novamente.');
                }

                const availableRooms = apiData.data.dataFormatted.filter(room => {
                    const roomCode = room.codigo;
                    const roomName = room.descricao.toLowerCase();
                    const isSuite = roomName.includes('su√≠te') || roomName.includes('suite');
                    const isSuperior = roomName.includes('apartamento superior');
                    const datesToCheck = getDatesBetween(startDate, endDate);
                    const totalGuests = adults + childrenCount;

                    const isAvailableForDates = datesToCheck.every(date => {
                        return availabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode] &&
                               availabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode].diaria[date] > 0;
                    });

                    if (!isAvailableForDates) return false;
                    if (isSuperior && totalGuests > 2) return false;
                    if (hasChildren && (childAge1 <= 6 || (childrenCount === 2 && childAge2 <= 6)) && !isSuite) return false;

                    return true;
                });

                if (availableRooms.length === 0) {
                    let message = "N√£o h√° acomoda√ß√µes dispon√≠veis para o per√≠odo selecionado com a configura√ß√£o de h√≥spedes informada.";

                    if (hasChildren && (childAge1 <= 6 || (childrenCount === 2 && childAge2 <= 6))) {
                        message += " Crian√ßas at√© 6 anos exigem su√≠tes com sof√°-cama (S√™nior ou Master).";
                    } else if (adults > 2) {
                        message += " Para 3 adultos, apenas su√≠tes Master ou S√™nior est√£o dispon√≠veis.";
                    }

                    noAvailabilityIndicator.innerHTML = showNoAvailability(message).outerHTML;
                    noAvailabilityIndicator.style.display = 'block';
                    loadingIndicator.style.display = 'none';
                    errorIndicator.style.display = 'none';
                    isCheckingAvailability = false;
                    enableDateInputs();
                    return;
                }

                loadingIndicator.style.display = 'none';
                displayAvailableRooms(apiData, startDate, endDate, availableRooms, adults, hasChildren, childAge1, childAge2, childrenCount);
            } catch (error) {
                console.error('Erro na consulta:', error);
                errorIndicator.innerHTML = showError(error.message).outerHTML;
                errorIndicator.style.display = 'block';
                loadingIndicator.style.display = 'none';
                noAvailabilityIndicator.style.display = 'none';
                enableDateInputs();
            } finally {
                isCheckingAvailability = false;
            }
        }

        function displayAvailableRooms(apiData, startDate, endDate, availableRooms, adults, hasChildren, childAge1, childAge2, childrenCount) {
            const roomSelectionSection = document.getElementById('roomSelectionSection');
            const quoteResultContainer = document.getElementById('quoteResultContainer');
            const loadingIndicator = document.getElementById('loadingIndicator');

            loadingIndicator.style.display = 'none';
            roomSelectionSection.style.display = 'block';
            quoteResultContainer.style.display = 'none';

            const roomsContainer = document.createElement('div');
            roomsContainer.id = 'roomsContainer';
            roomsContainer.style.marginBottom = '15px';
            roomsContainer.style.backgroundColor = 'white';
            roomsContainer.style.borderRadius = '8px';
            roomsContainer.style.padding = '5px 0';

            roomSelectionSection.innerHTML = '';
            roomSelectionSection.appendChild(roomsContainer);

            const title = document.createElement('p');
            title.innerHTML = '<strong>Selecione as acomoda√ß√µes desejadas:</strong>';
            title.style.marginBottom = '15px';
            title.style.fontSize = '16px';
            title.style.padding = '0 10px';
            roomsContainer.appendChild(title);

            const roomTypesInOrder = [
                { name: "Apartamento Superior", code: "SUP" },
                { name: "Su√≠te S√™nior", code: "SEN" },
                { name: "Su√≠te Master (Cobertura)", code: "MAS" }
            ];

            const orderedRooms = [];
            roomTypesInOrder.forEach(type => {
                const room = availableRooms.find(r =>
                    r.descricao.includes(type.name) ||
                    r.codigo === type.code
                );
                if (room) orderedRooms.push(room);
            });

            const childAge1Num = childAge1 || 0;
            const childAge2Num = childAge2 || 0;
            
            const payingChildren = (hasChildren ? 
                (childAge1Num > 6 ? 1 : 0) + (childrenCount === 2 && childAge2Num > 6 ? 1 : 0) : 0);
            const totalPayingGuests = adults + payingChildren;
            const extraGuests = Math.max(0, totalPayingGuests - 2);

            orderedRooms.forEach(room => {
                const roomDiv = document.createElement('div');
                roomDiv.style.display = 'flex';
                roomDiv.style.flexDirection = 'row';
                roomDiv.style.alignItems = 'flex-start';
                roomDiv.style.padding = '12px 10px';
                roomDiv.style.borderBottom = '1px solid #f0f0f0';
                roomDiv.style.gap = '10px';

                const checkboxCol = document.createElement('div');
                checkboxCol.style.width = '30px';
                checkboxCol.style.flexShrink = '0';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `room-${room.codigo}`;
                
                const extraGuestFeePerNight = extraGuests * 102;
                const totalPerNight = room.valorMedio + extraGuestFeePerNight;
                
                checkbox.value = JSON.stringify({
                    descricao: room.descricao,
                    total: room.total,
                    valorMedio: room.valorMedio,
                    disponivel: true,
                    codigo: room.codigo,
                    totalPerNight: totalPerNight,
                    extraGuests: extraGuests
                });
                checkbox.style.width = '18px';
                checkbox.style.height = '18px';
                checkbox.style.cursor = 'pointer';
                checkbox.style.margin = '2px 0 0 0';
                
                checkboxCol.appendChild(checkbox);

                const contentCol = document.createElement('div');
                contentCol.style.flex = '1';
                contentCol.style.display = 'flex';
                contentCol.style.flexDirection = 'column';
                contentCol.style.gap = '4px';

                const nameRow = document.createElement('div');
                nameRow.style.display = 'flex';
                nameRow.style.flexWrap = 'wrap';
                nameRow.style.alignItems = 'center';
                nameRow.style.gap = '8px';

                const label = document.createElement('label');
                label.htmlFor = `room-${room.codigo}`;
                label.textContent = room.descricao;
                label.style.fontWeight = '500';
                label.style.fontSize = '15px';
                label.style.cursor = 'pointer';
                label.style.color = '#333';
                label.style.lineHeight = '1.4';

                nameRow.appendChild(label);

                const bottomRow = document.createElement('div');
                bottomRow.style.display = 'flex';
                bottomRow.style.flexWrap = 'wrap';
                bottomRow.style.alignItems = 'center';
                bottomRow.style.justifyContent = 'space-between';
                bottomRow.style.gap = '8px';
                bottomRow.style.marginTop = '2px';

                const priceContainer = document.createElement('div');
                
                const priceSpan = document.createElement('span');
                priceSpan.className = 'price-display';
                priceSpan.textContent = `${formatCurrency(totalPerNight)}/noite`;
                priceSpan.style.fontWeight = '600';
                priceSpan.style.color = '#075e54';
                priceSpan.style.fontSize = '14px';
                priceSpan.style.backgroundColor = '#e8f5e9';
                priceSpan.style.padding = '2px 8px';
                priceSpan.style.borderRadius = '12px';
                priceSpan.style.display = 'inline-block';
                
                priceContainer.appendChild(priceSpan);

                let videoFileName = '';
                const roomDesc = room.descricao.toLowerCase();

                if (roomDesc.includes('apartamento superior') || room.codigo === 'SUP') {
                    videoFileName = 'Apartamento Superior.mp4';
                } 
                else if (roomDesc.includes('suite senior') || roomDesc.includes('su√≠te s√™nior') || room.codigo === 'SEN') {
                    videoFileName = 'Su√≠te S√™nior.mp4';
                } 
                else if (roomDesc.includes('suite master') || roomDesc.includes('su√≠te master') || roomDesc.includes('cobertura') || room.codigo === 'MAS') {
                    videoFileName = 'Su√≠te M√°ster.mp4';
                }

                const videoContainer = document.createElement('div');

                if (videoFileName) {
                    const videoBtn = document.createElement('button');
                    videoBtn.className = 'video-button';
                    videoBtn.innerHTML = '‚ñ∂ Ver v√≠deo';
                    videoBtn.style.backgroundColor = '#e6f3f0';
                    videoBtn.style.border = 'none';
                    videoBtn.style.borderRadius = '20px';
                    videoBtn.style.padding = '6px 14px';
                    videoBtn.style.fontSize = '13px';
                    videoBtn.style.fontWeight = '500';
                    videoBtn.style.color = '#075e54';
                    videoBtn.style.cursor = 'pointer';
                    videoBtn.style.transition = 'background-color 0.2s';
                    videoBtn.style.whiteSpace = 'nowrap';
                    videoBtn.style.display = 'inline-flex';
                    videoBtn.style.alignItems = 'center';
                    videoBtn.style.gap = '4px';
                    
                    videoBtn.onmouseover = () => {
                        videoBtn.style.backgroundColor = '#c8e6e0';
                    };
                    videoBtn.onmouseout = () => {
                        videoBtn.style.backgroundColor = '#e6f3f0';
                    };
                    
                    videoBtn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        openVideoModal(videoFileName);
                    };
                    
                    videoContainer.appendChild(videoBtn);
                }

                const applyResponsiveStyles = () => {
                    if (window.innerWidth <= 480) {
                        bottomRow.style.flexDirection = 'column';
                        bottomRow.style.alignItems = 'flex-start';
                        if (videoContainer.children.length > 0) {
                            videoContainer.style.marginTop = '4px';
                            videoContainer.style.width = '100%';
                            const videoBtn = videoContainer.querySelector('button');
                            if (videoBtn) {
                                videoBtn.style.width = '100%';
                                videoBtn.style.justifyContent = 'center';
                            }
                        }
                    } else {
                        bottomRow.style.flexDirection = 'row';
                        bottomRow.style.alignItems = 'center';
                        if (videoContainer.children.length > 0) {
                            videoContainer.style.marginTop = '0';
                            videoContainer.style.width = 'auto';
                            const videoBtn = videoContainer.querySelector('button');
                            if (videoBtn) {
                                videoBtn.style.width = 'auto';
                                videoBtn.style.justifyContent = 'flex-start';
                            }
                        }
                    }
                };

                applyResponsiveStyles();

                bottomRow.appendChild(priceContainer);
                bottomRow.appendChild(videoContainer);

                contentCol.appendChild(nameRow);
                contentCol.appendChild(bottomRow);

                roomDiv.appendChild(checkboxCol);
                roomDiv.appendChild(contentCol);

                roomsContainer.appendChild(roomDiv);
            });

            const addButton = document.createElement('button');
            addButton.id = 'addToQuoteBtn';
            addButton.className = 'quote-button';
            addButton.textContent = '‚ûï Incluir ao or√ßamento';
            addButton.style.marginTop = '15px';
            addButton.style.width = '100%';
            addButton.style.padding = '12px';
            addButton.style.fontSize = '16px';

            addButton.addEventListener('click', function () {
                const checkboxes = document.querySelectorAll('#roomsContainer input[type="checkbox"]:checked');

                if (checkboxes.length === 0) {
                    alert('Por favor, selecione pelo menos uma acomoda√ß√£o.');
                    return;
                }

                checkboxes.forEach(checkbox => {
                    try {
                        const selectedRoom = JSON.parse(checkbox.value);
                        askForAdditionalRoom(selectedRoom, startDate, endDate, adults, hasChildren, childAge1, childAge2, childrenCount, extraGuests);
                    } catch (e) {
                        console.error('Erro ao processar sele√ß√£o de quarto:', e);
                    }
                });

                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            });

            roomSelectionSection.appendChild(addButton);

            const handleResize = () => {
                const roomDivs = document.querySelectorAll('#roomsContainer > div');
                roomDivs.forEach(roomDiv => {
                    if (roomDiv.id === 'roomsContainer' || roomDiv.tagName === 'P') return;
                    
                    const bottomRow = roomDiv.querySelector('div:nth-child(2) > div:nth-child(2)');
                    const videoContainer = roomDiv.querySelector('div:nth-child(2) > div:nth-child(2) > div:last-child');
                    
                    if (bottomRow) {
                        if (window.innerWidth <= 480) {
                            bottomRow.style.flexDirection = 'column';
                            bottomRow.style.alignItems = 'flex-start';
                            if (videoContainer) {
                                videoContainer.style.marginTop = '4px';
                                videoContainer.style.width = '100%';
                                const videoBtn = videoContainer.querySelector('button');
                                if (videoBtn) {
                                    videoBtn.style.width = '100%';
                                    videoBtn.style.justifyContent = 'center';
                                }
                            }
                        } else {
                            bottomRow.style.flexDirection = 'row';
                            bottomRow.style.alignItems = 'center';
                            if (videoContainer) {
                                videoContainer.style.marginTop = '0';
                                videoContainer.style.width = 'auto';
                                const videoBtn = videoContainer.querySelector('button');
                                if (videoBtn) {
                                    videoBtn.style.width = 'auto';
                                    videoBtn.style.justifyContent = 'flex-start';
                                }
                            }
                        }
                    }
                });
            };

            window.addEventListener('resize', handleResize);
        }

        function removeRoomFromCart(indexToRemove) {
            if (indexToRemove >= 0 && indexToRemove < selectedRooms.length) {
                const removedRoom = selectedRooms[indexToRemove];
                
                if (currentAvailabilityData && removedRoom && removedRoom.room && removedRoom.room.codigo) {
                    const roomCode = removedRoom.room.codigo;
                    const datesToUpdate = getDatesBetween(
                        removedRoom.startDate,
                        removedRoom.endDate
                    );
                    
                    const beforeUpdate = JSON.parse(JSON.stringify(currentAvailabilityData));
                    
                    datesToUpdate.forEach(date => {
                        if (currentAvailabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode]) {
                            currentAvailabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode].diaria[date] += 1;
                        }
                    });
                    
                    availabilityHistory.push({
                        timestamp: new Date(),
                        action: `Remo√ß√£o de ${roomCode} (devolu√ß√£o ao estoque)`,
                        before: beforeUpdate,
                        after: JSON.parse(JSON.stringify(currentAvailabilityData))
                    });
                }
                
                selectedRooms.splice(indexToRemove, 1);
                
                if (selectedRooms.length === 0) {
                    currentQuoteData = null;
                    enableDateInputs();
                    
                    const quoteResultContainer = document.getElementById('quoteResultContainer');
                    if (quoteResultContainer) {
                        quoteResultContainer.style.display = 'none';
                    }
                    
                    const roomSelectionSection = document.getElementById('roomSelectionSection');
                    if (roomSelectionSection) {
                        roomSelectionSection.style.display = 'block';
                    }
                } else {
                    updateCartDisplay();
                }
                
                updateRoomOptions();
                
                const datesToCheck = getDatesBetween(
                    selectedRooms.length > 0 ? selectedRooms[0].startDate : '',
                    selectedRooms.length > 0 ? selectedRooms[0].endDate : ''
                );
                
                if (datesToCheck.length > 0) {
                    let availabilityMessage = '<div style="background: #f8f9fa; border-left: 4px solid #075e54; padding: 10px; margin: 10px 0; border-radius: 4px;">';
                    availabilityMessage += '<p style="font-weight: bold; margin-bottom: 5px;">üìä Disponibilidade restante para o per√≠odo:</p>';

                    const roomTypes = [
                        { name: "Apartamento Superior", code: "SUP" },
                        { name: "Su√≠te S√™nior", code: "SEN" },
                        { name: "Su√≠te Master (Cobertura)", code: "MAS" }
                    ];

                    roomTypes.forEach(roomType => {
                        const minAvailability = Math.min(
                            ...datesToCheck.map(date => {
                                const roomData = currentAvailabilityData?.wsrolRS?.disponibilidadeRS?.disponibilidade?.result[roomType.code];
                                return roomData ? (roomData.diaria[date] || 0) : 0;
                            })
                        );

                        if (minAvailability > 0) {
                            availabilityMessage += `<p style="margin: 3px 0;">${roomType.name}: <strong>${minAvailability} unidade(s)</strong></p>`;
                        } else {
                            availabilityMessage += `<p style="margin: 3px 0; color: #999;">${roomType.name}: <strong>0 unidades</strong></p>`;
                        }
                    });

                    availabilityMessage += '</div>';
                    
                    const cartDiv = document.querySelector('#quoteResultContainer > div > div:first-child + div');
                    if (cartDiv) {
                        cartDiv.innerHTML = availabilityMessage;
                    }
                }
            }
        }

        function updateCartDisplay() {
            if (selectedRooms.length === 0) return;

            const quoteResultContainer = document.getElementById('quoteResultContainer');
            const startDate = selectedRooms[0].startDate;
            const endDate = selectedRooms[0].endDate;
            const nights = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24));

            let subtotal = 0;
            let cartItemsHtml = '';

            selectedRooms.forEach((room, index) => {
                const roomNights = Math.ceil((new Date(room.endDate) - new Date(room.startDate)) / (1000 * 60 * 60 * 24));
                const total = room.totalPerNight * roomNights;
                subtotal += total;

                cartItemsHtml += `
                    <div class="cart-item" style="display: flex; align-items: center; justify-content: space-between; padding: 8px; margin-bottom: 8px; border-bottom: 1px solid #eee; background: white; border-radius: 4px;">
                        <div class="cart-item-content" style="flex: 1;">
                            <p style="margin: 0; font-size: 14px;"><strong>${index + 1}. ${room.room.descricao}</strong></p>
                            <p style="margin: 0; font-size: 12px; color: #666;">${room.adults} adulto(s)${room.hasChildren ? ` + ${room.childrenCount} crian√ßa(s)` : ''}</p>
                            <p style="margin: 0; font-size: 13px; font-weight: 600;">${formatCurrency(total)} (${roomNights} noites)</p>
                        </div>
                        <button class="remove-room-btn" onclick="removeRoomFromCart(${index})" style="background-color: #ff4444; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 18px; line-height: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 10px; padding: 0; transition: background-color 0.2s; flex-shrink: 0;">
                            √ó
                        </button>
                    </div>
                `;
            });

            const datesToCheck = getDatesBetween(startDate, endDate);
            
            let availabilityMessage = '<div style="background: #f8f9fa; border-left: 4px solid #075e54; padding: 10px; margin: 10px 0; border-radius: 4px;">';
            availabilityMessage += '<p style="font-weight: bold; margin-bottom: 5px;">üìä Disponibilidade restante para o per√≠odo:</p>';

            const roomTypes = [
                { name: "Apartamento Superior", code: "SUP" },
                { name: "Su√≠te S√™nior", code: "SEN" },
                { name: "Su√≠te Master (Cobertura)", code: "MAS" }
            ];

            roomTypes.forEach(roomType => {
                const minAvailability = Math.min(
                    ...datesToCheck.map(date => {
                        const roomData = currentAvailabilityData?.wsrolRS?.disponibilidadeRS?.disponibilidade?.result[roomType.code];
                        return roomData ? (roomData.diaria[date] || 0) : 0;
                    })
                );

                if (minAvailability > 0) {
                    availabilityMessage += `<p style="margin: 3px 0;">${roomType.name}: <strong>${minAvailability} unidade(s)</strong></p>`;
                } else {
                    availabilityMessage += `<p style="margin: 3px 0; color: #999;">${roomType.name}: <strong>0 unidades</strong></p>`;
                }
            });

            availabilityMessage += '</div>';

            let questionDiv = document.createElement('div');
            questionDiv.innerHTML = `
                <div style="background: #f8f9fa; border-left: 4px solid #075e54; padding: 15px; margin: 10px 0; border-radius: 4px;">
                    <p style="font-weight: bold; margin-bottom: 10px; font-size: 16px;">üõí Seu Carrinho</p>
                    ${cartItemsHtml}
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                        <p style="margin: 0; font-weight: bold; font-size: 16px;">Subtotal:</p>
                        <p style="margin: 0; font-weight: bold; font-size: 16px;">${formatCurrency(subtotal)}</p>
                    </div>
                </div>
                ${availabilityMessage}
                <hr style="margin: 15px 0; border: 1px solid rgba(0,0,0,0.1);">
                <p>Deseja incluir outra acomoda√ß√£o √† sua reserva?</p>
                <div class="quick-actions">
                    <button class="quick-action" id="addAnotherRoomBtn">Sim, adicionar mais</button>
                    <button class="quick-action" id="finishReservationBtn">N√£o, finalizar or√ßamento</button>
                </div>
            `;

            quoteResultContainer.innerHTML = '';
            quoteResultContainer.appendChild(questionDiv);
            quoteResultContainer.style.display = 'block';

            document.getElementById('addAnotherRoomBtn')?.addEventListener('click', () => {
                quoteResultContainer.style.display = 'none';
            });

            document.getElementById('finishReservationBtn')?.addEventListener('click', () => {
                showFinalQuote();
            });
        }

        function askForAdditionalRoom(selectedRoom, startDate, endDate, adults, hasChildren, childAge1, childAge2, childrenCount, extraGuests) {
            const roomCode = selectedRoom.codigo;
            const datesToCheck = getDatesBetween(startDate, endDate);

            const hasAvailability = datesToCheck.every(date => {
                return currentAvailabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode] &&
                       currentAvailabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode].diaria[date] > 0;
            });

            if (!hasAvailability) {
                const quoteResultContainer = document.getElementById('quoteResultContainer');
                quoteResultContainer.innerHTML = showError("N√£o h√° mais disponibilidade para esta acomoda√ß√£o nas datas selecionadas.").outerHTML;
                quoteResultContainer.style.display = 'block';
                return;
            }

            selectedRooms.push({
                room: selectedRoom,
                startDate,
                endDate,
                adults,
                hasChildren,
                childrenCount: childrenCount,
                childAge1,
                childAge2,
                extraGuests: extraGuests,
                totalPerNight: selectedRoom.totalPerNight || (selectedRoom.valorMedio + (extraGuests * 102))
            });

            if (selectedRooms.length === 1) {
                disableDateInputs();
            }

            updateAvailabilityAfterSelection(roomCode);
            updateCartDisplay();
        }

        function updateAvailabilityAfterSelection(roomCode) {
            if (!currentAvailabilityData || !roomCode) return;

            const beforeUpdate = JSON.parse(JSON.stringify(currentAvailabilityData));

            const datesToUpdate = getDatesBetween(
                document.getElementById('checkinDate').value,
                document.getElementById('checkoutDate').value
            );

            datesToUpdate.forEach(date => {
                if (currentAvailabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode] &&
                    currentAvailabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode].diaria[date] > 0) {
                    currentAvailabilityData.wsrolRS.disponibilidadeRS.disponibilidade.result[roomCode].diaria[date] -= 1;
                }
            });

            availabilityHistory.push({
                timestamp: new Date(),
                action: `Reserva de ${roomCode}`,
                before: beforeUpdate,
                after: JSON.parse(JSON.stringify(currentAvailabilityData))
            });

            updateRoomOptions();
        }

        function showFinalQuote() {
            if (selectedRooms.length === 0) return;

            const quoteResultContainer = document.getElementById('quoteResultContainer');
            const startDate = selectedRooms[0].startDate;
            const endDate = selectedRooms[0].endDate;

            const start = new Date(startDate);
            const end = new Date(endDate);
            const offset = start.getTimezoneOffset();
            start.setMinutes(start.getMinutes() + offset);
            end.setMinutes(end.getMinutes() + offset);
            const nights = Math.ceil((end - start) / (1000 * 60 * 60 * 24));

            let totalRooms = 0;
            let totalExtraGuests = 0;
            let roomsDescription = '';

            selectedRooms.forEach((reservation, index) => {
                const room = reservation.room;
                const adults = reservation.adults;
                const hasChildren = reservation.hasChildren;
                const childrenCount = reservation.childrenCount;
                const childAge1 = reservation.childAge1;
                const childAge2 = reservation.childrenCount === 2 ? reservation.childAge2 : 0;

                const dailyRate = room.valorMedio;

                let extraGuestFee = 0;
                let extraGuestMessage = '';

                if (hasChildren) {
                    const totalPayingGuests = adults + (childAge1 > 6 ? 1 : 0) + (childrenCount === 2 && childAge2 > 6 ? 1 : 0);

                    if (totalPayingGuests > 2) {
                        const extraGuests = totalPayingGuests - 2;
                        extraGuestFee = 102 * nights * extraGuests;

                        const childAges = [];
                        if (childAge1 > 6) childAges.push(childAge1);
                        if (childrenCount === 2 && childAge2 > 6) childAges.push(childAge2);

                        if (childAges.length > 0) {
                            extraGuestMessage = `<p><strong>üë∂ Crian√ßa(s) (${childAges.join(' e ')} anos):</strong> ${formatCurrency(extraGuestFee)} (R$ 102/dia por h√≥spede extra acima do limite de 2)</p>`;
                        }
                    }
                } else if (adults > 2) {
                    extraGuestFee = 102 * nights;
                    extraGuestMessage = `<p><strong>üë• H√≥spede extra:</strong> ${formatCurrency(extraGuestFee)} (R$ 102/dia)</p>`;
                }

                totalRooms += (dailyRate * nights);
                totalExtraGuests += extraGuestFee;

                roomsDescription += `
                    <hr class="accommodation-divider">
                    <div style="margin-bottom: 15px; padding-bottom: 15px;">
                        <p><strong>üè® Acomoda√ß√£o ${index + 1}:</strong> ${room.descricao}</p>
                        <p><strong>üë• H√≥spedes:</strong> ${adults} adulto(s)${hasChildren ? ` + ${childrenCount} crian√ßa(s) (${childAge1}${childrenCount === 2 ? ` e ${childAge2}` : ''} anos)` : ''}</p>
                        <p><strong>üí∞ Di√°ria:</strong> ${formatCurrency(dailyRate)}</p>
                        ${extraGuestMessage}
                    </div>
                `;
            });

            const subtotal = totalRooms + totalExtraGuests;
            const total = subtotal;

            const formatDisplayDate = (dateString) => {
                const date = new Date(dateString);
                date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
                return date.toLocaleDateString('pt-BR');
            };

            quoteResultContainer.innerHTML = `
                <div class="quote-result">
                    <h3>üìã Seu Or√ßamento Final - Hotel Granja Brasil</h3>
                    <hr style="margin: 15px 0; border: 1px solid rgba(255,255,255,0.3);">
                    <p><strong>üìÖ Per√≠odo:</strong> ${formatDisplayDate(startDate)} a ${formatDisplayDate(endDate)}</p>
                    <p><strong>üåô Noites:</strong> ${nights}</p>

                    ${roomsDescription}

                    <hr style="margin: 15px 0; border: 1px solid rgba(255,255,255,0.3);">
                    <p><strong>üíµ Subtotal Acomoda√ß√µes:</strong> ${formatCurrency(totalRooms)}</p>
                    <p><strong>üë• Taxas de H√≥spedes Extras:</strong> ${formatCurrency(totalExtraGuests)}</p>
                    <h4 style="font-size: 20px; margin-top: 10px;"><strong>üéØ TOTAL: ${formatCurrency(total)}</strong></h4>

                    <p style="margin-top: 15px; font-size: 14px; opacity: 0.9;">
                        * ${HOTEL_CONFIG.politicas.cancelamento}<br>
                        * ${HOTEL_CONFIG.politicas.criancas}<br>
                        * ${HOTEL_CONFIG.politicas.hospedeExtra}
                    </p>

                    <div class="form-group" style="margin-top: 20px;">
                        <input type="text" id="customerName" placeholder="Seu nome completo">
                    </div>

                    <button id="whatsappBtn" class="whatsapp-button">
                        ‚úÖ Fechar Reserva via WhatsApp
                    </button>
                    
                    <button id="backToCartBtn" class="quote-button" style="background: #666; margin-top: 10px;">
                        ‚Ü©Ô∏è Voltar ao carrinho
                    </button>
                </div>
            `;

            currentQuoteData = {
                rooms: selectedRooms,
                startDate,
                endDate,
                nights,
                totalRooms,
                totalExtraGuests,
                total
            };

            setupButtonListeners();
            
            document.getElementById('backToCartBtn')?.addEventListener('click', () => {
                updateCartDisplay();
            });
        }

        function sendQuoteToWhatsApp() {
            if (!currentQuoteData) return;

            const customerName = document.getElementById('customerName').value;
            if (!customerName) {
                alert('Por favor, informe seu nome completo para prosseguir com a reserva.');
                return;
            }

            currentQuoteData.customerName = customerName;

            let roomsDescription = '';
            currentQuoteData.rooms.forEach((reservation, index) => {
                const room = reservation.room;
                const adults = reservation.adults;
                const hasChildren = reservation.hasChildren;
                const childrenCount = reservation.childrenCount;
                const childAge1 = reservation.childAge1;
                const childAge2 = reservation.childrenCount === 2 ? reservation.childAge2 : 0;

                let extraGuestMessage = '';
                if (hasChildren) {
                    const totalPayingGuests = adults + (childAge1 > 6 ? 1 : 0) + (childrenCount === 2 && childAge2 > 6 ? 1 : 0);

                    if (totalPayingGuests > 2) {
                        const extraGuests = totalPayingGuests - 2;
                        const extraGuestFee = 102 * currentQuoteData.nights * extraGuests;

                        const childAges = [];
                        if (childAge1 > 6) childAges.push(childAge1);
                        if (childrenCount === 2 && childAge2 > 6) childAges.push(childAge2);

                        if (childAges.length > 0) {
                            extraGuestMessage = `\nüë∂ *Crian√ßa(s) (${childAges.join(' e ')} anos):* ${formatCurrency(extraGuestFee)} (h√≥spede extra)`;
                        }
                    }
                } else if (adults > 2) {
                    const extraGuestFee = 102 * currentQuoteData.nights;
                    extraGuestMessage = `\nüë• *H√≥spede extra:* ${formatCurrency(extraGuestFee)}`;
                }

                roomsDescription += `
üè® *Acomoda√ß√£o ${index + 1}:* ${room.descricao}
üë• *H√≥spedes:* ${adults} adulto(s)${hasChildren ? ` + ${childrenCount} crian√ßa(s) (${childAge1}${childrenCount === 2 ? ` e ${childAge2}` : ''} anos)` : ''}
üí∞ *Di√°ria:* ${formatCurrency(room.valorMedio)}${extraGuestMessage}

`;
            });

            const message = `
üè® *SOLICITA√á√ÉO DE RESERVA - HOTEL GRANJA BRASIL*

üë§ *Cliente:* ${currentQuoteData.customerName}

üìÖ *Check-in:* ${formatDisplayDate(currentQuoteData.startDate)}
üìÖ *Check-out:* ${formatDisplayDate(currentQuoteData.endDate)}
üåô *Noites:* ${currentQuoteData.nights}

${roomsDescription}
üí∞ *VALORES:*
‚Ä¢ Subtotal Acomoda√ß√µes: ${formatCurrency(currentQuoteData.totalRooms)}
‚Ä¢ Taxas de H√≥spedes Extras: ${formatCurrency(currentQuoteData.totalExtraGuests)}
‚Ä¢ *TOTAL: ${formatCurrency(currentQuoteData.total)}*

üìù Cliente interessado em fechar a reserva!
            `.trim();

            openWhatsApp(message);
        }

        function formatDisplayDate(dateString) {
            const date = new Date(dateString);
            date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
            return date.toLocaleDateString('pt-BR');
        }

        function openWhatsApp(message) {
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${HOTEL_CONFIG.whatsappNumber.replace(/\D/g, '')}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }

        function sendCorporateEmail() {
            const subject = encodeURIComponent('Solicita√ß√£o de Reserva Corporativa - Hotel Granja Brasil');
            const body = encodeURIComponent(`
Ol√°,

Gostaria de solicitar informa√ß√µes sobre reservas corporativas no Hotel Granja Brasil.

Por favor, entrem em contato para discutirmos:
- Datas pretendidas
- N√∫mero de colaboradores
- Tipo de acomoda√ß√µes necess√°rias
- Condi√ß√µes especiais para grupos corporativos

Aguardo retorno.

Atenciosamente,
[Seu nome]
[Sua empresa]
[Seu telefone]
            `.trim());

            const mailtoUrl = `mailto:${HOTEL_CONFIG.emailCorporativo}?subject=${subject}&body=${body}`;
            window.open(mailtoUrl, '_blank');

            showTyping();
            setTimeout(() => {
                hideTyping();
                addMessage(`
                    <p>üìß <strong>Solicita√ß√£o de Reserva Corporativa enviada!</strong></p>
                    <p>Seu email foi direcionado para: <strong>${HOTEL_CONFIG.emailCorporativo}</strong></p>
                    <p>Nossa equipe comercial entrar√° em contato em breve para apresentar as melhores condi√ß√µes para sua empresa.</p>
                    <p>Para informa√ß√µes mais r√°pidas, voc√™ tamb√©m pode entrar em contato via WhatsApp:</p>
                    <button class="whatsapp-button" onclick="openWhatsApp('Ol√°! Tenho interesse em reservas corporativas para o Hotel Granja Brasil.')">
                        üí¨ WhatsApp Comercial
                    </button>
                `);
            }, 1000);
        }

        async function sendMessage() {
            if (isSendingMessage) return;
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            isSendingMessage = true;
            
            input.disabled = true;
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;

            const lowerMessage = message.toLowerCase();
            const isQuoteRelated = lowerMessage.includes('or√ßamento') || 
                                  lowerMessage.includes('pre√ßo') || 
                                  lowerMessage.includes('valor') || 
                                  lowerMessage.includes('reserva') ||
                                  lowerMessage.includes('disponibilidade') ||
                                  lowerMessage.includes('tarifa') ||
                                  lowerMessage.includes('quarto') ||
                                  lowerMessage.includes('acomoda√ß√£o');

            addMessage(message, true);
            input.value = '';

            showTyping();

            try {
                if (isQuoteRelated) {
                    await delay(800);
                    const response = generateQuoteForm();
                    hideTyping();
                    addMessage(response);
                } else {
                    const aiResponse = await callHotelAI(message);
                    hideTyping();
                    
                    await addMessageWithHumanTyping(aiResponse);
                }
            } catch (error) {
                console.error('Erro ao processar mensagem:', error);
                hideTyping();
                addMessage(`
                    <p>Desculpe, ocorreu um erro ao processar sua mensagem.</p>
                    <p>Voc√™ pode:</p>
                    <div class="quick-actions">
                        <button class="quick-action" data-action="solicitar-orcamento">üí∞ Solicitar Or√ßamento</button>
                        <button class="quick-action" onclick="openWhatsApp('Ol√°, preciso de ajuda com o Hotel Granja Brasil')">
                            üí¨ WhatsApp
                        </button>
                    </div>
                `);
            } finally {
                input.disabled = false;
                sendButton.disabled = false;
                input.focus();
                
                isSendingMessage = false;
            }
        }

        async function processUserMessage(message) {
            const lowerMessage = message.toLowerCase();

            if (lowerMessage.includes('or√ßamento') || lowerMessage.includes('pre√ßo') || lowerMessage.includes('valor') || lowerMessage.includes('tarifa')) {
                return generateQuoteForm();
            }

            if (lowerMessage.includes('localiza√ß√£o') || lowerMessage.includes('endere√ßo') || lowerMessage.includes('onde fica')) {
                return `
                    <p><strong>üìç Localiza√ß√£o Privilegiada</strong></p>
                    <p><strong>${HOTEL_CONFIG.localizacao}</strong></p>
                    <p>üç¥ <strong>Proximidade aos melhores restaurantes da regi√£o</strong> - ideal para quem busca tranquilidade sem abrir m√£o do f√°cil acesso √† gastronomia local.</p>
                    <p>üöó <strong>Estacionamento Gratuito:</strong> Coberto (mediante disponibilidade) ou descoberto.</p>
                    <div class="quick-actions">
                        <button class="quick-action" data-action="solicitar-orcamento">üí∞ Solicitar Or√ßamento</button>
                    </div>
                `;
            }

            if (lowerMessage.includes('servi√ßo') || lowerMessage.includes('facilidade') || lowerMessage.includes('comodidade') || lowerMessage.includes('lazer')) {
                return `
                    <p><strong>üåü Lazer para Todos os Perfis</strong></p>
                    <p>Desfrute de nossa infraestrutura exclusiva:</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        ${HOTEL_CONFIG.servicos.map(servico => `<li>‚úÖ ${servico}</li>`).join('')}
                    </ul>
                    <p><strong>‚è∞ Hor√°rio da Piscina:</strong> ${HOTEL_CONFIG.horarios.piscina}</p>
                    <div class="quick-actions">
                        <button class="quick-action" data-action="solicitar-orcamento">üí∞ Fazer Or√ßamento</button>
                    </div>
                `;
            }

            if (lowerMessage.includes('contato') || lowerMessage.includes('telefone') || lowerMessage.includes('whatsapp')) {
                return `
                    <p><strong>üìû Entre em Contato</strong></p>
                    <p>WhatsApp: <strong>${HOTEL_CONFIG.whatsappNumber}</strong></p>
                    <p><strong>‚è∞ Hor√°rios de Atendimento:</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Recep√ß√£o:</strong> ${HOTEL_CONFIG.horarios.recepcao}</li>
                        <li><strong>Governan√ßa:</strong> ${HOTEL_CONFIG.horarios.governanca}</li>
                    </ul>
                    <button id="initialWhatsappBtn" class="whatsapp-button">
                        üí¨ Chamar no WhatsApp
                    </button>
                `;
            }

            if (lowerMessage.includes('pol√≠tica') || lowerMessage.includes('regra') || lowerMessage.includes('cancelamento') || lowerMessage.includes('crian√ßa')) {
                return `
                    <p><strong>üìã Pol√≠ticas do Hotel</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>‚úÖ <strong>Cancelamento:</strong> ${HOTEL_CONFIG.politicas.cancelamento}</li>
                        <li>üë∂ <strong>Crian√ßas:</strong> ${HOTEL_CONFIG.politicas.criancas}</li>
                        <li>üë• <strong>H√≥spedes Extras:</strong> ${HOTEL_CONFIG.politicas.hospedeExtra}</li>
                        <li>üö≠ <strong>Ambiente:</strong> ${HOTEL_CONFIG.politicas.fumante}</li>
                        <li>üêï <strong>Animais:</strong> ${HOTEL_CONFIG.politicas.animais}</li>
                        <li>üìã <strong>Atestado M√©dico:</strong> ${HOTEL_CONFIG.politicas.atestatMedico}</li>
                    </ul>
                    <div class="quick-actions">
                        <button class="quick-action" data-action="solicitar-orcamento">üí∞ Fazer Or√ßamento</button>
                    </div>
                `;
            }

            if (lowerMessage.includes('hor√°rio') || lowerMessage.includes('check') || lowerMessage.includes('piscina')) {
                return `
                    <p><strong>‚è∞ Hor√°rios de Funcionamento</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Check-in:</strong> ${HOTEL_CONFIG.horarios.checkin}</li>
                        <li><strong>Check-out:</strong> ${HOTEL_CONFIG.horarios.checkout}</li>
                        <li><strong>Recep√ß√£o:</strong> ${HOTEL_CONFIG.horarios.recepcao}</li>
                        <li><strong>Governan√ßa:</strong> ${HOTEL_CONFIG.horarios.governanca}</li>
                        <li><strong>Piscina:</strong> ${HOTEL_CONFIG.horarios.piscina}</li>
                    </ul>
                    <div class="quick-actions">
                        <button class="quick-action" data-action="solicitar-orcamento">üí∞ Solicitar Or√ßamento</button>
                    </div>
                `;
            }

            if (lowerMessage.includes('informa√ß√£o') || lowerMessage.includes('sobre') || lowerMessage.includes('hotel')) {
                return `
                    <div style="background: #f8f9fa; border-radius: 8px; overflow: hidden; margin: 15px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="background: #075e54; color: white; padding: 12px 15px;">
                            <h3 style="margin: 0; font-size: 18px;">üè® Nossas Acomoda√ß√µes</h3>
                        </div>

                        <div style="padding: 15px;">
                            <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <div style="background: #128c7e; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                                        üõèÔ∏è
                                    </div>
                                    <h4 style="margin: 0; color: #075e54;">Apartamento Superior</h4>
                                    <button class="video-button" onclick="openVideoModal('Apartamento Superior.mp4')">‚ñ∂ ver v√≠deo</button>
                                </div>

                                <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                    <div style="flex: 1; min-width: 200px;">
                                        <p style="margin: 5px 0; color: #555;"><strong>üë• Capacidade:</strong> At√© 2 pessoas</p>
                                        <p style="margin: 5px 0; color: #555;"><strong>üìè √Årea:</strong> 26 m¬≤</p>
                                        <p style="margin: 5px 0; color: #555;"><strong>üõå Camas:</strong> 2 camas separadas (padr√£o vi√∫va)</p>
                                    </div>

                                    <div style="flex: 1; min-width: 200px;">
                                        <p style="margin: 5px 0; color: #555;"><strong>üåü Destaques:</strong></p>
                                        <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                            <li>Ideal para solteiros</li>
                                            <li>Mesa de trabalho</li>
                                        </ul>
                                    </div>

                                    <div style="flex: 1; min-width: 200px;">
                                        <p style="margin: 5px 0; color: #555;"><strong>üõÅ Comodidades:</strong></p>
                                        <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                            <li>Ar-condicionado</li>
                                            <li>Frigobar</li>
                                            <li>Secador de cabelos</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <div style="background: #128c7e; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                                        üõãÔ∏è
                                    </div>
                                    <h4 style="margin: 0; color: #075e54;">Su√≠te S√™nior</h4>
                                    <button class="video-button" onclick="openVideoModal('Su√≠te S√™nior.mp4')">‚ñ∂ ver v√≠deo</button>
                                </div>

                                <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                    <div style="flex: 1; min-width: 200px;">
                                        <p style="margin: 5px 0; color: #555;"><strong>üë• Capacidade:</strong> At√© 3 pessoas</p>
                                        <p style="margin: 5px 0; color: #555;"><strong>üìè √Årea:</strong> 41 m¬≤</p>
                                        <p style="margin: 5px 0; color: #555;"><strong>üõå Camas:</strong> 1 cama King Size + sof√°-cama</p>
                                    </div>

                                    <div style="flex: 1; min-width: 200px;">
                                        <p style="margin: 5px 0; color: #555;"><strong>üåü Destaques:</strong></p>
                                        <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                            <li>Conforto ampliado</li>
                                            <li>Sala com sof√°-cama</li>
                                            <li>Mesa de trabalho</li>
                                        </ul>
                                    </div>

                                    <div style="flex: 1; min-width: 200px;">
                                        <p style="margin: 5px 0; color: #555;"><strong>üõÅ Comodidades:</strong></p>
                                        <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                            <li>Ar-condicionado</li>
                                            <li>Frigobar</li>
                                            <li>Microondas</li>
                                            <li>Pia</li>
                                            <li>Sacada</li>
                                            <li>Secador de cabelos</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <div style="background: #128c7e; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                                        üåü
                                    </div>
                                    <h4 style="margin: 0; color: #075e54;">Su√≠te Master (Cobertura)</h4>
                                    <button class="video-button" onclick="openVideoModal('Su√≠te M√°ster.mp4')">‚ñ∂ ver v√≠deo</button>
                                </div>

                                <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                    <div style="flex: 1; min-width: 200px;">
                                        <p style="margin: 5px 0; color: #555;"><strong>üë• Capacidade:</strong> At√© 3 pessoas</p>
                                        <p style="margin: 5px 0; color: #555;"><strong>üìè √Årea:</strong> 56 m¬≤</p>
                                        <p style="margin: 5px 0; color: #555;"><strong>üõå Camas:</strong> 1 cama King Size + sof√°-cama</p>
                                    </div>

                                    <div style="flex: 1; min-width: 200px;">
                                        <p style="margin: 5px 0; color: #555;"><strong>üåü Destaques:</strong></p>
                                        <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                            <li>Vista privilegiada</li>
                                            <li>Varanda espa√ßosa</li>
                                            <li>Mesa de trabalho</li>
                                        </ul>
                                    </div>

                                    <div style="flex: 1; min-width: 200px;">
                                        <p style="margin: 5px 0; color: #555;"><strong>üõÅ Comodidades:</strong></p>
                                        <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                            <li>Ar-condicionado</li>
                                            <li>Frigobar</li>
                                            <li>Microondas</li>
                                            <li>Pia</li>
                                            <li>Varanda</li>
                                            <li>Secador de cabelos</li>
                                        </ul>
                                        <p style="margin: 5px 0; color: #555;"><strong>‚ö†Ô∏è Observa√ß√£o:</strong> Acesso por escada (15 degraus)</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="background: #f0f8ff; padding: 12px 15px; border-top: 1px solid #e0e0e0;">
                            <div class="quick-actions">
                                <button class="quick-action" data-action="solicitar-orcamento" style="background: #075e54; color: white;">
                                    üí∞ Solicitar Or√ßamento
                                </button>
                                <button class="quick-action" data-action="politicas">
                                    üìã Ver Pol√≠ticas
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            showTyping();
            try {
                const aiResponse = await callHotelAI(message);
                hideTyping();
                
                await addMessageWithHumanTyping(aiResponse);
                return aiResponse;
            } catch (error) {
                hideTyping();
                return `
                    <p>Entendi! Estou aqui para ajud√°-lo com informa√ß√µes sobre o Hotel Granja Brasil.</p>
                    <p>Posso ajud√°-lo com:</p>
                    <div class="quick-actions">
                        <button class="quick-action" data-action="solicitar-orcamento">üí∞ Or√ßamento</button>
                        <button class="quick-action" data-action="informacoes-hotel">üè® Informa√ß√µes</button>
                        <button class="quick-action" data-action="contato">üìû Contato</button>
                    </div>
                `;
            }
        }

        async function handleQuickAction(action) {
            if (isProcessingQuickAction) return;
            isProcessingQuickAction = true;

            let response = '';

            try {
                showTyping();

                switch(action) {
                    case 'solicitar-orcamento':
                        if (currentQuoteData || selectedRooms.length > 0) {
                            location.reload();
                            return;
                        }
                        response = generateQuoteForm();
                        break;
                    case 'informacoes-hotel':
                        response = `
                            <div style="background: #f8f9fa; border-radius: 8px; overflow: hidden; margin: 15px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <div style="background: #075e54; color: white; padding: 12px 15px;">
                                    <h3 style="margin: 0; font-size: 18px;">üè® Hotel Granja Brasil</h3>
                                </div>

                                <div style="padding: 15px;">
                                    <p><em>Descubra Conforto, Lazer e Sofistica√ß√£o no Cora√ß√£o de Itaipava</em></p>

                                    <hr style="border: 0; height: 1px; background: #eee; margin: 15px 0;">

                                    <p><strong>üìç Localiza√ß√£o:</strong> ${HOTEL_CONFIG.localizacao}</p>

                                    <hr style="border: 0; height: 1px; background: #eee; margin: 15px 0;">

                                    <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                            <div style="background: #128c7e; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                                                üõèÔ∏è
                                            </div>
                                            <h4 style="margin: 0; color: #075e54;">Apartamento Superior</h4>
                                            <button class="video-button" onclick="openVideoModal('Apartamento Superior.mp4')">‚ñ∂ ver v√≠deo</button>
                                        </div>

                                        <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                            <div style="flex: 1; min-width: 200px;">
                                                <p style="margin: 5px 0; color: #555;"><strong>üë• Capacidade:</strong> At√© 2 pessoas</p>
                                                <p style="margin: 5px 0; color: #555;"><strong>üìè √Årea:</strong> 26 m¬≤</p>
                                                <p style="margin: 5px 0; color: #555;"><strong>üõå Camas:</strong> 2 camas separadas (padr√£o vi√∫va)</p>
                                            </div>

                                            <div style="flex: 1; min-width: 200px;">
                                                <p style="margin: 5px 0; color: #555;"><strong>üåü Destaques:</strong></p>
                                                <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                                    <li>Ideal para solteiros</li>
                                                    <li>Mesa de trabalho</li>
                                                </ul>
                                            </div>

                                            <div style="flex: 1; min-width: 200px;">
                                                <p style="margin: 5px 0; color: #555;"><strong>üõÅ Comodidades:</strong></p>
                                                <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                                    <li>Ar-condicionado</li>
                                                    <li>Frigobar</li>
                                                    <li>Secador de cabelos</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                            <div style="background: #128c7e; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                                                üõãÔ∏è
                                            </div>
                                            <h4 style="margin: 0; color: #075e54;">Su√≠te S√™nior</h4>
                                            <button class="video-button" onclick="openVideoModal('Su√≠te S√™nior.mp4')">‚ñ∂ ver v√≠deo</button>
                                        </div>

                                        <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                            <div style="flex: 1; min-width: 200px;">
                                                <p style="margin: 5px 0; color: #555;"><strong>üë• Capacidade:</strong> At√© 3 pessoas</p>
                                                <p style="margin: 5px 0; color: #555;"><strong>üìè √Årea:</strong> 41 m¬≤</p>
                                                <p style="margin: 5px 0; color: #555;"><strong>üõå Camas:</strong> 1 cama King Size + sof√°-cama</p>
                                            </div>

                                            <div style="flex: 1; min-width: 200px;">
                                                <p style="margin: 5px 0; color: #555;"><strong>üåü Destaques:</strong></p>
                                                <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                                    <li>Conforto ampliado</li>
                                                    <li>Sala com sof√°-cama</li>
                                                    <li>Mesa de trabalho</li>
                                                </ul>
                                            </div>

                                            <div style="flex: 1; min-width: 200px;">
                                                <p style="margin: 5px 0; color: #555;"><strong>üõÅ Comodidades:</strong></p>
                                                <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                                    <li>Ar-condicionado</li>
                                                    <li>Frigobar</li>
                                                    <li>Microondas</li>
                                                    <li>Pia</li>
                                                    <li>Sacada</li>
                                                    <li>Secador de cabelos</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <div style="margin-bottom: 10px;">
                                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                            <div style="background: #128c7e; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0;">
                                                üåü
                                            </div>
                                            <h4 style="margin: 0; color: #075e54;">Su√≠te Master (Cobertura)</h4>
                                            <button class="video-button" onclick="openVideoModal('Su√≠te M√°ster.mp4')">‚ñ∂ ver v√≠deo</button>
                                        </div>

                                        <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                            <div style="flex: 1; min-width: 200px;">
                                                <p style="margin: 5px 0; color: #555;"><strong>üë• Capacidade:</strong> At√© 3 pessoas</p>
                                                <p style="margin: 5px 0; color: #555;"><strong>üìè √Årea:</strong> 56 m¬≤</p>
                                                <p style="margin: 5px 0; color: #555;"><strong>üõå Camas:</strong> 1 cama King Size + sof√°-cama</p>
                                            </div>

                                            <div style="flex: 1; min-width: 200px;">
                                                <p style="margin: 5px 0; color: #555;"><strong>üåü Destaques:</strong></p>
                                                <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                                    <li>Vista privilegiada</li>
                                                    <li>Varanda espa√ßosa</li>
                                                    <li>Mesa de trabalho</li>
                                                </ul>
                                            </div>

                                            <div style="flex: 1; min-width: 200px;">
                                                <p style="margin: 5px 0; color: #555;"><strong>üõÅ Comodidades:</strong></p>
                                                <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                                                    <li>Ar-condicionado</li>
                                                    <li>Frigobar</li>
                                                    <li>Microondas</li>
                                                    <li>Pia</li>
                                                    <li>Varanda</li>
                                                    <li>Secador de cabelos</li>
                                                </ul>
                                                <p style="margin: 5px 0; color: #555;"><strong>‚ö†Ô∏è Observa√ß√£o:</strong> Acesso por escada (15 degraus)</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div style="background: #f0f8ff; padding: 12px 15px; border-top: 1px solid #e0e0e0;">
                                    <div class="quick-actions">
                                        <button class="quick-action" data-action="servicos">üåü Servi√ßos</button>
                                        <button class="quick-action" data-action="politicas">üìã Pol√≠ticas</button>
                                        <button class="quick-action" data-action="solicitar-orcamento">üí∞ Or√ßamento</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        break;
                    case 'servicos':
                        response = `
                            <p><strong>üåü Lazer e Servi√ßos</strong></p>
                            <p>Desfrute de nossa infraestrutura exclusiva:</p>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                ${HOTEL_CONFIG.servicos.map(servico => `<li>‚úÖ ${servico}</li>`).join('')}
                            </ul>

                            <p><strong>‚è∞ Hor√°rio da Piscina:</strong> ${HOTEL_CONFIG.horarios.piscina}</p>

                            <div class="quick-actions">
                                <button class="quick-action" data-action="informacoes-hotel">üè® Sobre o Hotel</button>
                                <button class="quick-action" data-action="solicitar-orcamento">üí∞ Fazer Or√ßamento</button>
                            </div>
                        `;
                        break;
                    case 'politicas':
                        response = `
                            <p><strong>üìã Pol√≠ticas do Hotel</strong></p>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>‚úÖ <strong>Check-in:</strong> ${HOTEL_CONFIG.horarios.checkin}</li>
                                <li>‚úÖ <strong>Check-out:</strong> ${HOTEL_CONFIG.horarios.checkout}</li>
                                <li>‚úÖ <strong>Cancelamento:</strong> ${HOTEL_CONFIG.politicas.cancelamento}</li>
                                <li>üë∂ <strong>Crian√ßas:</strong> ${HOTEL_CONFIG.politicas.criancas}</li>
                                <li>üë• <strong>H√≥spedes Extras:</strong> ${HOTEL_CONFIG.politicas.hospedeExtra}</li>
                                <li>üö≠ <strong>Ambiente:</strong> ${HOTEL_CONFIG.politicas.fumante}</li>
                                <li>üêï <strong>Animais:</strong> ${HOTEL_CONFIG.politicas.animais}</li>
                                <li>üìã <strong>Atestado M√©dico:</strong> ${HOTEL_CONFIG.politicas.atestatMedico}</li>
                            </ul>

                            <div class="quick-actions">
                                <button class="quick-action" data-action="solicitar-orcamento">üí∞ Fazer Or√ßamento</button>
                            </div>
                        `;
                        break;
                    case 'localizacao':
                        response = `
                            <p><strong>üìç Localiza√ß√£o Privilegiada</strong></p>
                            <p>
                                <strong>${HOTEL_CONFIG.localizacao}</strong><br>
                                <a href="https://maps.google.com/?daddr=Hotel%20Granja%20Brasil%20Resort" 
                                   target="_blank" 
                                   style="color: #075e54; text-decoration: none; font-weight: bold; padding: 4px 8px; border-radius: 4px; background: #f0f8ff; display: inline-block; margin-top: 5px; transition: all 0.2s;"
                                   onmouseover="this.style.background='#e1f5fe'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'"
                                   onmouseout="this.style.background='#f0f8ff'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                    üó∫Ô∏è Ver no Google Maps
                                </a>
                            </p>
                            <p>üç¥ <strong>Proximidade aos melhores restaurantes da regi√£o</strong></p>
                            <p>üöó <strong>Estacionamento Gratuito:</strong> Coberto (mediante disponibilidade) ou descoberto.</p>
                            
                            <div style="background: #e8f4fd; padding: 12px; border-radius: 8px; margin: 12px 0; font-size: 14px;">
                                <p><strong>üìç Como chegar:</strong></p>
                                <ul style="margin: 8px 0; padding-left: 20px;">
                                    <li><strong>De Petr√≥polis:</strong> 20 minutos pela Estrada Uni√£o e Ind√∫stria</li>
                                    <li><strong>Do Rio de Janeiro:</strong> 1h30 pela BR-040</li>
                                    <li><strong>De Teres√≥polis:</strong> 40 minutos pela BR-116 e BR-040</li>
                                </ul>
                            </div>
                            
                            <div class="quick-actions">
                                <button class="quick-action" data-action="solicitar-orcamento">üí∞ Solicitar Or√ßamento</button>
                                <button class="quick-action" data-action="informacoes-hotel">üè® Sobre o Hotel</button>
                            </div>
                        `;
                        break;
                    case 'contato':
                        response = `
                            <p><strong>üìû Entre em Contato</strong></p>
                            <p>WhatsApp: <strong>${HOTEL_CONFIG.whatsappNumber}</strong></p>
                            <p>E-mail Corporativo: <strong>${HOTEL_CONFIG.emailCorporativo}</strong></p>

                            <p><strong>‚è∞ Hor√°rios de Atendimento:</strong></p>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li><strong>Recep√ß√£o:</strong> ${HOTEL_CONFIG.horarios.recepcao}</li>
                                <li><strong>Governan√ßa:</strong> ${HOTEL_CONFIG.horarios.governanca}</li>
                            </ul>

                            <button id="initialWhatsappBtn" class="whatsapp-button">
                                üí¨ Chamar no WhatsApp
                            </button>
                        `;
                        break;
                }

                if (response) {
                    await delay(800);
                    hideTyping();
                    
                    await addMessageWithHumanTyping(response);
                    isProcessingQuickAction = false;
                } else {
                    hideTyping();
                    isProcessingQuickAction = false;
                }
            } catch (error) {
                console.error('Erro ao processar a√ß√£o r√°pida:', error);
                hideTyping();
                isProcessingQuickAction = false;
            }
        }

        function setupButtonListeners() {
            const sendButton = document.getElementById('sendButton');
            const messageInput = document.getElementById('messageInput');

            if (sendButton) {
                sendButton.removeEventListener('click', sendMessage);
                sendButton.addEventListener('click', sendMessage);
            }

            const checkAvailabilityBtn = document.getElementById('checkAvailabilityBtn');
            if (checkAvailabilityBtn) {
                checkAvailabilityBtn.removeEventListener('click', checkAvailability);
                checkAvailabilityBtn.addEventListener('click', checkAvailability);
            }

            const whatsappBtn = document.getElementById('whatsappBtn');
            if (whatsappBtn) {
                whatsappBtn.removeEventListener('click', sendQuoteToWhatsApp);
                whatsappBtn.addEventListener('click', sendQuoteToWhatsApp);
            }

            const initialWhatsappBtn = document.getElementById('initialWhatsappBtn');
            if (initialWhatsappBtn) {
                initialWhatsappBtn.removeEventListener('click', initialWhatsappClick);
                
                function initialWhatsappClick() {
                    const message = "Ol√°, vim do assistente virtual e gostaria de ter informa√ß√µes a respeito de reservas.";
                    openWhatsApp(message);
                }

                initialWhatsappBtn.addEventListener('click', initialWhatsappClick);
            }

            const corporateBtn = document.getElementById('corporateBtn');
            if (corporateBtn) {
                corporateBtn.removeEventListener('click', sendCorporateEmail);
                corporateBtn.addEventListener('click', sendCorporateEmail);
            }

            const quickActions = document.querySelectorAll('.quick-action');
            quickActions.forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);

                newButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    const action = this.getAttribute('data-action');
                    handleQuickAction(action);
                });
            });

            if (messageInput) {
                messageInput.removeEventListener('keypress', handleEnterKey);
                
                function handleEnterKey(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                }
                
                messageInput.addEventListener('keypress', handleEnterKey);
            }
        }

        // Fun√ß√£o aprimorada para abrir v√≠deo em tela cheia automaticamente
        function openVideoModal(videoFileName) {
            const modal = document.getElementById('videoModal');
            const video = document.getElementById('modalVideo');
            
            const videoPath = encodeURI(videoFileName); 
            
            const source = video.querySelector('source');
            source.src = videoPath;
            video.load();
            
            modal.style.display = 'block';
            
            // Configurar evento para quando o v√≠deo estiver pronto
            video.onloadeddata = function() {
                // Tenta reproduzir automaticamente
                video.play()
                    .then(() => {
                        console.log('V√≠deo reproduzindo automaticamente');
                        
                        // Entrar em tela cheia automaticamente
                        try {
                            if (video.requestFullscreen) {
                                video.requestFullscreen();
                            } else if (video.webkitRequestFullscreen) { // Safari
                                video.webkitRequestFullscreen();
                            } else if (video.msRequestFullscreen) { // IE/Edge
                                video.msRequestFullscreen();
                            } else if (video.mozRequestFullScreen) { // Firefox
                                video.mozRequestFullScreen();
                            } else {
                                console.log('Tela cheia n√£o suportada neste navegador');
                                
                                // Fallback para navegadores sem suporte a fullscreen
                                const fallbackMsg = document.createElement('div');
                                fallbackMsg.style.position = 'absolute';
                                fallbackMsg.style.bottom = '10px';
                                fallbackMsg.style.left = '50%';
                                fallbackMsg.style.transform = 'translateX(-50%)';
                                fallbackMsg.style.background = 'rgba(0,0,0,0.7)';
                                fallbackMsg.style.color = 'white';
                                fallbackMsg.style.padding = '8px 16px';
                                fallbackMsg.style.borderRadius = '20px';
                                fallbackMsg.style.fontSize = '14px';
                                fallbackMsg.style.zIndex = '1002';
                                fallbackMsg.innerHTML = '‚ñ∂Ô∏è Clique no √≠cone de tela cheia para expandir';
                                
                                document.querySelector('.modal-content').appendChild(fallbackMsg);
                                
                                setTimeout(() => {
                                    if (fallbackMsg.parentNode) {
                                        fallbackMsg.parentNode.removeChild(fallbackMsg);
                                    }
                                }, 3000);
                            }
                        } catch (fullscreenError) {
                            console.log('Erro ao entrar em tela cheia:', fullscreenError);
                        }
                    })
                    .catch(error => {
                        console.log('Reprodu√ß√£o autom√°tica bloqueada pelo navegador:', error);
                        
                        // Mensagem amig√°vel para reprodu√ß√£o manual
                        const playMsg = document.createElement('div');
                        playMsg.style.position = 'absolute';
                        playMsg.style.bottom = '10px';
                        playMsg.style.left = '50%';
                        playMsg.style.transform = 'translateX(-50%)';
                        playMsg.style.background = 'rgba(0,0,0,0.7)';
                        playMsg.style.color = 'white';
                        playMsg.style.padding = '8px 16px';
                        playMsg.style.borderRadius = '20px';
                        playMsg.style.fontSize = '14px';
                        playMsg.style.zIndex = '1002';
                        playMsg.style.cursor = 'pointer';
                        playMsg.innerHTML = '‚ñ∂Ô∏è Clique aqui para reproduzir em tela cheia';
                        
                        // Adicionar evento de clique para reproduzir e entrar em tela cheia
                        playMsg.addEventListener('click', function() {
                            video.play();
                            if (video.requestFullscreen) {
                                video.requestFullscreen();
                            }
                            this.remove();
                        });
                        
                        document.querySelector('.modal-content').appendChild(playMsg);
                    });
            };
            
            // Garantir que ao sair da tela cheia, o modal ainda funcione
            video.addEventListener('fullscreenchange', function() {
                if (!document.fullscreenElement && !document.webkitFullscreenElement && 
                    !document.msFullscreenElement && !document.mozFullScreenElement) {
                    console.log('Saiu do modo tela cheia');
                }
            });
            
            video.addEventListener('webkitfullscreenchange', function() {
                if (!document.webkitFullscreenElement) {
                    console.log('Saiu do modo tela cheia (Safari)');
                }
            });
        }

        // Melhorar a fun√ß√£o de fechar modal para garantir que saia da tela cheia
        function closeVideoModal() {
            const modal = document.getElementById('videoModal');
            const video = document.getElementById('modalVideo');
            
            // Sair da tela cheia se estiver nela
            if (document.fullscreenElement || document.webkitFullscreenElement || 
                document.msFullscreenElement || document.mozFullScreenElement) {
                
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                }
            }
            
            if (video) {
                video.pause();
                video.currentTime = 0;
            }
            
            modal.style.display = 'none';
            
            // Pequeno delay para garantir que tudo resetou
            setTimeout(() => {
                fixVideoButtonLayout();
            }, 100);
        }

        window.onclick = function(event) {
            const modal = document.getElementById('videoModal');
            if (event.target == modal) {
                closeVideoModal();
            }
        }

        function startAvailabilityRefresh() {
            setInterval(() => {
                if (currentAvailabilityData && selectedRooms.length > 0) {
                    const startDate = document.getElementById('checkinDate');
                    const endDate = document.getElementById('checkoutDate');
                    
                    if (startDate && endDate && startDate.value && endDate.value) {
                        const formattedStartDate = formatDateToDDMMAAAA(startDate.value);
                        const formattedEndDate = formatDateToDDMMAAAA(endDate.value);

                        fetchAvailability(formattedStartDate, formattedEndDate)
                            .then(newData => {
                                currentAvailabilityData = newData;
                                updateRoomOptions();

                                availabilityHistory.push({
                                    timestamp: new Date(),
                                    action: 'Atualiza√ß√£o peri√≥dica de disponibilidade',
                                    data: JSON.parse(JSON.stringify(newData))
                                });
                            })
                            .catch(error => {
                                console.error('Erro ao atualizar disponibilidade:', error);
                            });
                    }
                }
            }, 300000);
        }

        function fixVideoButtonLayout() {
            const roomContainers = document.querySelectorAll('#roomsContainer > div');
            
            roomContainers.forEach(container => {
                if (!container.querySelector('input[type="checkbox"]')) return;
                
                container.style.cssText = `
                    display: flex !important;
                    align-items: flex-start !important;
                    gap: 10px !important;
                    padding: 12px 10px !important;
                    border-bottom: 1px solid #f0f0f0 !important;
                `;
                
                const contentCol = container.children[1];
                if (contentCol) {
                    contentCol.style.cssText = `
                        flex: 1 !important;
                        display: flex !important;
                        flex-direction: column !important;
                        gap: 4px !important;
                    `;
                    
                    const bottomRow = contentCol.children[1];
                    if (bottomRow) {
                        bottomRow.style.cssText = `
                            display: flex !important;
                            flex-wrap: wrap !important;
                            align-items: center !important;
                            justify-content: space-between !important;
                            gap: 8px !important;
                            margin-top: 2px !important;
                        `;
                        
                        const priceContainer = bottomRow.children[0];
                        if (priceContainer) {
                            priceContainer.style.cssText = `
                                flex: 0 1 auto !important;
                            `;
                            
                            const priceSpan = priceContainer.querySelector('span');
                            if (priceSpan) {
                                priceSpan.style.cssText = `
                                    font-weight: 600 !important;
                                    color: #075e54 !important;
                                    font-size: 14px !important;
                                    background-color: #e8f5e9 !important;
                                    padding: 2px 8px !important;
                                    border-radius: 12px !important;
                                    display: inline-block !important;
                                    white-space: nowrap !important;
                                `;
                            }
                        }
                        
                        const videoContainer = bottomRow.children[1];
                        if (videoContainer) {
                            videoContainer.style.cssText = `
                                flex: 0 1 auto !important;
                            `;
                            
                            const videoBtn = videoContainer.querySelector('button');
                            if (videoBtn) {
                                videoBtn.style.cssText = `
                                    background-color: #e6f3f0 !important;
                                    border: none !important;
                                    border-radius: 20px !important;
                                    padding: 6px 14px !important;
                                    font-size: 13px !important;
                                    font-weight: 500 !important;
                                    color: #075e54 !important;
                                    cursor: pointer !important;
                                    transition: background-color 0.2s !important;
                                    white-space: nowrap !important;
                                    display: inline-flex !important;
                                    align-items: center !important;
                                    gap: 4px !important;
                                `;
                            }
                        }
                    }
                }
                
                if (window.innerWidth <= 480) {
                    const bottomRow = container.querySelector('div:nth-child(2) > div:nth-child(2)');
                    if (bottomRow) {
                        bottomRow.style.flexDirection = 'column';
                        bottomRow.style.alignItems = 'flex-start';
                        
                        const videoContainer = bottomRow.querySelector('div:last-child');
                        if (videoContainer) {
                            videoContainer.style.width = '100%';
                            
                            const videoBtn = videoContainer.querySelector('button');
                            if (videoBtn) {
                                videoBtn.style.width = '100%';
                                videoBtn.style.justifyContent = 'center';
                            }
                        }
                    }
                }
            });
        }

        const originalCloseVideoModal = window.closeVideoModal;
        window.closeVideoModal = function() {
            if (originalCloseVideoModal) {
                originalCloseVideoModal();
            }
            
            setTimeout(fixVideoButtonLayout, 10);
            setTimeout(fixVideoButtonLayout, 50);
            setTimeout(fixVideoButtonLayout, 100);
            setTimeout(fixVideoButtonLayout, 200);
        };

        const observer = new MutationObserver(function(mutations) {
            let shouldFix = false;
            
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    const target = mutation.target;
                    if (target.id !== 'roomsContainer' && 
                        target.querySelector && 
                        target.querySelector('input[type="checkbox"]')) {
                        shouldFix = true;
                    }
                }
                
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    shouldFix = true;
                }
            });
            
            if (shouldFix) {
                setTimeout(fixVideoButtonLayout, 10);
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const roomsContainer = document.getElementById('roomsContainer');
            if (roomsContainer) {
                observer.observe(roomsContainer, { 
                    childList: true, 
                    subtree: true,
                    attributes: true,
                    attributeFilter: ['style']
                });
            }
            
            setTimeout(fixVideoButtonLayout, 500);
            
            document.addEventListener('click', function() {
                setTimeout(fixVideoButtonLayout, 10);
            });
            
            document.addEventListener('mouseup', function() {
                setTimeout(fixVideoButtonLayout, 10);
            });
            
            window.addEventListener('resize', function() {
                setTimeout(fixVideoButtonLayout, 10);
            });
            
            console.log('‚úÖ Corre√ß√£o definitiva do layout aplicada!');
        });

        document.addEventListener('DOMContentLoaded', function() {
            setupButtonListeners();
            const messageInput = document.getElementById('messageInput');
            if (messageInput) messageInput.focus();
            startAvailabilityRefresh();
            
            console.log('Hotel Granja Brasil Assistente inicializado');
            console.log('Endpoint IA: https://intrega-ia.paulo-migueoli.workers.dev/');
        });
    </script>
</body>
</html>
